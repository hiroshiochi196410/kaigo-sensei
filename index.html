<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>介護ロールプレイAI（例文復活：カテゴリ×Persona/Scene×ローマ字）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 12px; }
    label { display:flex; gap:6px; align-items:center; font-size: 14px; }
    select, textarea, button, input { font-size: 15px; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    button.primary { border-color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    textarea { width:100%; min-height:110px; padding:10px; border-radius: 12px; border:1px solid #ddd; }
    .muted { color:#666; font-size:13px; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#333; }
    .card { border:1px solid #e1e1e1; border-radius:14px; padding:12px; margin-top:12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    pre { white-space: pre-wrap; word-break: break-word; margin:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sep { height:1px; background:#eee; margin:10px 0; }
    .hint { font-size: 12px; color:#777; }
  </style>
</head>
<body>
  <h1>介護ロールプレイAI <span class="badge">例文復活</span> <span class="badge">カテゴリ</span> <span class="badge">Persona/Scene</span> <span class="badge">介護士ローマ字</span></h1>
  <div class="muted">①例文投入（押すたび切替）→ ②介護士発話ローマ字 → ③Stage1 → ④Stage2（推奨返答のローマ字＋インドネシア語）</div>

  <div class="row">
    <label>Scene
      <select id="scene"></select>
    </label>

    <label>Persona
      <select id="persona"></select>
    </label>

    <label>カテゴリ
      <select id="category"></select>
    </label>

    <button id="fillExample" type="button">例文を入れる</button>

    <label class="muted" style="gap:8px;">
      <input id="autoStage2" type="checkbox" checked />
      Stage2を自動実行
    </label>

    <span id="status" class="muted"></span>
  </div>

  <div>
    <div class="muted">介護士（あなた）の発話（日本語）</div>
    <textarea id="prompt" placeholder="例文ボタンで自動入力、または自由入力"></textarea>
    <div class="hint">※ examples.json がある場合：scene×persona×カテゴリの例文が出ます（押すたび切替）</div>
  </div>

  <div class="card">
    <div><b>介護士発話（ローマ字）</b></div>
    <pre id="caregiverRomaji" class="mono"></pre>
  </div>

  <div class="row">
    <button id="send" class="primary" type="button">送信</button>
    <button id="runStage2" type="button">Stage2だけ実行</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="muted">Stage1（日本語）</div>
      <div class="sep"></div>
      <div><b>相手（AI側）の返答</b></div>
      <pre id="aiReply" class="mono"></pre>
      <div class="sep"></div>
      <div><b>あなたへのフィードバック</b></div>
      <pre id="feedback" class="mono"></pre>
      <div class="sep"></div>
      <div><b>推奨返答（日本語）</b></div>
      <textarea id="suggestedJp" placeholder="Stage1実行後に入ります"></textarea>
    </div>

    <div class="card">
      <div class="muted">Stage2（翻訳：推奨返答）</div>
      <div class="sep"></div>
      <div><b>ローマ字（推奨返答）</b></div>
      <pre id="romaji" class="mono"></pre>
      <div class="sep"></div>
      <div><b>インドネシア語（推奨返答）</b></div>
      <pre id="indonesian" class="mono"></pre>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const setStatus = (m) => $("status").textContent = m || "";

  // --- Busy / Abort ---
  let busy = false;
  let inFlight = null; // AbortController

  const setBusy = (b) => {
    busy = b;
    $("fillExample").disabled = b;
    $("send").disabled = b;
    $("runStage2").disabled = b;
    $("scene").disabled = b;
    $("persona").disabled = b;
    $("category").disabled = b;
  };

  function abortInFlight(){
    if(inFlight){
      try { inFlight.abort(); } catch(_){}
      inFlight = null;
    }
  }

  async function postChat(payload, { timeoutMs = 15000 } = {}){
    abortInFlight();
    inFlight = new AbortController();

    const timer = setTimeout(() => inFlight?.abort(), timeoutMs);
    try{
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        signal: inFlight.signal
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok){
        const msg = j?.message || j?.error || (j?.details ? String(j.details) : "") || ("HTTP " + r.status);
        const e = new Error(msg);
        e.status = r.status;
        throw e;
      }
      return j;
    } finally {
      clearTimeout(timer);
    }
  }

  function meta(stage){
    return {
      stage,
      persona: $("persona").value || "user_calm",
      scene: $("scene").value || "bath"
    };
  }

  function clearOutputs(){
    $("caregiverRomaji").textContent = "";
    $("aiReply").textContent = "";
    $("feedback").textContent = "";
    $("suggestedJp").value = "";
    $("romaji").textContent = "";
    $("indonesian").textContent = "";
  }

  // -----------------------
  // Examples loader (robust)
  // -----------------------
  let EX = null;
  const counters = {}; // counters[scene][persona][cat] = next index

  function ensureCounter(scene, persona, cat){
    if(!counters[scene]) counters[scene] = {};
    if(!counters[scene][persona]) counters[scene][persona] = {};
    if(typeof counters[scene][persona][cat] !== "number") counters[scene][persona][cat] = 0;
  }

  function asOptionsFromArray(arr){
    // supports: ["bath", ...] or [{key,label}, ...] or [{value,label}, ...]
    return (arr || []).map(v=>{
      if(typeof v === "string") return { key: v, label: v };
      const key = v.key ?? v.value ?? v.id ?? "";
      const label = v.label ?? v.name ?? key;
      return { key, label };
    }).filter(o=>o.key);
  }

  function populateSelect(sel, options){
    sel.innerHTML = "";
    options.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o.key;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });
  }

  function inferStructure(db){
    // Try to find examples root:
    // - db.examples[scene][persona][category] = [string|{jp:""}...]
    // - db.data or db.dataset similarly
    const root = db.examples || db.data || db.dataset || db.items || null;
    return root;
  }

  function extractScenes(root){
    return Object.keys(root || {});
  }

  function extractPersonas(root, scene){
    return Object.keys((root && root[scene]) || {});
  }

  function extractCategories(root, scene, persona){
    return Object.keys((root && root[scene] && root[scene][persona]) || {});
  }

  function normalizeExampleItem(x){
    if(typeof x === "string") return { jp: x };
    if(x && typeof x === "object"){
      return { jp: x.jp || x.text || x.prompt || "" };
    }
    return { jp: "" };
  }

  function getExampleList(root, scene, persona, cat){
    const list = (root && root[scene] && root[scene][persona] && root[scene][persona][cat]) || [];
    return (Array.isArray(list) ? list : []).map(normalizeExampleItem).filter(it=>it.jp);
  }

  async function loadExamples(){
    if(EX) return EX;

    try{
      setStatus("examples.json 読み込み中…");
      const r = await fetch("/examples.json", { cache: "no-store" });
      if(!r.ok) throw new Error("examples.json not found");
      const db = await r.json();
      const root = inferStructure(db);

      if(!root){
        throw new Error("examples root not found (need examples/data/dataset)");
      }

      // Prefer explicit lists if present, else infer from root keys
      const sceneOptions =
        asOptionsFromArray(db.scenes) ||
        [];
      const scenes = sceneOptions.length ? sceneOptions.map(o=>o.key) : extractScenes(root);
      const sceneOptFinal = sceneOptions.length ? sceneOptions : scenes.map(s=>({key:s,label:s}));

      // personas list
      const personaOptions = asOptionsFromArray(db.personas);
      // if no personas list, infer from first scene
      let personas = personaOptions.length ? personaOptions.map(o=>o.key) : extractPersonas(root, scenes[0]);
      const personaOptFinal = personaOptions.length ? personaOptions : personas.map(p=>({key:p,label:p}));

      EX = { db, root, sceneOptFinal, personaOptFinal };
      populateSelect($("scene"), sceneOptFinal);
      populateSelect($("persona"), personaOptFinal);

      refreshCategories(); // based on current selection
      setStatus("examples.json OK");
      return EX;
    } catch(e){
      // No examples.json is OK; fallback to manual only
      EX = null;
      setStatus("例文なし（examples.json 未設定）");
      // Provide default Scene/Persona options anyway
      populateSelect($("scene"), [
        {key:"bath",label:"入浴"},
        {key:"meal",label:"食事"},
        {key:"toilet",label:"排泄"},
        {key:"night",label:"夜間"},
        {key:"complaint",label:"クレーム対応"}
      ]);
      populateSelect($("persona"), [
        {key:"user_calm",label:"利用者：穏やか"},
        {key:"user_angry",label:"利用者：怒り"},
        {key:"dementia",label:"利用者：少し混乱"},
        {key:"family_anxious",label:"家族：不安"},
        {key:"family_complaint",label:"家族：クレーム"}
      ]);
      populateSelect($("category"), [{key:"free",label:"自由入力"}]);
      return null;
    }
  }

  function refreshCategories(){
    if(!EX){
      populateSelect($("category"), [{key:"free",label:"自由入力"}]);
      return;
    }
    const { root } = EX;
    const scene = $("scene").value;
    const persona = $("persona").value;

    const cats = extractCategories(root, scene, persona);
    const catOptions = cats.length ? cats.map(c=>({key:c,label:c})) : [{key:"free",label:"自由入力"}];
    populateSelect($("category"), catOptions);
  }

  function getNextExample(){
    if(!EX) return null;

    const { root } = EX;
    const scene = $("scene").value;
    const persona = $("persona").value;
    const cat = $("category").value;

    const list = getExampleList(root, scene, persona, cat);
    if(!list.length) return null;

    ensureCounter(scene, persona, cat);
    const i = counters[scene][persona][cat] % list.length;
    counters[scene][persona][cat] = counters[scene][persona][cat] + 1;
    return list[i];
  }

  async function fillExample(){
    await loadExamples();
    const ex = getNextExample();
    if(!ex){
      setStatus("例文が見つかりません（scene/persona/category を確認）");
      return;
    }
    $("prompt").value = ex.jp;
    setStatus("例文を入力しました（押すたび切替）");
  }

  // -----------------------
  // Main actions
  // -----------------------
  async function runAll(){
    if(busy) return;

    const jp = $("prompt").value.trim();
    if(!jp){ setStatus("入力が空です"); return; }

    setBusy(true);
    setStatus("介護士発話をローマ字化…");

    try{
      clearOutputs();

      // Caregiver romaji (reuse stage2)
      const r0 = await postChat({ prompt: jp, meta: meta(2) });
      $("caregiverRomaji").textContent = r0.romaji || "";

      // Stage1
      setStatus("Stage1 実行中…");
      const s1 = await postChat({ prompt: jp, meta: meta(1) });
      $("aiReply").textContent = s1.ai_reply_jp || "";
      $("feedback").textContent = s1.feedback_jp || "";
      $("suggestedJp").value = s1.suggested_reply_jp || "";

      // Stage2 auto (on suggested reply)
      if($("autoStage2").checked){
        await runStage2Only(true);
      } else {
        setStatus("Stage1 完了（Stage2は手動）");
      }
    } catch(e){
      if(e?.name === "AbortError") return;
      setStatus("エラー: " + (e?.message || e));
    } finally {
      setBusy(false);
    }
  }

  async function runStage2Only(fromAuto){
    const suggested = $("suggestedJp").value.trim();
    if(!suggested){
      setStatus("Stage2: 推奨返答（日本語）が空です");
      return;
    }

    setStatus("Stage2 実行中…");
    const s2 = await postChat({ prompt: suggested, meta: meta(2) });
    $("romaji").textContent = s2.romaji || "";
    $("indonesian").textContent = s2.indonesian || "";
    setStatus("完了");
  }

  // Events
  $("fillExample").addEventListener("click", ()=>fillExample().catch(e=>setStatus("例文エラー: "+e.message)));
  $("send").addEventListener("click", runAll);
  $("runStage2").addEventListener("click", ()=>runStage2Only(false).catch(e=>setStatus("Stage2エラー: "+e.message)));

  $("scene").addEventListener("change", ()=>{ refreshCategories(); clearOutputs(); setStatus("Scene変更：例文or入力→送信"); });
  $("persona").addEventListener("change", ()=>{ refreshCategories(); clearOutputs(); setStatus("Persona変更：例文or入力→送信"); });
  $("category").addEventListener("change", ()=>{ clearOutputs(); setStatus("カテゴリ変更：例文ボタンで投入"); });

  loadExamples().then(()=>refreshCategories());
</script>
</body>
</html>
