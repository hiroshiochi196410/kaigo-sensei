<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>介護ロールプレイAI（介護士発話ローマ字対応）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { display:flex; gap:6px; align-items:center; }
    select, textarea, button, input { font-size: 15px; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    button.primary { border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    textarea { width: 100%; min-height: 110px; padding: 10px; border-radius: 12px; border: 1px solid #ddd; }
    .muted { color: #666; font-size: 13px; }
    .badge { display:inline-block; padding: 2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
    .card { border: 1px solid #e1e1e1; border-radius: 14px; padding: 12px; margin-top: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sep { height:1px; background:#eee; margin: 10px 0; }
  </style>
</head>
<body>
<h1>介護ロールプレイAI <span class="badge">介護士ローマ字対応</span></h1>

<div class="muted">①介護士発話 → ローマ字表示 → ②Stage1 → ③Stage2</div>

<div style="margin-top:12px;">
  <div class="muted">介護士（あなた）の発話（日本語）</div>
  <textarea id="prompt" placeholder="例：こんばんは。今日はどのようにお過ごしでしたか？"></textarea>
</div>

<div class="card">
  <div><b>介護士発話（ローマ字）</b></div>
  <pre id="caregiverRomaji" class="mono"></pre>
</div>

<button id="send" class="primary">送信</button>
<span id="status" class="muted"></span>

<div class="grid">
  <div class="card">
    <div class="muted">Stage1（日本語）</div>
    <pre id="aiReply" class="mono"></pre>
    <div class="sep"></div>
    <pre id="feedback" class="mono"></pre>
    <div class="sep"></div>
    <textarea id="suggestedJp" placeholder="推奨返答（日本語）"></textarea>
  </div>

  <div class="card">
    <div class="muted">Stage2（翻訳）</div>
    <div><b>ローマ字</b></div>
    <pre id="romaji" class="mono"></pre>
    <div class="sep"></div>
    <div><b>インドネシア語</b></div>
    <pre id="indonesian" class="mono"></pre>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

async function postChat(payload){
  const r = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  if(!r.ok) throw new Error(j.error || j.message || "API error");
  return j;
}

async function run(){
  const jp = $("prompt").value.trim();
  if(!jp) return;

  $("status").textContent = "介護士発話をローマ字化…";

  const romajiRes = await postChat({
    prompt: jp,
    meta: { stage: 2, persona: "user_calm", scene: "bath" }
  });
  $("caregiverRomaji").textContent = romajiRes.romaji || "";

  $("status").textContent = "Stage1 実行中…";
  const s1 = await postChat({
    prompt: jp,
    meta: { stage: 1, persona: "user_calm", scene: "bath" }
  });

  $("aiReply").textContent = s1.ai_reply_jp || "";
  $("feedback").textContent = s1.feedback_jp || "";
  $("suggestedJp").value = s1.suggested_reply_jp || "";

  $("status").textContent = "Stage2 実行中…";
  const s2 = await postChat({
    prompt: s1.suggested_reply_jp,
    meta: { stage: 2, persona: "user_calm", scene: "bath" }
  });

  $("romaji").textContent = s2.romaji || "";
  $("indonesian").textContent = s2.indonesian || "";

  $("status").textContent = "完了";
}

$("send").addEventListener("click", ()=>run().catch(e=>$("status").textContent="エラー: "+e.message));
</script>
</body>
</html>
