<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>介護ロールプレイAI（カテゴリ例文デモ）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, textarea, button { font-size: 16px; }
    textarea { width: 100%; min-height: 110px; padding: 10px; }
    button { padding: 10px 14px; cursor: pointer; }
    .muted { color: #666; font-size: 14px; }
    .badge { display:inline-block; padding: 2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
  </style>
</head>
<body>
  <h2>カテゴリ例文デモ（入浴/食事/排泄/夜間/クレーム）</h2>
  <div class="muted"><span class="badge">例文を入れる</span> を押すたびに、選択中の <span class="badge">scene×カテゴリ×persona</span> でローテーションします。</div>

  <div class="row" style="margin-top:12px;">
    <label>scene:
      <select id="scene"></select>
    </label>

    <label>persona:
      <select id="persona"></select>
    </label>

    <label>カテゴリ:
      <select id="category"></select>
    </label>

    <button id="fillExample" type="button">例文を入れる</button>
    <span id="status" class="muted"></span>
  </div>

  <div style="margin-top:12px;">
    <div class="muted">介護士（あなた）の発話（日本語）</div>
    <textarea id="prompt" placeholder="例文ボタンで自動入力されます。"></textarea>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const setStatus = (msg) => $("status").textContent = msg || "";
  let DB = null;
  const counters = {}; // counters[scene][persona][category]

  function initCounter(scene, persona, cat){
    if(!counters[scene]) counters[scene]={};
    if(!counters[scene][persona]) counters[scene][persona]={};
    if(typeof counters[scene][persona][cat] !== "number") counters[scene][persona][cat]=0;
  }

  function populateSelect(sel, items){
    sel.innerHTML="";
    items.forEach(it=>{
      const opt=document.createElement("option");
      opt.value=it.key;
      opt.textContent=it.label;
      sel.appendChild(opt);
    });
  }

  async function load(){
    if(DB) return DB;
    setStatus("例文読み込み中…");
    const r = await fetch("/examples.json", { cache: "no-store" });
    DB = await r.json();
    populateSelect($("scene"), Object.keys(DB.scenes).map(k=>({key:k,label: k})));
    populateSelect($("persona"), DB.personas);
    refreshCategories();
    setStatus("例文OK");
    return DB;
  }

  function refreshCategories(){
    const scene=$("scene").value;
    const cats = DB?.scenes?.[scene] || [];
    populateSelect($("category"), cats);
  }

  function getNext(){
    const scene=$("scene").value;
    const persona=$("persona").value;
    const cat=$("category").value;
    const list = DB?.examples?.[scene]?.[persona]?.[cat] || [];
    if(!list.length) return null;
    initCounter(scene, persona, cat);
    const i = counters[scene][persona][cat] % list.length;
    counters[scene][persona][cat] = counters[scene][persona][cat] + 1;
    return list[i];
  }

  async function fill(){
    await load();
    const ex = getNext();
    if(!ex){ setStatus("例文なし（examples.json確認）"); return; }
    $("prompt").value = ex.jp;
    setStatus("例文を入力しました");
  }

  $("fillExample").addEventListener("click", ()=>fill().catch(e=>setStatus("エラー: "+e.message)));
  $("scene").addEventListener("change", ()=>{ refreshCategories(); if(!$("prompt").value.trim()) fill().catch(()=>{}); });
  $("persona").addEventListener("change", ()=>{ if(!$("prompt").value.trim()) fill().catch(()=>{}); });
  $("category").addEventListener("change", ()=>{ if(!$("prompt").value.trim()) fill().catch(()=>{}); });

  load().catch(e=>setStatus("読込失敗: "+e.message));
</script>
</body>
</html>
