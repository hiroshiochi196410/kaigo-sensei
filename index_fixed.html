<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>介護ロールプレイAI（フロント最適化・修正版）</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 18px; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    textarea { width:100%; min-height:110px; }
    pre { white-space:pre-wrap; }
  </style>
</head>
<body>
<h1>介護ロールプレイAI（フロント最適化・修正版）</h1>
<p id="status"></p>

<label>Persona:
  <select id="persona">
    <option value="user_calm">利用者：穏やか</option>
    <option value="user_angry">利用者：怒り</option>
    <option value="dementia">利用者：混乱</option>
    <option value="family_anxious">家族：不安</option>
    <option value="family_complaint">家族：クレーム</option>
  </select>
</label>

<label>Scene:
  <select id="scene">
    <option value="bath">入浴</option>
    <option value="meal">食事</option>
    <option value="toilet">排泄</option>
    <option value="night">夜間</option>
    <option value="complaint">クレーム</option>
  </select>
</label>

<br/><br/>
<textarea id="prompt" placeholder="介護士の発話（日本語）"></textarea><br/>
<button id="send">送信</button>

<h3>Stage1</h3>
<pre id="aiReply"></pre>
<pre id="feedback"></pre>
<textarea id="suggestedJp"></textarea>

<h3>Stage2</h3>
<pre id="romaji"></pre>
<pre id="indonesian"></pre>

<script>
let controller = null;
let busy = false;

const $ = id => document.getElementById(id);
const setStatus = m => $("status").textContent = m || "";
const setBusy = b => {
  busy = b;
  $("send").disabled = b;
};

async function postChat(payload, timeoutMs = 15000) {
  if (controller) controller.abort();
  controller = new AbortController();

  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "API error");
    return data;
  } finally {
    clearTimeout(timer);
  }
}

async function run() {
  if (busy) return;
  const prompt = $("prompt").value.trim();
  if (!prompt) return;

  const persona = $("persona").value;
  const scene = $("scene").value;

  setBusy(true);
  setStatus("Stage1 実行中…");

  try {
    const s1 = await postChat({ 
      prompt, 
      meta: { stage:1, persona, scene } 
    });

    $("aiReply").textContent = s1.ai_reply_jp || "";
    $("feedback").textContent = s1.feedback_jp || "";
    $("suggestedJp").value = s1.suggested_reply_jp || "";

    setStatus("Stage2 実行中…");
    const s2 = await postChat({ 
      prompt: s1.suggested_reply_jp, 
      meta: { stage:2, persona, scene } 
    });

    $("romaji").textContent = s2.romaji || "";
    $("indonesian").textContent = s2.indonesian || "";

    setStatus("完了");
  } catch(e) {
    if (e.name === "AbortError") {
      setStatus("中断しました");
    } else {
      setStatus("エラー: " + e.message);
    }
  } finally {
    setBusy(false);
  }
}

$("send").addEventListener("click", run);
</script>
</body>
</html>
