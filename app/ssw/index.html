<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI <span id="variantBadge" class="badge" style="display:none;"></span>ï¼ˆã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿ï¼špersonaå¯¾å¿œï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 12px; }
    label { display:flex; gap:6px; align-items:center; font-size:14px; }
    select, textarea, button, input { font-size: 15px; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    button.primary { border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    textarea { width:100%; min-height:110px; padding:10px; border-radius: 12px; border:1px solid #ddd; }
    .muted { color:#666; font-size:13px; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#333; }
    .card { border:1px solid #e1e1e1; border-radius:14px; padding:12px; margin-top:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    pre { white-space: pre-wrap; word-break: break-word; margin:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .sep { height:1px; background:#eee; margin:10px 0; }
    .hint { font-size:12px; color:#777; }
    .speakBtn{ padding:6px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; }
  </style>
</head>
<body>
  <h1>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI <span class="badge">ä¾‹æ–‡å¾©æ´»FIX</span> <span class="badge">ã‚«ãƒ†ã‚´ãƒª</span> <span class="badge">personaçµã‚Šè¾¼ã¿</span> <span class="badge">ä»‹è­·å£«ãƒ­ãƒ¼ãƒå­—</span></h1>
  <div class="hint">â‘ ä¾‹æ–‡æŠ•å…¥ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰â†’ â‘¡ä»‹è­·å£«ç™ºè©±ãƒ­ãƒ¼ãƒå­— â†’ â‘¢Stage1 â†’ â‘£Stage2ï¼ˆæ¨å¥¨è¿”ç­”ã®ãƒ­ãƒ¼ãƒå­—ï¼‹ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</div>

  <div class="row">
    <label>Scene
      <select id="scene"></select>
    </label>
    <label>Persona
      <select id="persona"></select>
    </label>
    <label>ã‚«ãƒ†ã‚´ãƒª
      <select id="category"></select>
    </label>
    <label>ãƒ¬ãƒ™ãƒ«
      <select id="level"></select>
    </label>

    <button id="fillExample" class="primary" type="button">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>

    <button id="btnSpeakExampleJa" class="speakBtn" type="button">ğŸ”Šä¾‹æ–‡(JA)</button>
    <button id="btnSpeakExampleId" class="speakBtn" type="button">ğŸ”Šä¾‹æ–‡(ID)</button>
    <button id="btnSpeakTest" class="speakBtn" type="button">ğŸ”Šãƒ†ã‚¹ãƒˆ</button>

    <label><input id="autoStage2" type="checkbox" checked> Stage2ã‚’è‡ªå‹•å®Ÿè¡Œ</label>
    <span class="muted" id="status">examples.json OK</span>
  </div>

  <div class="sep"></div>

  <div class="muted">ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰</div>
  <textarea id="prompt" placeholder="ä¾‹æ–‡ãƒœã‚¿ãƒ³ã§è‡ªå‹•å…¥åŠ›ã€ã¾ãŸã¯è‡ªç”±å…¥åŠ›"></textarea>

  <div class="hint">â€» examples.json ãŒã‚ã‚‹å ´åˆï¼šsceneÃ—personaÃ—ã‚«ãƒ†ã‚´ãƒªã®ä¾‹æ–‡ãŒå‡ºã¾ã™ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰</div>

  <div class="card">
    <div class="muted"><b>ä»‹è­·å£«ç™ºè©±ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</b></div>
    <textarea id="caregiverRomaji" class="mono" placeholder="ãƒ­ãƒ¼ãƒå­—ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆè‡ªå‹•ï¼‰"></textarea>

    <div class="row">
      <button id="sendBtn" class="primary" type="button">é€ä¿¡</button>
      <button id="runStage2" type="button">Stage2ã ã‘å®Ÿè¡Œ</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="muted"><b>Stage1ï¼ˆæ—¥æœ¬èªï¼‰</b></div>
        <div class="sep"></div>
        <div><b>ç›¸æ‰‹ï¼ˆAIå´ï¼‰ã®è¿”ç­”</b></div>
        <pre id="aiReply"></pre>
        <div class="sep"></div>
        <div><b>ã‚ãªãŸã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</b></div>
        <pre id="feedback"></pre>
        <div class="sep"></div>
        <div><b>æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰</b></div>
        <textarea id="recommendedJa" placeholder="Stage1å®Ÿè¡Œå¾Œã«å…¥ã‚Šã¾ã™"></textarea>
      </div>

      <div class="card">
        <div class="muted"><b>Stage2ï¼ˆç¿»è¨³ï¼šæ¨å¥¨è¿”ç­”ï¼‰</b></div>
        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;">
          <b>ãƒ­ãƒ¼ãƒå­—ï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b>
          <button id="btnSpeakStage2Romaji" class="speakBtn" type="button">ğŸ”Š</button>
        </div>
        <pre id="romaji" class="mono"></pre>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;">
          <b>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b>
          <button id="btnSpeakStage2Id" class="speakBtn" type="button">ğŸ”Š</button>
        </div>
        <pre id="indonesian" class="mono"></pre>
      </div>
    </div>
  </div>

<script>
/* =============================
   Helpers
============================= */
const $ = (id)=>document.getElementById(id);
let busy = false;
let exampleDb = null;
let currentList = [];
let currentIdx = -1;
window.currentExample = null;

const setBusy = (b) => {
  busy = b;
  ["fillExample","sendBtn","runStage2","scene","persona","category","level"].forEach((id)=>{
    const el = $(id);
    if(el) el.disabled = b;
  });
};

function setStatus(msg){ $("status").textContent = msg; }

/* =============================
   Load examples.json (v1 or v2)
============================= */
async function loadExamples(){
  // Prefer v2 if exists
  const urls = ["./examples.v2.json","./examples.json","/examples.v2.json","/examples.json"];
  for(const u of urls){
    try{
      const r = await fetch(u, { cache:"no-store" });
      if(!r.ok) continue;
      const j = await r.json();
      exampleDb = j;
      setStatus("examples loaded: " + u);
      return;
    }catch(e){}
  }
  setStatus("examples not found");
}

function normalizeDb(db){
  // Accept v1 { personas:[], scenes:{scene:[{key,label}...]} , examples:[...] } OR v2 flexible
  if(!db) return { personas:[], scenes:[], categories:[], levels:[], items:[] };

  // personas
  const personas = Array.isArray(db.personas) ? db.personas : [];
  // scenes
  let sceneDefs = [];
  if(db.scenes && typeof db.scenes === "object"){
    // v1 style: scenes: { bath:[{key,label}...], meal:[...], ...}
    sceneDefs = Object.keys(db.scenes).map(k=>({ key:k, label:k }));
  } else if(Array.isArray(db.scenes)){
    sceneDefs = db.scenes;
  }

  // items (examples)
  const items = Array.isArray(db.examples) ? db.examples : (Array.isArray(db.items) ? db.items : []);

  // categories / levels from items
  const cats = new Set();
  const lvls = new Set();
  for(const it of items){
    if(it.category) cats.add(it.category);
    if(it.level) lvls.add(it.level);
  }
  const categories = Array.from(cats).sort().map(k=>({key:k,label:k}));
  const levels = Array.from(lvls).sort();
  return { personas, scenes: sceneDefs, categories, levels, items };
}

function fillSelect(sel, arr, addAllLabel){
  sel.innerHTML = "";
  if(addAllLabel){
    const o = document.createElement("option");
    o.value = "";
    o.textContent = addAllLabel;
    sel.appendChild(o);
  }
  for(const it of arr){
    const o = document.createElement("option");
    o.value = it.key ?? it.value ?? it;
    o.textContent = it.label ?? it.key ?? it;
    sel.appendChild(o);
  }
}

function getSelected(){
  return {
    scene: $("scene").value,
    persona: $("persona").value,
    category: $("category").value,
    level: $("level").value
  };
}

function filterExamples(){
  const {scene, persona, category, level} = getSelected();
  const db = normalizeDb(exampleDb);
  let list = db.items;

  if(scene) list = list.filter(x=>x.scene===scene);
  if(persona) list = list.filter(x=>x.persona===persona);
  if(category) list = list.filter(x=>x.category===category);
  if(level) list = list.filter(x=>x.level===level);

  return list;
}

function applyPersonaCategoryFilter(){
  // If items include allowed_personas or persona_tags you can refine here
  // For now: no-op (kept for future extension)
}

/* =============================
   Stage helpers
============================= */
async function callChatApi(payload){
  const r = await fetch("/api/chat", {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!r.ok){
    const t = await r.text().catch(()=>"(no body)");
    throw new Error("API error " + r.status + ": " + t);
  }
  return await r.json();
}

function toRomajiStub(jp){
  // Minimal: keep as-is if backend handles; placeholder for your pipeline
  return jp;
}

/* =============================
   Example fill (v2 support)
============================= */
function putExampleToPrompt(ex){
  // v2: ex.text.ja / ex.text.id
  const ja = ex?.text?.ja || ex?.jp || ex?.ja || "";
  $("prompt").value = ja;
  window.currentExample = ex;
}

function cycleExample(){
  currentList = filterExamples();
  if(!currentList.length){
    setStatus("è©²å½“ä¾‹æ–‡ãªã—ï¼ˆæ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ï¼‰");
    return;
  }
  currentIdx = (currentIdx + 1) % currentList.length;
  const ex = currentList[currentIdx];
  putExampleToPrompt(ex);
  setStatus(`ä¾‹æ–‡ ${currentIdx+1}/${currentList.length}`);
}

async function runAll(){
  try{
    setBusy(true);
    setStatus("Stage1 å®Ÿè¡Œä¸­...");
    const prompt = $("prompt").value || "";
    $("caregiverRomaji").value = toRomajiStub(prompt);

    const stage1 = await callChatApi({
      mode:"stage1",
      prompt
    });

    $("aiReply").textContent = stage1.ai_reply || "";
    $("feedback").textContent = stage1.feedback || "";
    $("recommendedJa").value = stage1.recommended_ja || "";

    if($("autoStage2").checked){
      await runStage2();
    } else {
      setStatus("Stage1 å®Œäº†");
    }
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
    setStatus("ã‚¨ãƒ©ãƒ¼");
  }finally{
    setBusy(false);
  }
}

async function runStage2(){
  try{
    setBusy(true);
    setStatus("Stage2 å®Ÿè¡Œä¸­...");
    const ja = $("recommendedJa").value || "";
    const stage2 = await callChatApi({
      mode:"stage2",
      text: ja
    });
    $("romaji").textContent = stage2.romaji || "";
    $("indonesian").textContent = stage2.indonesian || "";
    setStatus("å®Œäº†");
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
    setStatus("ã‚¨ãƒ©ãƒ¼");
  }finally{
    setBusy(false);
  }
}

/* =============================
   TTS (linked to examples.v2.json tts_lang)
============================= */
function ttsSupported(){
  return typeof window !== "undefined" && "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
}
function pickVoice(langCode){
  const voices = speechSynthesis.getVoices();
  return voices.find(v=>v.lang===langCode) || null;
}
function getTextFrom(el){
  if(!el) return "";
  if(typeof el.value === "string") return el.value;
  return (el.textContent || "").trim();
}
function getTtsCfg(ex, lang){
  const cfg = (ex && ex.tts_lang && ex.tts_lang[lang]) ? ex.tts_lang[lang] : null;
  const base = ex && ex.tts ? ex.tts : null;
  return {
    speech_rate: (cfg && cfg.speech_rate != null) ? cfg.speech_rate : (base && base.speech_rate != null ? base.speech_rate : (lang==="id" ? 0.9 : 1.0)),
    pause_ms: (cfg && cfg.pause_ms != null) ? cfg.pause_ms : (base && base.pause_ms != null ? base.pause_ms : 300),
    priority: (base && base.priority) ? base.priority : "normal"
  };
}
function splitForPause(text){
  const t = (text || "").trim();
  if(!t) return [];
  const parts = t.split(/(?<=[ã€‚ï¼.!?ï¼Ÿ])\s*/);
  return parts.filter(p=>p && p.trim());
}

function romajiToNaturalJa(s){
  // Convert only for JA TTS to avoid "wa/ga/no..." being spelled out.
  let t = (s || "");
  t = t.replace(/\bwa\b/g, "ã¯");
  t = t.replace(/\bga\b/g, "ãŒ");
  t = t.replace(/\bwo\b/g, "ã‚’");
  t = t.replace(/\bno\b/g, "ã®");
  t = t.replace(/\bni\b/g, "ã«");
  t = t.replace(/\bde\b/g, "ã§");
  t = t.replace(/\bto\b/g, "ã¨");
  t = t.replace(/\bkara\b/g, "ã‹ã‚‰");
  t = t.replace(/\bmade\b/g, "ã¾ã§");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}

function speakWithCfg(text, lang, ex){
  if(!ttsSupported()){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ï¼ˆTTSï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edgeã§ãŠè©¦ã—ãã ã•ã„ã€‚");
    return;
  }
  const t = (text || "").trim();
  if(!t){
    alert("èª­ã¿ä¸Šã’ã‚‹æ–‡ç« ãŒç©ºã§ã™ã€‚\nãƒ»å…ˆã«ã€Œä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹ã€ã‚’æŠ¼ã™\nãƒ»ã¾ãŸã¯ Stage2 ã‚’å®Ÿè¡Œã—ã¦æ–‡ç« ã‚’è¡¨ç¤º\nã—ã¦ã‹ã‚‰ ğŸ”Š ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const cfg = getTtsCfg(ex, lang);
  const langCode = (lang==="id") ? "id-ID" : "ja-JP";
  const voice = pickVoice(langCode);

  speechSynthesis.cancel();

  const chunks = splitForPause(t);
  let i = 0;

  const speakNext = () => {
    if(i >= chunks.length) return;
    const u = new SpeechSynthesisUtterance(chunks[i]);
    u.lang = langCode;
    u.rate = cfg.speech_rate;
    if(voice) u.voice = voice;

    u.onend = () => {
      i += 1;
      if(i < chunks.length) setTimeout(speakNext, cfg.pause_ms);
    };
    u.onerror = () => {
      i += 1;
      if(i < chunks.length) setTimeout(speakNext, cfg.pause_ms);
    };
    speechSynthesis.speak(u);
  };
  speakNext();
}

function currentExampleSafe(){
  return window.currentExample || null;
}
if (ttsSupported() && speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = () => {};
}

/* Click handler: use closest("button") so icon clicks work */
document.addEventListener("click",(e)=>{
  const btn = (e.target && e.target.closest) ? e.target.closest("button") : null;
  const id = btn ? btn.id : (e.target && e.target.id);
  const ex = currentExampleSafe();

  if(id==="btnSpeakTest"){
    speakWithCfg("ãƒ†ã‚¹ãƒˆã§ã™ã€‚éŸ³ãŒèã“ãˆã¾ã™ã‹ã€‚","ja",ex);
  }
  if(id==="btnSpeakExampleJa"){
    const t = ex?.text?.ja || ex?.jp || getTextFrom($("prompt"));
    speakWithCfg(t,"ja",ex);
  }
  if(id==="btnSpeakExampleId"){
    const t = ex?.text?.id || ex?.id || getTextFrom($("prompt"));
    speakWithCfg(t,"id",ex);
  }
  if(id==="btnSpeakStage2Romaji"){
    const raw = getTextFrom($("romaji"));
    const fixed = romajiToNaturalJa(raw);
    speakWithCfg(fixed,"ja",ex);
  }
  if(id==="btnSpeakStage2Id"){
    const t = getTextFrom($("indonesian"));
    speakWithCfg(t,"id",ex);
  }
});

/* =============================
   Bindings / init
============================= */
$("fillExample").addEventListener("click", cycleExample);
$("sendBtn").addEventListener("click", runAll);
$("runStage2").addEventListener("click", runStage2);

["scene","persona","category","level"].forEach(id=>{
  $(id).addEventListener("change", ()=>{
    currentIdx = -1;
    window.currentExample = null;
    setStatus("æ¡ä»¶å¤‰æ›´");
  });
});

(async function init(){
  await loadExamples();
  const db = normalizeDb(exampleDb);

  fillSelect($("scene"), db.scenes, "å…¨ã¦");
  fillSelect($("persona"), db.personas, "å…¨ã¦");
  fillSelect($("category"), db.categories, "å…¨ã¦");
  fillSelect($("level"), db.levels.length ? db.levels : ["åˆç´š","ä¸­ç´š","ä¸Šç´š"], "å…¨ã¦");
})();
</script>
</body>
</html>
