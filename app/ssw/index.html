<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI <span id="variantBadge" class="badge" style="display:none;"></span> ï¼ˆã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿ï¼špersonaå¯¾å¿œï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 12px; }
    label { display:flex; gap:6px; align-items:center; font-size: 14px; }
    select, textarea, button, input { font-size: 15px; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    button.primary { border-color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    textarea { width:100%; min-height:110px; padding:10px; border-radius: 12px; border:1px solid #ddd; }
    .muted { color:#666; font-size:13px; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#333; }
    .card { border:1px solid #e1e1e1; border-radius:14px; padding:12px; margin-top:12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    pre { white-space: pre-wrap; word-break: break-word; margin:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sep { height:1px; background:#eee; margin:10px 0; }
    .hint { font-size: 12px; color:#777; }
  </style>
</head>
<body>
  <h1>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI
    <span class="badge">ä¾‹æ–‡å¾©æ´»FIX</span>
    <span class="badge">ã‚«ãƒ†ã‚´ãƒª</span>
    <span class="badge">personaçµã‚Šè¾¼ã¿</span>
    <span class="badge">ä»‹è­·å£«ãƒ­ãƒ¼ãƒå­—</span>
  </h1>
  <div class="muted">â‘ ä¾‹æ–‡æŠ•å…¥ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰â†’ â‘¡ä»‹è­·å£«ç™ºè©±ãƒ­ãƒ¼ãƒå­— â†’ â‘¢Stage1 â†’ â‘£Stage2ï¼ˆæ¨å¥¨è¿”ç­”ã®ãƒ­ãƒ¼ãƒå­—ï¼‹ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</div>

  <div class="row">
    <label>Scene <select id="scene"></select></label>
    <label>Persona <select id="persona"></select></label>
    <label>ã‚«ãƒ†ã‚´ãƒª <select id="category"></select></label>
    <label>ãƒ¬ãƒ™ãƒ« <select id="level"></select></label>

    
    <button id="fillExample" type="button">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
    <button id="btnSpeakExampleJa" type="button">ğŸ”Šä¾‹æ–‡(JA)</button>
    <button id="btnSpeakExampleId" type="button">ğŸ”Šä¾‹æ–‡(ID)</button>
    <button id="btnSpeakTest" type="button">ğŸ”Šãƒ†ã‚¹ãƒˆ</button>


    <label class="muted" style="gap:8px;">
      <input id="autoStage2" type="checkbox" checked />
      Stage2ã‚’è‡ªå‹•å®Ÿè¡Œ
    </label>

    <span id="status" class="muted"></span>
  </div>

  <div>
    <div class="muted">ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰</div>
    <textarea id="prompt" placeholder="ä¾‹æ–‡ãƒœã‚¿ãƒ³ã§è‡ªå‹•å…¥åŠ›ã€ã¾ãŸã¯è‡ªç”±å…¥åŠ›"></textarea>
    <div class="hint">â€» examples.json ãŒã‚ã‚‹å ´åˆï¼šsceneÃ—personaÃ—ã‚«ãƒ†ã‚´ãƒªã®ä¾‹æ–‡ãŒå‡ºã¾ã™ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰</div>
<div class="card" id="paywallBox" style="display:none; margin-top:10px;">
  <b>ç„¡æ–™ä½“é¨“</b>
  <div id="trialInfo" class="hint" style="margin-top:6px;"></div>
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
    <button class="primary" id="paywallBtn" type="button">Stripeã§æ±ºæ¸ˆã—ã¦æœ¬æ ¼åˆ©ç”¨</button>
    <span id="paywallNote" class="hint"></span>
  </div>
  <div id="unlockMsg" class="hint" style="margin-top:6px;"></div>
</div>

    <div id="noExampleHint" class="hint" style="display:none; margin-top:6px;">ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªç”±å…¥åŠ›ã§ç¶šã‘ã¾ã—ã‚‡ã†ã€‚</div>
  </div>

  <div class="card">
    <div><b>ä»‹è­·å£«ç™ºè©±ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</b></div>
    <pre id="caregiverRomaji" class="mono"></pre>
  </div>

  <div class="row">
    <button id="sendBtn" class="primary" type="button">é€ä¿¡</button>
    <button id="runStage2" type="button">Stage2ã ã‘å®Ÿè¡Œ</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="muted">Stage1ï¼ˆæ—¥æœ¬èªï¼‰</div>
      <div class="sep"></div>
      <div><b>ç›¸æ‰‹ï¼ˆAIå´ï¼‰ã®è¿”ç­”</b></div>
      <pre id="aiReply" class="mono"></pre>
      <div class="sep"></div>
      <div><b>ã‚ãªãŸã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</b></div>
      <pre id="feedback" class="mono"></pre>
      <div class="sep"></div>
      <div><b>æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰</b></div>
      <textarea id="suggestedJp" placeholder="Stage1å®Ÿè¡Œå¾Œã«å…¥ã‚Šã¾ã™"></textarea>
    </div>

    <div class="card">
      <div class="muted">Stage2ï¼ˆç¿»è¨³ï¼šæ¨å¥¨è¿”ç­”ï¼‰</div>
      <div class="sep"></div>
      <div><b>ãƒ­ãƒ¼ãƒå­—ï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b> <button id="btnSpeakStage2Romaji" type="button">ğŸ”Š</button></div>
      <pre id="romaji" class="mono"></pre>
      <div class="sep"></div>
      <div><b>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b> <button id="btnSpeakStage2Id" type="button">ğŸ”Š</button></div>
      <pre id="indonesian" class="mono"></pre>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const setStatus = (m) => $("status").textContent = m || "";
  const showNoExampleHint = (show) => {
    const el = $("noExampleHint");
    if(!el) return;
    el.style.display = show ? "block" : "none";
  };


  
  // -----------------------
  // App config (variant)
  // Each sub-app should place ./config.json and ./examples.json
  // -----------------------
  let APP = {
    variant: "default",
    title: document.title,
    default_scene: "bath",
    default_persona: "user_calm",
    default_level: "all",
    trial_limit: 3,
    stripe_price_id: "",
    stripe_checkout_url: "" // optional (if you already have a hosted payment page)
  };

  async function loadConfig(){
    // Prefer relative config (e.g., /app/trainee/config.json). Fallback to /app/config.json.
    const urls = ["./config.json", "/app/config.json"];
    for(const u of urls){
      try{
        const r = await fetch(u, { cache:"no-store" });
        if(!r.ok) continue;
        const cfg = await r.json();
        APP = { ...APP, ...cfg };
        // Title
        if(APP.title){
          document.title = APP.title;
          // Also adjust H1 text without breaking badges
          const h1 = document.querySelector("h1");
          if(h1){
            // keep existing HTML, just prepend title text
            // We'll set first text node if exists
          }
        }
        const badge = $("variantBadge");
        if(badge && APP.variant){
          badge.textContent = APP.variant;
          badge.style.display = "inline-block";
        }
        return APP;
      } catch(e){
        // ignore and try next
      }
    }
    return APP;
  }

  // -----------------------
  // Trial gating (per variant)
  // - counts successful Stage1 calls
  // - stored in localStorage per variant
  // -----------------------
  const trialKey = () => `kaigo_trial_${APP.variant || "default"}`;
  
  // -----------------------
  // Simple unlock (manual code) for MVP
  // config.json:
  //   "unlock_code": "XXXX-YYYY" or "unlock_codes": ["...","..."]
  // When correct, sets localStorage kaigo_paid_<variant> = "1"
  // -----------------------
  const normalizeCode = (s) => (s||"").toString().trim().replace(/\s+/g,"").toUpperCase();

  const getAllowedUnlockCodes = () => {
    const codes = [];
    if (APP.unlock_code) codes.push(APP.unlock_code);
    if (Array.isArray(APP.unlock_codes)) codes.push(...APP.unlock_codes);
    // variant-specific (optional)
    if (APP.variant && APP[`unlock_code_${APP.variant}`]) codes.push(APP[`unlock_code_${APP.variant}`]);
    if (APP.variant && Array.isArray(APP[`unlock_codes_${APP.variant}`])) codes.push(...APP[`unlock_codes_${APP.variant}`]);
    return codes.map(normalizeCode).filter(Boolean);
  };

  const tryUnlock = () => {
    const input = $("unlockCode");
    const msg = $("unlockMsg");
    const code = normalizeCode(input?.value || "");
    const allowed = getAllowedUnlockCodes();

    if (!code) {
      if (msg) { msg.textContent = "è§£é™¤ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; msg.style.color = "#b45309"; }
      return false;
    }
    if (allowed.length === 0) {
      if (msg) { msg.textContent = "ï¼ˆè§£é™¤ã‚³ãƒ¼ãƒ‰ãŒæœªç™»éŒ²ã§ã™ï¼šconfig.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰"; msg.style.color = "#b45309"; }
      return false;
    }
    const ok = allowed.includes(code);
    if (ok) {
      localStorage.setItem(paidKey(), "1");
      if (msg) { msg.textContent = "âœ… è§£é™¤ã—ã¾ã—ãŸã€‚æœ¬æ ¼åˆ©ç”¨ãŒå¯èƒ½ã§ã™ã€‚"; msg.style.color = "#065f46"; }
      updateTrialUI();
      return true;
    }
    if (msg) { msg.textContent = "è§£é™¤ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"; msg.style.color = "#b91c1c"; }
    return false;
  };

  const resetUnlock = () => {
    localStorage.removeItem(paidKey());
    updateTrialUI();
    const msg = $("unlockMsg");
    if (msg) { msg.textContent = "è§£é™¤çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"; msg.style.color = "#374151"; }
  };

const paidKey  = () => `kaigo_paid_${APP.variant || "default"}`; // for later (Stripe/Webhook)
  const isPaid = () => localStorage.getItem(paidKey()) === "1";

  const getTrialCount = () => Number(localStorage.getItem(trialKey()) || "0");
  const setTrialCount = (n) => localStorage.setItem(trialKey(), String(Math.max(0, Number(n)||0)));

  const remainingTrials = () => {
    const limit = Number(APP.trial_limit ?? 3);
    if(isPaid()) return Infinity;
    return Math.max(0, limit - getTrialCount());
  };

  const updateTrialUI = () => {
    const el = $("trialInfo");
    const pw = $("paywall");
    const pwBtn = $("paywallBtn");
    const pwNote = $("paywallNote");
    const um = $("unlockMsg");
    if(!el) return;
    const limit = Number(APP.trial_limit ?? 3);
    if(isPaid()){
      el.textContent = "âœ… æœ¬æ ¼åˆ©ç”¨ï¼šæœ‰åŠ¹ï¼ˆæ±ºæ¸ˆæ¸ˆã¿ï¼‰";
      enableActions(true);
      if(pw) pw.style.display = "none";
      if(um) um.textContent = "";
      return;
    }
    const used = getTrialCount();
    const left = Math.max(0, limit - used);
    el.textContent = `è©¦ç”¨ï¼š${used}/${limit} å›ï¼ˆæ®‹ã‚Š ${left} å›ï¼‰`;
    enableActions(left > 0);
    if(pw) pw.style.display = (left === 0 ? "block" : "none");
    if(pwBtn){
      const url = APP.stripe_checkout_url || "";
      pwBtn.href = url || "#";
      pwBtn.style.pointerEvents = url ? "auto" : "none";
      pwBtn.style.opacity = url ? "1" : "0.5";
    }
    if(pwNote){
      if(APP.stripe_checkout_url){
        pwNote.textContent = "";
      } else if(APP.stripe_price_id){
        pwNote.textContent = `ï¼ˆStripe Price ID: ${APP.stripe_price_id}ï¼‰â€»æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§Checkoutãƒªãƒ³ã‚¯ã‚’æ¥ç¶šã—ã¾ã™`;
      } else {
        pwNote.textContent = "â€»æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§Stripeã®è³¼å…¥ãƒªãƒ³ã‚¯ã‚’æ¥ç¶šã—ã¾ã™";
      }
    }
if(left === 0){
      setStatus("è©¦ç”¨å›æ•°ã«é”ã—ã¾ã—ãŸã€‚è‡ªç”±å…¥åŠ›ã¯ã§ãã¾ã™ãŒã€AIå¿œç­”ã«ã¯æ±ºæ¸ˆãŒå¿…è¦ã§ã™ã€‚");
      showNoExampleHint(false);
    }
  };

  const enableActions = (enabled) => {
    // Disable API-consuming buttons when trial exhausted
    const sendBtn = $("sendBtn");
    const stage2Btn = $("runStage2");
    if(sendBtn) sendBtn.disabled = !enabled;
    if(stage2Btn) stage2Btn.disabled = !enabled;
  };

  const consumeTrial = () => {
    if(isPaid()) return true;
    const left = remainingTrials();
    if(left <= 0) return false;
    setTrialCount(getTrialCount() + 1);
    updateTrialUI();
    return true;
  };
let busy = false;
  let inFlight = null; // AbortController

  const setBusy = (b) => {
    busy = b;
    const ids = ["fillExample","sendBtn","runStage2","scene","persona","category"];
    ids.forEach((id)=>{ const el = $(id); if(el) el.disabled = b; });
  };

  function abortInFlight(){
    if(inFlight){
      try { inFlight.abort(); } catch(_){}
      inFlight = null;
    }
  }

  async function postChat(payload, { timeoutMs = 15000 } = {}){
    abortInFlight();
    inFlight = new AbortController();

    const timer = setTimeout(() => inFlight?.abort(), timeoutMs);
    try{
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        signal: inFlight.signal
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok){
        const msg = j?.message || j?.error || (j?.details ? String(j.details) : "") || ("HTTP " + r.status);
        const e = new Error(msg);
        e.status = r.status;
        throw e;
      }
      return j;
    } finally {
      clearTimeout(timer);
    }
  }

  function meta(stage){
    return {
      stage,
      persona: $("persona").value || "user_calm",
      scene: $("scene").value || "bath"
    };
  }

  function clearOutputs(){
    $("caregiverRomaji").textContent = "";
    $("aiReply").textContent = "";
    $("feedback").textContent = "";
    $("suggestedJp").value = "";
    $("romaji").textContent = "";
    $("indonesian").textContent = "";
  }

  // -----------------------
  // Examples loader
  // -----------------------
  let EX = null;
  const counters = {}; // counters[scene][persona][cat] = next index

  function ensureCounter(scene, persona, cat){
    if(!counters[scene]) counters[scene] = {};
    if(!counters[scene][persona]) counters[scene][persona] = {};
    if(typeof counters[scene][persona][cat] !== "number") counters[scene][persona][cat] = 0;
  }


  function resetCounter(scene, persona, cat){
    if(!scene || !persona || !cat) return;
    if(counters[scene] && counters[scene][persona] && typeof counters[scene][persona][cat] === "number"){
      counters[scene][persona][cat] = 0;
    }
  }
  function populateSelect(sel, options){
    sel.innerHTML = "";
    options.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o.key;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });
  }

  function normalizeExampleItem(x){
    if(typeof x === "string") return { jp: x, level: "beginner" };
    if(x && typeof x === "object"){
      return {
        jp: x.jp || x.text || x.prompt || "",
        level: x.level || x.lv || x.difficulty || "beginner"
      };
    }
    return { jp: "", level: "beginner" };
  }

  function getExampleList(root, scene, persona, cat){
    const list = (root && root[scene] && root[scene][persona] && root[scene][persona][cat]) || [];
    const level = ($("level") && $("level").value) ? $("level").value : "all";
    return (Array.isArray(list) ? list : [])
      .map(normalizeExampleItem)
      .filter(it => it.jp)
      .filter(it => (level === "all") ? true : (it.level === level));
  }

  async function fetchJSONWithFallbacks(){
    const urls = ["./examples.json", "/examples.json", "/app/examples.json"];
    let lastErr = null;
    for(const u of urls){
      try{
        const r = await fetch(u, { cache:"no-store" });
        if(!r.ok) throw new Error(u + " HTTP " + r.status);
        return await r.json();
      } catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("examples.json not found");
  }

  async function loadExamples(){
    if(EX) return EX;

    try{
      setStatus("examples.json èª­ã¿è¾¼ã¿ä¸­â€¦");
      const db = await fetchJSONWithFallbacks();

      const root = db.examples || db.data || db.dataset || db.items || db.scenes || null;
      if(!root) throw new Error("examples root not found (need examples/data/dataset)");

      // scenes (dict or array)
      const sceneOptions = [];
      if(Array.isArray(db.scenes)){
        db.scenes.forEach(v=>{
          if(typeof v === "string") sceneOptions.push({key:v,label:v});
          else if(v && typeof v === "object") sceneOptions.push({key:(v.key??v.value), label:(v.label??v.name??v.key??v.value)});
        });
      } else if(db.scenes && typeof db.scenes === "object"){
        Object.keys(db.scenes).forEach(k=>{
          const labelMap = { bath:"å…¥æµ´", meal:"é£Ÿäº‹", toilet:"æ’æ³„", night:"å¤œé–“", complaint:"ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ" };
          sceneOptions.push({ key:k, label: (labelMap[k] || k) });
        });
      } else {
        Object.keys(root||{}).forEach(k=>sceneOptions.push({key:k,label:k}));
      }

      // personas
      const personaOptions = [];
      if(Array.isArray(db.personas)){
        db.personas.forEach(v=>{
          if(typeof v === "string") personaOptions.push({key:v,label:v});
          else if(v && typeof v === "object"){
            const key = v.key ?? v.value ?? v.id;
            const label = v.label ?? v.name ?? key;
            if(key) personaOptions.push({key, label});
          }
        });
      } else {
        const first = sceneOptions[0]?.key;
        Object.keys((root && root[first]) || {}).forEach(p=>personaOptions.push({key:p,label:p}));
      }

      EX = { db, root, sceneOptions, personaOptions };
      populateSelect($("scene"), sceneOptions);
      populateSelect($("persona"), personaOptions);
      // Level options (UI only)
      const levelOptions = [
        { key: "all", label: "å…¨ã¦" },
        { key: "beginner", label: "åˆç´š" },
        { key: "intermediate", label: "ä¸­ç´š" },
        { key: "field", label: "ç¾å ´å³å¿œ" }
      ];
      populateSelect($("level"), levelOptions);
      $("level").value = (APP.default_level || "all");
      // Apply defaults for scene/persona (if options contain them)
      if(APP.default_scene && Array.from($("scene").options).some(o=>o.value===APP.default_scene)) $("scene").value = APP.default_scene;
      if(APP.default_persona && Array.from($("persona").options).some(o=>o.value===APP.default_persona)) $("persona").value = APP.default_persona;
      


      refreshCategories();
      showNoExampleHint(false);
      setStatus("examples.json OK");
      return EX;
    } catch(e){
      EX = null;
      showNoExampleHint(true);
      setStatus("ä¾‹æ–‡ãªã—ï¼ˆexamples.json æœªè¨­å®š/èª­è¾¼å¤±æ•—ï¼‰");
      populateSelect($("scene"), [
        {key:"bath",label:"å…¥æµ´"},
        {key:"meal",label:"é£Ÿäº‹"},
        {key:"toilet",label:"æ’æ³„"},
        {key:"night",label:"å¤œé–“"},
        {key:"complaint",label:"ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ"}
      ]);
      populateSelect($("persona"), [
        {key:"user_calm",label:"åˆ©ç”¨è€…ï¼šç©ã‚„ã‹"},
        {key:"user_angry",label:"åˆ©ç”¨è€…ï¼šæ€’ã‚Š"},
        {key:"dementia",label:"åˆ©ç”¨è€…ï¼šå°‘ã—æ··ä¹±"},
        {key:"family_anxious",label:"å®¶æ—ï¼šä¸å®‰"},
        {key:"family_complaint",label:"å®¶æ—ï¼šã‚¯ãƒ¬ãƒ¼ãƒ "}
      ]);
      populateSelect($("category"), [{key:"free",label:"è‡ªç”±å…¥åŠ›"}]);
      populateSelect($("level"), [
        {key:"all",label:"å…¨ã¦"},
        {key:"beginner",label:"åˆç´š"},
        {key:"intermediate",label:"ä¸­ç´š"},
        {key:"field",label:"ç¾å ´å³å¿œ"}
      ]);
      $("level").value = (APP.default_level || "all");
      // Apply defaults for scene/persona (if options contain them)
      if(APP.default_scene && Array.from($("scene").options).some(o=>o.value===APP.default_scene)) $("scene").value = APP.default_scene;
      if(APP.default_persona && Array.from($("persona").options).some(o=>o.value===APP.default_persona)) $("persona").value = APP.default_persona;
      
      return null;
    }
  }

  // âœ… ã“ã“ãŒä»Šå›ã®å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆï¼š
  // sceneÃ—persona ã§ã€Œå®Ÿéš›ã«ä¾‹æ–‡ãŒå­˜åœ¨ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã ã‘ã€è¡¨ç¤ºã™ã‚‹
  function refreshCategories(){
    if(!EX){
      populateSelect($("category"), [{key:"free",label:"è‡ªç”±å…¥åŠ›"}]);
      populateSelect($("level"), [
        {key:"all",label:"å…¨ã¦"},
        {key:"beginner",label:"åˆç´š"},
        {key:"intermediate",label:"ä¸­ç´š"},
        {key:"field",label:"ç¾å ´å³å¿œ"}
      ]);
      $("level").value = (APP.default_level || "all");
      // Apply defaults for scene/persona (if options contain them)
      if(APP.default_scene && Array.from($("scene").options).some(o=>o.value===APP.default_scene)) $("scene").value = APP.default_scene;
      if(APP.default_persona && Array.from($("persona").options).some(o=>o.value===APP.default_persona)) $("persona").value = APP.default_persona;
      
      return;
    }
    const { db, root } = EX;
    const scene = $("scene").value;
    const persona = $("persona").value;

    // A) ã¾ãšã€Œsceneã«å®šç¾©ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼ˆkey/labelï¼‰ã€ã‚’ä½œã‚‹
    let definedCats = [];
    if(db.scenes && typeof db.scenes === "object" && !Array.isArray(db.scenes) && Array.isArray(db.scenes[scene])){
      definedCats = db.scenes[scene]
        .map(it => ({ key: (it.key ?? it.value ?? it.id), label: (it.label ?? it.name ?? (it.key ?? it.value ?? it.id) ?? "") }))
        .filter(x=>x.key);
    } else {
      // fallback: infer by keys in examples root
      definedCats = Object.keys((root && root[scene] && root[scene][persona]) || {}).map(c=>({key:c,label:c}));
    }

    // B) æ¬¡ã«ã€Œã“ã®sceneÃ—personaã§ä¾‹æ–‡ãŒã‚ã‚‹ã‚«ãƒ†ã‚´ãƒªã€ã ã‘ã«çµã‚‹
    const availableKeys = new Set(Object.keys((root && root[scene] && root[scene][persona]) || {}));
    const filtered = definedCats.filter(c => availableKeys.has(c.key));

    // C) filteredãŒç©ºãªã‚‰ã€ä¾‹æ–‡ã®ã‚­ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ã†ï¼ˆä¿é™ºï¼‰
    const fallbackCats = Object.keys((root && root[scene] && root[scene][persona]) || {}).map(c=>({key:c,label:c}));
    const finalCats = (filtered.length ? filtered : (fallbackCats.length ? fallbackCats : [{key:"free",label:"è‡ªç”±å…¥åŠ›"}]));

    // selectionç¶­æŒï¼ˆå¯èƒ½ãªã‚‰ï¼‰
    const prev = $("category").value;
    populateSelect($("category"), finalCats);
    if(prev && finalCats.some(x=>x.key===prev)) $("category").value = prev;
  }

  function getNextExample(){
    if(!EX) return null;

    const { root } = EX;
    const scene = $("scene").value;
    const persona = $("persona").value;
    const cat = $("category").value;
    const level = ($("level") && $("level").value) ? $("level").value : "all";
    const catKey = cat + "::" + level;

    const list = getExampleList(root, scene, persona, cat);
    if(!list.length) return null;

    ensureCounter(scene, persona, catKey);
    const i = counters[scene][persona][catKey] % list.length;
    counters[scene][persona][catKey] = counters[scene][persona][catKey] + 1;
    return list[i];
  }

  async function fillExample(){
    await loadExamples();
    const ex = getNextExample();
    if(!ex){
      setStatus("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªç”±å…¥åŠ›ã§ç¶šã‘ã¾ã—ã‚‡ã†ã€‚");
      showNoExampleHint(true);
      return;
    }
    $("prompt").value = ex.jp;
    showNoExampleHint(false);
    const levelLabelMap = { beginner:"åˆç´š", intermediate:"ä¸­ç´š", field:"ç¾å ´å³å¿œ", all:"å…¨ã¦" };
    const lv = ex.level || (($("level")&&$("level").value) ? $("level").value : "beginner");
    setStatus("ä¾‹æ–‡ã‚’å…¥åŠ›ã—ã¾ã—ãŸï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰ / ãƒ¬ãƒ™ãƒ«: " + (levelLabelMap[lv] || lv));
  }

  // -----------------------
  // Main actions
  // -----------------------
  async function runAll(){
    if(busy) return;

    const jp = $("prompt").value.trim();
    if(!jp){ setStatus("å…¥åŠ›ãŒç©ºã§ã™"); return; }

    setBusy(true);
    setStatus("ä»‹è­·å£«ç™ºè©±ã‚’ãƒ­ãƒ¼ãƒå­—åŒ–â€¦");

    try{
      clearOutputs();

      const r0 = await postChat({ prompt: jp, meta: meta(2) });
      $("caregiverRomaji").textContent = r0.romaji || "";

      setStatus("Stage1 å®Ÿè¡Œä¸­â€¦");
      const s1 = await postChat({ prompt: jp, meta: meta(1) });
      $("aiReply").textContent = s1.ai_reply_jp || "";
      $("feedback").textContent = s1.feedback_jp || "";
      $("suggestedJp").value = s1.suggested_reply_jp || "";

      if($("autoStage2").checked){
        await runStage2Only();
      } else {
        setStatus("Stage1 å®Œäº†ï¼ˆStage2ã¯æ‰‹å‹•ï¼‰");
      }
    } catch(e){
      if(e?.name === "AbortError") return;
      setStatus("ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
    } finally {
      setBusy(false);
    }
  }

  async function runStage2Only(){
    const suggested = $("suggestedJp").value.trim();
    if(!suggested){
      setStatus("Stage2: æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰ãŒç©ºã§ã™");
      return;
    }
    setStatus("Stage2 å®Ÿè¡Œä¸­â€¦");
    const s2 = await postChat({ prompt: suggested, meta: meta(2) });
    $("romaji").textContent = s2.romaji || "";
    $("indonesian").textContent = s2.indonesian || "";
    setStatus("å®Œäº†");
  }

  // Events
  $("fillExample").addEventListener("click", ()=>fillExample().catch(e=>setStatus("ä¾‹æ–‡ã‚¨ãƒ©ãƒ¼: "+e.message)));
  $("sendBtn").addEventListener("click", runAll);
  $("runStage2").addEventListener("click", ()=>runStage2Only().catch(e=>setStatus("Stage2ã‚¨ãƒ©ãƒ¼: "+e.message)));

  $("scene").addEventListener("change", ()=>{ if(EX) refreshCategories(); clearOutputs(); showNoExampleHint(false);
    setStatus("Sceneå¤‰æ›´ï¼šä¾‹æ–‡orå…¥åŠ›â†’é€ä¿¡"); });
  $("persona").addEventListener("change", ()=>{ if(EX) refreshCategories(); clearOutputs(); showNoExampleHint(false);
    setStatus("Personaå¤‰æ›´ï¼šä¾‹æ–‡orå…¥åŠ›â†’é€ä¿¡"); });
  $("category").addEventListener("change", ()=>{ resetCounter($("scene").value, $("persona").value, $("category").value + "::" + (($("level")&&$("level").value)?$("level").value:"all")); clearOutputs(); showNoExampleHint(false);
    setStatus("ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ï¼šä¾‹æ–‡ã¯æœ€åˆã‹ã‚‰ï¼ˆã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰"); });

  $("level").addEventListener("change", ()=>{
    // Level change resets cycling within that level
    resetCounter($("scene").value, $("persona").value, $("category").value + "::" + (($("level")&&$("level").value)?$("level").value:"all"));
    clearOutputs();
    showNoExampleHint(false);
    const levelLabelMap = { beginner:"åˆç´š", intermediate:"ä¸­ç´š", field:"ç¾å ´å³å¿œ", all:"å…¨ã¦" };
    setStatus("ãƒ¬ãƒ™ãƒ«å¤‰æ›´ï¼š " + (levelLabelMap[$("level").value] || $("level").value) + "ï¼ˆä¾‹æ–‡ã¯æœ€åˆã‹ã‚‰ï¼‰");
  });
loadConfig().then(()=> loadExamples()).then(()=>{ if(EX) refreshCategories(); updateTrialUI(); });

  // Unlock code UI
  $("unlockBtn")?.addEventListener("click", (e)=>{ e.preventDefault(); tryUnlock(); });
  $("unlockClearBtn")?.addEventListener("click", (e)=>{ e.preventDefault(); resetUnlock(); });
// --- Stripe checkout (A: è‡ªå‹•è§£é™¤) ---
async function startStripeCheckout(){
  try{
    if(!APP || !APP.variant){ alert("variantãŒæœªè¨­å®šã§ã™"); return; }
    const btn = document.getElementById("paywallBtn");
    const note = document.getElementById("paywallNote");
    if(btn){ btn.disabled = true; btn.textContent = "Stripeã¸ç§»å‹•ä¸­..."; }
    if(note){ note.textContent = ""; }
    const resp = await fetch("/api/create-checkout-session",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ variant: APP.variant })
    });
    const data = await resp.json().catch(()=> ({}));
    if(!resp.ok || !data.url){
      const msg = data.error || "checkoutã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ";
      if(note){ note.textContent = msg; }
      if(btn){ btn.disabled = false; btn.textContent = "Stripeã§æ±ºæ¸ˆã—ã¦æœ¬æ ¼åˆ©ç”¨"; }
      return;
    }
    location.href = data.url;
  }catch(e){
    console.error(e);
    const note = document.getElementById("paywallNote");
    const btn = document.getElementById("paywallBtn");
    if(note){ note.textContent = "Stripeé€£æºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; }
    if(btn){ btn.disabled = false; btn.textContent = "Stripeã§æ±ºæ¸ˆã—ã¦æœ¬æ ¼åˆ©ç”¨"; }
  }
}

async function checkStripeSuccessOnLoad(){
  try{
    const qs = new URLSearchParams(location.search);
    const success = qs.get("success");
    const sessionId = qs.get("session_id");
    if(success !== "1" || !sessionId) return;

    const msg = document.getElementById("unlockMsg");
    if(msg){ msg.textContent = "æ±ºæ¸ˆã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."; }

    const v = (APP && APP.variant) ? APP.variant : "";
    const resp = await fetch(`/api/verify-session?session_id=${encodeURIComponent(sessionId)}&variant=${encodeURIComponent(v)}`);
    const data = await resp.json().catch(()=> ({}));

    if(resp.ok && data.paid){
      // paidãƒ•ãƒ©ã‚°ï¼ˆvariantåˆ¥ï¼‰
      localStorage.setItem(`kaigo_paid_${v}`, "1");
      if(msg){ msg.textContent = "æ±ºæ¸ˆç¢ºèªOKï¼šæœ¬æ ¼åˆ©ç”¨ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚"; }
      // URLã‚’ç¶ºéº—ã«
      history.replaceState({}, "", location.pathname);
      // UIæ›´æ–°
      if(typeof updateTrialUI === "function") updateTrialUI();
    }else{
      if(msg){ msg.textContent = "æ±ºæ¸ˆã®ç¢ºèªãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"; }
    }
  }catch(e){
    console.error(e);
  }
}

// paywallãƒœã‚¿ãƒ³ã‚’æ¥ç¶š
document.addEventListener("DOMContentLoaded", ()=>{
  const btn = document.getElementById("paywallBtn");
  if(btn) btn.addEventListener("click", startStripeCheckout);
  checkStripeSuccessOnLoad();
});

// ===== TTS (Web Speech API) =====
function ttsSupported(){
  return typeof window !== "undefined" && "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
}
function pickVoice(langCode){
  const voices = speechSynthesis.getVoices();
  return voices.find(v=>v.lang===langCode) || null;
}
function getTextFrom(el){
  if(!el) return "";
  if(typeof el.value === "string") return el.value;
  return (el.textContent || "").trim();
}
function speakText(text, lang, exForTts){
  if(!ttsSupported()){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ï¼ˆTTSï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edgeã§ãŠè©¦ã—ãã ã•ã„ã€‚");
    return;
  }
  const t = (text || "").trim();
  if(!t){
    alert("èª­ã¿ä¸Šã’ã‚‹æ–‡ç« ãŒç©ºã§ã™ã€‚
ãƒ»å…ˆã«ã€Œä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹ã€ã‚’æŠ¼ã™
ãƒ»ã¾ãŸã¯ Stage2 ã‚’å®Ÿè¡Œã—ã¦æ–‡ç« ã‚’è¡¨ç¤º
ã—ã¦ã‹ã‚‰ ğŸ”Š ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const u = new SpeechSynthesisUtterance(t);
  const langCode = (lang==="id") ? "id-ID" : "ja-JP";
  u.lang = langCode;

  // Prefer per-language config from examples.v2.json if available
  const cfg = exForTts?.tts_lang?.[lang] || exForTts?.tts || null;
  if(cfg?.speech_rate) u.rate = cfg.speech_rate;
  else u.rate = (lang==="id") ? 0.9 : 1.0;

  const v = pickVoice(langCode);
  if(v) u.voice = v;

  // reset any stuck queue
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function currentExampleSafe(){
  return window.currentExample || null;
}
// voices load async in some browsers
if (ttsSupported() && speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = () => {};
}
// ===== Button bindings =====
document.addEventListener("click",(e)=>{
  const id = e.target?.id;
  const ex = currentExampleSafe();

  if(id==="btnSpeakTest"){
    speakText("ãƒ†ã‚¹ãƒˆã§ã™ã€‚éŸ³ãŒèã“ãˆã¾ã™ã‹ã€‚","ja",ex);
  }

  // Example speak: if example exists use it, otherwise speak prompt text
  if(id==="btnSpeakExampleJa"){
    const t = ex?.text?.ja || ex?.jp || getTextFrom(document.getElementById("prompt"));
    speakText(t,"ja",ex);
  }
  if(id==="btnSpeakExampleId"){
    const t = ex?.text?.id || ex?.id || getTextFrom(document.getElementById("prompt"));
    speakText(t,"id",ex);
  }

  // Stage2 speak: speak whatever is displayed (textarea or div)
  if(id==="btnSpeakStage2Romaji"){
    const t = getTextFrom(document.getElementById("romaji"));
    speakText(t,"ja",ex);
  }
  if(id==="btnSpeakStage2Id"){
    const t = getTextFrom(document.getElementById("indonesian"));
    speakText(t,"id",ex);
  }
});

</script>
</body>
</html>
