<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>介護ロールプレイAI</title>
<style>
body{font-family:system-ui;margin:16px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,textarea,button{font-size:14px}
textarea{width:100%;min-height:90px}
button{padding:6px 12px;border-radius:8px}
.card{border:1px solid #ddd;border-radius:10px;padding:10px;margin-top:10px}
.muted{color:#666;font-size:12px}
</style>
</head>
<body>

<h2>介護ロールプレイAI</h2>

<div class="row">
  Scene <select id="scene"></select>
  Persona <select id="persona"></select>
  カテゴリ <select id="category"></select>
  レベル <select id="level"></select>
  <button id="fillExample">例文を入れる</button>
</div>

<p class="muted" id="status">loading…</p>

<textarea id="prompt" placeholder="ここに例文が入ります"></textarea>

<div class="card">
<b>Stage2</b><br>
ローマ字<br><pre id="romaji"></pre>
インドネシア語<br><pre id="indonesian"></pre>
</div>

<script>
const $=id=>document.getElementById(id);
let db=null,list=[],idx=-1;

async function load(){
  const r=await fetch("./examples.v2.json",{cache:"no-store"});
  db=await r.json();
  init();
}

function init(){
  const items=db.examples||[];
  fill($("scene"), uniq(items.map(x=>x.category)));
  fill($("persona"), uniq(items.map(x=>x.persona)));
  fill($("level"), uniq(items.map(x=>x.level)));
  rebuildSub();
  $("scene").onchange=rebuildSub;
}

function fill(sel,arr){
  sel.innerHTML="<option value=''>全て</option>";
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=o.textContent=v; sel.appendChild(o);
  });
}

function uniq(a){return [...new Set(a.filter(Boolean))];}

function rebuildSub(){
  const s=$("scene").value;
  const subs=uniq((db.examples||[])
    .filter(x=>!s||x.category===s)
    .map(x=>x.subscene));
  fill($("category"),subs);
}

function filter(){
  return (db.examples||[]).filter(x=>
    (!$("scene").value||x.category===$("scene").value)&&
    (!$("persona").value||x.persona===$("persona").value)&&
    (!$("category").value||x.subscene===$("category").value)&&
    (!$("level").value||x.level===$("level").value)
  );
}

$("fillExample").onclick=()=>{
  list=filter();
  if(!list.length){
    $("status").textContent="該当例文なし（条件を変えてください）";
    return;
  }
  idx=(idx+1)%list.length;
  const ex=list[idx];
  $("prompt").value=ex.text?.ja||"";
  $("romaji").textContent=ex.romaji||"";
  $("indonesian").textContent=ex.text?.id||"";
  $("status").textContent=`例文 ${idx+1}/${list.length}`;
};

load();
</script>
</body>
</html>
