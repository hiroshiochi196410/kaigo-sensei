<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AIï¼ˆæ—¥æœ¬èªÃ—ãƒ­ãƒ¼ãƒå­—Ã—ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --bd:#e5e7eb; --txt:#111827; --muted:#6b7280;
      --btn:#111827; --btnTxt:#fff; --btn2:#f3f4f6;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
    header{ padding:14px 16px; border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:5;}
    header h1{ margin:0; font-size:18px; }
    header .sub{ margin-top:4px; color:var(--muted); font-size:12px;}
    main{ max-width:980px; margin:0 auto; padding:14px 12px 70px;}
    .grid{ display:grid; gap:10px; }
    @media(min-width:900px){ .grid{ grid-template-columns: 360px 1fr; align-items:start; } }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:12px; box-shadow: 0 1px 0 rgba(0,0,0,.02);}
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    select, textarea, input[type="text"]{ width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; font-size:14px; background:#fff;}
    textarea{ min-height:92px; resize: vertical;}
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    button{ border:1px solid var(--bd); background:var(--btn2); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; }
    button.primary{ background:var(--btn); color:var(--btnTxt); border-color:var(--btn); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--bd); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); background:#fff;}
    .history{ display:flex; flex-direction:column; gap:10px; }
    .msg{ border:1px solid var(--bd); border-radius:12px; padding:10px; background:#fff; }
    .msg .who{ font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:8px;}
    .msg .tri{ margin-top:8px; display:grid; gap:8px;}
    .tri .line{ padding:8px; border:1px dashed var(--bd); border-radius:10px; }
    .tri .k{ font-size:11px; color:var(--muted); margin-bottom:4px;}
    .tri .v{ white-space:pre-wrap; font-size:14px; }
    .small{ font-size:12px; color:var(--muted); }
    .err{ color:#b91c1c; font-size:12px; white-space:pre-wrap; }
    .ok{ color:#065f46; font-size:12px; }
    .split{ display:grid; gap:10px; }
    @media(min-width:900px){ .split{ grid-template-columns: 1fr 1fr; } }
    .lock{ position:fixed; inset:0; background:rgba(17,24,39,.65); display:none; align-items:center; justify-content:center; padding:14px; z-index:99;}
    .lock .panel{ width:min(560px, 100%); background:#fff; border-radius:14px; padding:14px; border:1px solid var(--bd);}
    .lock h2{ margin:0 0 6px; font-size:18px;}
    .lock p{ margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.5;}
    .lock .codeRow{ display:flex; gap:8px; margin-top:10px;}
    .lock .codeRow input{ flex:1; }
    .footerBar{ position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--bd); background:#fff; padding:10px 12px; z-index:10;}
    .footerBar .wrap{ max-width:980px; margin:0 auto; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  
    /* ===== TTS / highlight / stats ===== */
    .kRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .kBtns{ display:flex; gap:6px; }
    .ttsBtn{ border:1px solid var(--bd); background:#fff; padding:4px 8px; border-radius:999px; font-size:12px; cursor:pointer; }
    .ttsBtn:active{ transform: translateY(1px); }
    mark.hlDanger{ background:#ffe4e6; padding:0 2px; border-radius:6px; }
    mark.hlKeigo{ background:#dbeafe; padding:0 2px; border-radius:6px; }
    .annoList{ margin:0; padding-left:18px; }
    .annoList li{ margin:4px 0; }
    .statRow{ display:grid; grid-template-columns: 72px 1fr 52px; gap:8px; align-items:center; margin:6px 0; }
    .statBar{ height:10px; border:1px solid var(--bd); border-radius:999px; background:#fff; overflow:hidden; }
    .statFill{ height:100%; background:#111827; width:0%; }
    .statVal{ text-align:right; font-variant-numeric: tabular-nums; }

  
/* --- plan choice (Light/PRO) --- */
.planChoice{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px}
.planOpt{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:#fff}
.planOpt input{margin:0}
.planName{font-weight:700}
.planPrice{color:var(--muted); font-size:12px}

</style>
</head>
<body>
  <header>
    <h1>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI <span class="pill" id="variantPill">variant</span></h1>
    <div class="sub">æ—¥æœ¬èªï¼ˆã²ã‚‰ãŒãªï¼‰ãƒ»ãƒ­ãƒ¼ãƒå­—ãƒ»ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã®3æ®µè¡¨ç¤ºã§ã€ä»‹è­·ç¾å ´ã®ä¼šè©±ç·´ç¿’ã€‚</div>
  </header>

  <main class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>ã‚·ãƒ¼ãƒ³</label>
          <select id="sceneSel"></select>
        </div>
        <div>
          <label>ç›¸æ‰‹ï¼ˆãƒšãƒ«ã‚½ãƒŠï¼‰</label>
          <select id="personaSel"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="catSel"></select>
        </div>
        <div>
          <label>ãƒ¬ãƒ™ãƒ«</label>
          <select id="levelSel">
            <option value="beginner">åˆç´š</option>
            <option value="intermediate">ä¸­ç´š</option>
            <option value="advanced">ä¸Šç´š</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>å…¥åŠ›è¨€èª</label>
          <select id="langSel">
            <option value="auto">è‡ªå‹•åˆ¤å®š</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="id">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</option>
          </select>
        </div>
        <div>
          <label>è¡¨ç¤º</label>
          <select id="displayMode">
            <option value="all">3æ®µï¼ˆæ¨å¥¨ï¼‰</option>
            <option value="ja">æ—¥æœ¬èªã®ã¿</option>
            <option value="id">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã®ã¿</option>
            <option value="roma">ãƒ­ãƒ¼ãƒå­—ã®ã¿</option>
          </select>
        </div>
      </div>


      <div class="row" style="margin-top:10px;">
        <div>
          <label>é¸æŠè‚¢ã®è¡¨ç¤ºï¼ˆUIï¼‰</label>
          <select id="uiLabelMode">
            <option value="jp_id">æ—¥æœ¬èªï¼‹IDï¼ˆæ¨å¥¨ï¼‰</option>
            <option value="jp">æ—¥æœ¬èªã®ã¿</option>
            <option value="id">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã®ã¿</option>
          </select>
        </div>
        <div>
          <label>æ¯å›½èªï¼ˆè¡¨ç¤ºï¼‰</label>
          <input type="text" value="ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª" disabled />
        </div>
      </div>


      <div class="row" style="margin-top:10px;">
        <div>
          <label>éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆTTSï¼‰</label>
          <select id="ttsSel">
            <option value="off">OFF</option>
            <option value="hira" selected>ã²ã‚‰ãŒãª</option>
            <option value="roma">ãƒ­ãƒ¼ãƒå­—</option>
            <option value="both">ä¸¡æ–¹</option>
          </select>
        </div>
        <div>
          <label>é€Ÿåº¦</label>
          <select id="ttsRate">
            <option value="0.8">ã‚†ã£ãã‚Š</option>
            <option value="1" selected>ãµã¤ã†</option>
            <option value="1.2">ã¯ã‚„ã‚</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>è‡ªå‹•èª­ã¿ä¸Šã’</label>
          <select id="ttsAuto">
            <option value="off" selected>OFF</option>
            <option value="ai">AIã®è¿”äº‹ã ã‘</option>
            <option value="both">ã‚ãªãŸï¼‹AI</option>
          </select>
        </div>
        <div>
          <label>èª­ã¿ä¸Šã’åœæ­¢</label>
          <button id="btnStopTts" type="button">åœæ­¢</button>
        </div>
      </div>

      <div class="btnRow">
        <button id="btnExample" type="button">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
        <button id="btnClear" type="button">å±¥æ­´ã‚¯ãƒªã‚¢</button>
      </div>

      <div style="margin-top:10px;">
        <label>ã‚ãªãŸã®ç™ºè©±ï¼ˆæ—¥æœ¬èª or ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</label>
        <textarea id="userInput" placeholder="ä¾‹ï¼šã‚†ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€‚ / Pelan-pelan saja ya."></textarea>
        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">é€ä¿¡</button>
          <span class="small" id="trialInfo"></span>
        </div>
        <div class="err" id="errBox" style="display:none;"></div>
        <div class="ok" id="okBox" style="display:none;"></div>
      </div>

      <div style="margin-top:10px;" class="split">
        <div class="card" style="margin:0;">
          <label>AIã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ—¥æœ¬èªï¼‰</label>
          <div id="feedbackBox" class="small" style="white-space:pre-wrap;">â€”</div>
        </div>
        <div class="card" style="margin:0;">
          <label>æ¬¡ã«è¨€ã†ã¨è‰¯ã„ä¸€è¨€ï¼ˆ3æ®µï¼‰</label>
          <div id="suggestBox" class="small" style="white-space:pre-wrap;">â€”</div>
          <div class="btnRow" style="margin-top:8px;">
            <button class="ttsBtn" id="btnSpeakSuggestHira" type="button">â–¶ ã²ã‚‰ãŒãª</button>
            <button class="ttsBtn" id="btnSpeakSuggestRoma" type="button">â–¶ ãƒ­ãƒ¼ãƒå­—</button>
          </div>

        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <label>æ³¨é‡ˆï¼ˆå±é™ºãƒ¯ãƒ¼ãƒ‰ï¼æ•¬èªãƒã‚¤ãƒ³ãƒˆï¼‰</label>
        <div id="annoBox" class="small" style="white-space:pre-wrap;">â€”</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="align-items:center;">
        <div class="pill">ä¼šè©±å±¥æ­´</div>
        <div class="small" id="statusPill" style="margin-left:auto;">æº–å‚™ä¸­â€¦</div>
      </div>
      
      <div class="card" style="margin:10px 0;">
        <div class="row" style="align-items:center;">
          <div class="pill">å­¦ç¿’ãƒ­ã‚°</div>
          <button id="btnResetLog" type="button" style="margin-left:auto;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="logBox" class="small">â€”</div>
      </div>

<div class="history" id="history"></div>
    </section>
  </main>

  <div class="footerBar">
    <div class="wrap">
      <div class="small">Tip: æ—¥æœ¬èªã¯ã€Œã²ã‚‰ãŒãªã€ã«ã‚‚ã—ã¦å‡ºã™ã®ã§ã€èª­ã¿ä¸Šã’ç·´ç¿’ã«ä½¿ãˆã¾ã™ã€‚</div>
      <div class="small mono" id="apiState">api: /api/chat</div>
    </div>
  </div>

  <!-- Paywall -->
  <div class="lock" id="lock">
    <div class="panel">
      <h2>ãŠè©¦ã—å›æ•°ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ</h2>
      <p>ç¶šãã¯æœ‰æ–™ï¼ˆStripeï¼‰ã§è§£é™¤ã§ãã¾ã™ã€‚<br>ã‚‚ã—ãã¯ç®¡ç†è€…ç”¨ã®è§£é™¤ã‚³ãƒ¼ãƒ‰ã§ã‚‚è§£é™¤ã§ãã¾ã™ã€‚</p>
    <div class="planChoice">
      <label class="planOpt">
        <input type="radio" name="plan" value="light">
        <span class="planName">ãƒ©ã‚¤ãƒˆ</span>
        <span class="planPrice">Â¥1,100/æœˆ</span>
      </label>
      <label class="planOpt">
        <input type="radio" name="plan" value="pro">
        <span class="planName">PRO</span>
        <span class="planPrice">Â¥1,980/æœˆ</span>
      </label>
    </div>

      <div class="btnRow">
        <button class="primary" id="btnPay">Stripeã§è³¼èª­ã—ã¦è§£é™¤</button>
        <button id="btnCloseLock">é–‰ã˜ã‚‹</button>
      </div>
      <div class="codeRow">
        <input type="text" id="unlockCode" placeholder="è§£é™¤ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
        <button id="btnUnlock">è§£é™¤</button>
      </div>
      <div class="small" id="lockMsg" style="margin-top:8px;"></div>
    </div>
  </div>

<script>
/* ========= helpers ========= */
const $ = (id) => document.getElementById(id);
const esc = (s) => (s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const ls = {
  get(k, d=null){ try{ const v=localStorage.getItem(k); return v==null?d:JSON.parse(v);}catch(e){return d;} },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};

// --- debug / toast ---
function showErr(msg){
  const el = $("errBox");
  if (!el) return;
  el.style.display = "block";
  el.textContent = String(msg || "");
}
function showOk(msg){
  const el = $("okBox");
  if (!el) return;
  el.style.display = "block";
  el.textContent = String(msg || "");
}
window.addEventListener("error", (e)=>{ try{ showErr("JSã‚¨ãƒ©ãƒ¼: " + (e.message||e.error||"")); }catch(_){ } });
window.addEventListener("unhandledrejection", (e)=>{ try{ showErr("Promiseã‚¨ãƒ©ãƒ¼: " + (e.reason?.message||e.reason||"")); }catch(_){ } });

const IS_IOS = /iP(hone|od|ad)/.test(navigator.userAgent);
let _ttsUnlocked = false;
function unlockTts(){
  if (_ttsUnlocked) return;
  if (!window.speechSynthesis) return;
  try{
    // iOS Safariã¯æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ä¸€åº¦ speak/resume ã‚’é€šã™ã¨å®‰å®šã—ã‚„ã™ã„
    window.speechSynthesis.resume?.();
    const u = new SpeechSynthesisUtterance(" ");
    u.volume = 0; // ç„¡éŸ³ã§è§£éŒ 
    u.onend = ()=>{ _ttsUnlocked = true; };
    u.onerror = ()=>{ _ttsUnlocked = true; };
    window.speechSynthesis.speak(u);
    // ã™ãæ­¢ã‚ã¦ã‚‚OKï¼ˆè§£éŒ ã ã‘ï¼‰
    window.speechSynthesis.cancel();
    _ttsUnlocked = true;
  }catch(e){
    _ttsUnlocked = true;
  }
}


function detectVariantFromPath(){
  const p = location.pathname || "/";
  const m = p.match(/\/app\/(trainee|ssw)(\/|$)/);
  return m ? m[1] : "trainee";
}

function detectLangAuto(text){
  // ã–ã£ãã‚Šï¼šã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ãŒå«ã¾ã‚Œã‚Œã° ja
  if (/[ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ ]/.test(text)) return "ja";
  // a-z ã®æ¯”ç‡ãŒé«˜ã‘ã‚Œã° id ã¨ã¿ãªã™ï¼ˆã–ã£ãã‚Šï¼‰
  if (/[a-zA-Z]/.test(text)) return "id";
  return "auto";
}

/* ========= TTS / annotation / stats helpers ========= */
const DEFAULT_SETTINGS = { ttsSel:"hira", ttsRate:"1", ttsAuto:"off", uiLabelMode:"jp_id" };
let _voices = [];
function refreshVoices(){
  try{ _voices = (window.speechSynthesis ? window.speechSynthesis.getVoices() : []) || []; }catch(e){ _voices=[]; }
}
if (window.speechSynthesis){
  refreshVoices();
  window.speechSynthesis.onvoiceschanged = refreshVoices;
}

function stopTts(){
  try{ if (window.speechSynthesis) window.speechSynthesis.cancel(); }catch(e){}
}

function pickVoice(langPrefix){
  if (!_voices || !_voices.length) refreshVoices();
  return (_voices || []).find(v => (v.lang || "").toLowerCase().startsWith(langPrefix.toLowerCase())) || null;
}

function speakOnce(text, lang="ja-JP"){
  const t = String(text || "").trim();
  if (!t) return;
  if (!window.speechSynthesis){ alert("ã“ã®ç«¯æœ«ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }

  // iOS Safariå¯¾ç­–ï¼šæœ€åˆã«è§£éŒ ã€cancelç›´å¾Œã¯å°‘ã—å¾…ã¤
  unlockTts();
  try{ window.speechSynthesis.resume?.(); }catch(e){}
  try{ window.speechSynthesis.cancel(); }catch(e){}

  const u = new SpeechSynthesisUtterance(t);
  u.lang = lang;

  const rate = Number($("ttsRate")?.value || 1);
  if (!Number.isNaN(rate)) u.rate = rate;

  const v = pickVoice(lang.split("-")[0]);
  if (v) u.voice = v;

  u.onstart = ()=>{ /*showOk("ğŸ”Š å†ç”Ÿä¸­â€¦");*/ };
  u.onerror = (ev)=>{ showErr("éŸ³å£°ã‚¨ãƒ©ãƒ¼: " + (ev?.error || "unknown")); };

  const doSpeak = ()=>{
    try{ window.speechSynthesis.resume?.(); }catch(e){}
    try{ window.speechSynthesis.speak(u); }catch(e){ showErr("éŸ³å£°ã‚¨ãƒ©ãƒ¼: " + (e.message||e)); }
  };

  if (IS_IOS) setTimeout(doSpeak, 150);
  else doSpeak();
}


function speakSequence(texts, lang="ja-JP"){
  const arr = (texts || []).map(x=>String(x||"").trim()).filter(Boolean);
  if (!arr.length) return;
  if (!window.speechSynthesis){ alert("ã“ã®ç«¯æœ«ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }

  unlockTts();
  try{ window.speechSynthesis.resume?.(); }catch(e){}
  try{ window.speechSynthesis.cancel(); }catch(e){}

  const rate = Number($("ttsRate")?.value || 1);
  const v = pickVoice(lang.split("-")[0]);
  let i = 0;

  const speakNext = ()=>{
    if (i >= arr.length) return;
    const u = new SpeechSynthesisUtterance(arr[i]);
    u.lang = lang;
    if (!Number.isNaN(rate)) u.rate = rate;
    if (v) u.voice = v;
    u.onerror = (ev)=>{ showErr("éŸ³å£°ã‚¨ãƒ©ãƒ¼: " + (ev?.error || "unknown")); };
    u.onend = ()=>{ i++; setTimeout(speakNext, IS_IOS ? 120 : 0); };

    const doSpeak = ()=>{
      try{ window.speechSynthesis.resume?.(); }catch(e){}
      try{ window.speechSynthesis.speak(u); }catch(e){ showErr("éŸ³å£°ã‚¨ãƒ©ãƒ¼: " + (e.message||e)); }
    };
    if (IS_IOS) setTimeout(doSpeak, 150);
    else doSpeak();
  };
  speakNext();
}


// å±é™ºãƒ¯ãƒ¼ãƒ‰ï¼ˆã²ã‚‰ãŒãªãƒ™ãƒ¼ã‚¹ï¼‰: å¿…è¦ãªã‚‰è¿½åŠ ã—ã¦OK
const DANGER_DICT = [
  { hira:"ã”ãˆã‚“", note:"èª¤åš¥ãƒªã‚¹ã‚¯ã€‚å§¿å‹¢ãƒ»ä¸€å£é‡ãƒ»ã‚€ã›ã‚’ç¢ºèªã€‚" },
  { hira:"ã‚€ã›", note:"ã‚€ã›ï¼ˆèª¤åš¥ã®ã‚µã‚¤ãƒ³ï¼‰ã€‚é£Ÿäº‹ã‚’æ­¢ã‚ã¦è½ã¡ç€ã‹ã›ã‚‹ã€‚" },
  { hira:"ã¦ã‚“ã¨ã†", note:"è»¢å€’ãƒªã‚¹ã‚¯ã€‚ç«‹ã¡ä¸ŠãŒã‚Šãƒ»ç§»ä¹—ã¯ä»‹åŠ©ã¨ç¢ºèªã€‚" },
  { hira:"ã“ã‚ã¶", note:"è»¢å€’ãƒªã‚¹ã‚¯ã€‚ã‚†ã£ãã‚Šå‹•ããƒ»è¦‹å®ˆã‚Šå¼·åŒ–ã€‚" },
  { hira:"ã™ã¹ã‚‹", note:"ã™ã¹ã‚Šï¼ˆè»¢å€’ï¼‰æ³¨æ„ã€‚åºŠã‚„è¶³å…ƒã‚’ç¢ºèªã€‚" },
  { hira:"ã¡ã£ãã", note:"çª’æ¯ã®å±é™ºã€‚ã™ãã«çœ‹è­·å¸«/ä¸Šå¸ã¸ã€‚" },
  { hira:"ã„ããŒãã‚‹ã—ã„", note:"å‘¼å¸è‹¦ã€‚ã™ãã«çœ‹è­·å¸«/ä¸Šå¸ã¸ã€‚" },
  { hira:"ã—ã‚…ã£ã‘ã¤", note:"å‡ºè¡€ã€‚çŠ¶æ…‹ç¢ºèªâ†’ä¸Šå¸­ã¸ã€‚" },
  { hira:"ã“ã£ã›ã¤", note:"éª¨æŠ˜ã®ç–‘ã„ã€‚å‹•ã‹ã•ãšå ±å‘Šã€‚" }
];

const KEIGO_DICT = [
  { hira:"ãã ã•ã„", note:"ä¸å¯§ãªä¾é ¼ï¼ˆã€œã—ã¦ãã ã•ã„ï¼‰ã€‚" },
  { hira:"ãŠã­ãŒã„ã—ã¾ã™", note:"ä¸å¯§ãªä¾é ¼ï¼ˆãŠé¡˜ã„ã—ã¾ã™ï¼‰ã€‚" },
  { hira:"ã„ãŸã ã‘ã¾ã™ã‹", note:"ã‚ˆã‚Šä¸å¯§ãªä¾é ¼ï¼ˆã€œã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼‰ã€‚" },
  { hira:"ã„ãŸã—ã¾ã™", note:"ä¸å¯§ãªè¡¨ç¾ï¼ˆã€œã„ãŸã—ã¾ã™ï¼‰ã€‚" },
  { hira:"ã§ã—ã‚‡ã†ã‹", note:"ä¸å¯§ãªç¢ºèªï¼ˆã€œã§ã—ã‚‡ã†ã‹ï¼‰ã€‚" },
  { hira:"ã™ã¿ã¾ã›ã‚“", note:"é…æ…®ã®ã‚¯ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã™ã¿ã¾ã›ã‚“ï¼‰ã€‚" }
];

function uniqSort(arr){
  return [...new Set((arr||[]).filter(Boolean))].sort((a,b)=>String(b).length-String(a).length);
}

function heuristicAnnotations(tri){
  const hira = String(tri?.hira || tri?.jp || "");
  const danger = [];
  for (const d of DANGER_DICT){
    if (hira.includes(d.hira)) danger.push({ hira: d.hira, level:"high", note_jp: d.note });
  }
  const keigo = [];
  for (const k of KEIGO_DICT){
    if (hira.includes(k.hira)) keigo.push({ phrase_hira: k.hira, note_jp: k.note });
  }
  return { danger_words: danger.slice(0,5), keigo_points: keigo.slice(0,5), vocab: [] };
}

function normalizeAnnotations(ann, tri){
  // AIãŒè¿”ã•ãªã„å ´åˆã¯ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§è£œã†
  const base = ann && typeof ann === "object" ? ann : heuristicAnnotations(tri || {});
  base.danger_words = Array.isArray(base.danger_words) ? base.danger_words : [];
  base.keigo_points = Array.isArray(base.keigo_points) ? base.keigo_points : [];
  base.vocab = Array.isArray(base.vocab) ? base.vocab : [];
  return base;
}

function getHighlightsForAnn(ann, tri){
  const a = normalizeAnnotations(ann, tri || {});
  const danger = uniqSort(a.danger_words.map(x=>x.hira || x.word_hira || x.word || ""));
  const keigo = uniqSort(a.keigo_points.map(x=>x.phrase_hira || x.phrase || ""));
  // ãƒ­ãƒ¼ãƒå­—å´ã¯ã€å±é™º/æ•¬èªã®ã€Œãƒ­ãƒ¼ãƒå­—è¡¨è¨˜ã€ãŒã‚ã‚Œã°ä½¿ã†ï¼ˆãªã‘ã‚Œã°ç©ºï¼‰
  const dangerRoma = uniqSort(a.danger_words.map(x=>x.romaji || ""));
  const keigoRoma = uniqSort(a.keigo_points.map(x=>x.phrase_romaji || ""));
  return { danger, keigo, dangerRoma, keigoRoma };
}

function applyHighlights(text, dangerArr, keigoArr){
  let out = esc(String(text || ""));
  const danger = uniqSort(dangerArr || []);
  const keigo = uniqSort(keigoArr || []);
  for (const w of danger){
    const ew = esc(w);
    if (!ew) continue;
    out = out.split(ew).join(`<mark class="hlDanger">${ew}</mark>`);
  }
  for (const w of keigo){
    const ew = esc(w);
    if (!ew) continue;
    out = out.split(ew).join(`<mark class="hlKeigo">${ew}</mark>`);
  }
  return out;
}

function renderAnno(ann){
  const box = $("annoBox");
  if (!box) return;
  if (!ann){
    box.textContent = "â€”";
    return;
  }
  const danger = ann.danger_words || [];
  const keigo = ann.keigo_points || [];
  const vocab = ann.vocab || [];

  const parts = [];
  parts.push(`<div class="small"><b>å±é™ºãƒ¯ãƒ¼ãƒ‰</b></div>`);
  if (!danger.length){
    parts.push(`<div class="small">ãªã—</div>`);
  } else {
    parts.push(`<ul class="annoList">` + danger.map(d=>`<li><span class="mono">${esc(d.hira || "")}</span>ï¼š${esc(d.note_jp || "")}</li>`).join("") + `</ul>`);
  }

  parts.push(`<div class="small" style="margin-top:8px;"><b>æ•¬èªãƒã‚¤ãƒ³ãƒˆ</b></div>`);
  if (!keigo.length){
    parts.push(`<div class="small">ãªã—</div>`);
  } else {
    parts.push(`<ul class="annoList">` + keigo.map(k=>`<li><span class="mono">${esc(k.phrase_hira || "")}</span>ï¼š${esc(k.note_jp || "")}</li>`).join("") + `</ul>`);
  }

  if (vocab.length){
    parts.push(`<div class="small" style="margin-top:8px;"><b>è¦šãˆã‚‹å˜èª</b></div>`);
    parts.push(`<ul class="annoList">` + vocab.slice(0,6).map(v=>`<li>${esc(v.hira||"")}ï¼ˆ${esc(v.romaji||"")}ï¼‰ï¼š${esc(v.id||"")} <span class="small">${esc(v.note_jp||"")}</span></li>`).join("") + `</ul>`);
  }

  box.innerHTML = parts.join("");
}

// ===== stats (local) =====
function updateStats(scene, category, scoreVal){
  if (!scoreVal || scoreVal < 1 || scoreVal > 5) return;
  STATS.scenes = STATS.scenes || {};
  STATS.categories = STATS.categories || {};

  const s = STATS.scenes[scene] || { count:0, sum:0 };
  s.count += 1;
  s.sum += scoreVal;
  STATS.scenes[scene] = s;

  const c = STATS.categories[category] || { count:0, sum:0 };
  c.count += 1;
  c.sum += scoreVal;
  STATS.categories[category] = c;

  ls.set("aiga_stats_"+VARIANT, STATS);
}

function avgOf(obj){ return obj && obj.count ? (obj.sum / obj.count) : 0; }

function renderStats(){
  const box = $("logBox");
  if (!box) return;
  const sceneKeys = Object.keys(EX?.scenes || {});
  if (!sceneKeys.length){
    box.textContent = "â€”";
    return;
  }
  const rows = sceneKeys.map(k=>{
    const st = (STATS.scenes || {})[k] || {count:0, sum:0};
    const avg = avgOf(st);
    return { key:k, label:getSceneLabel(k), avg, count:st.count };
  });

  const practiced = rows.filter(r=>r.count>0);
  const weak = practiced.slice().sort((a,b)=>a.avg-b.avg)[0];

  const head = [];
  if (!practiced.length){
    head.push(`<div class="small">ã¾ã ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¼šè©±ã™ã‚‹ã¨è‡ªå‹•ã§è“„ç©ã—ã¾ã™ã€‚</div>`);
  } else {
    head.push(`<div class="small">å¼±ã„ã‚·ãƒ¼ãƒ³ï¼š<b>${esc(weak.label)}</b>ï¼ˆå¹³å‡ ${weak.avg.toFixed(1)}/5ã€å›æ•° ${weak.count}ï¼‰</div>`);
  }

  const body = rows.map(r=>{
    const pct = Math.max(0, Math.min(100, (r.avg/5)*100));
    return `
      <div class="statRow">
        <div class="small">${esc(r.label)}</div>
        <div class="statBar"><div class="statFill" style="width:${pct}%;"></div></div>
        <div class="statVal small">${r.count ? r.avg.toFixed(1) : "â€”"}</div>
      </div>
    `;
  }).join("");

  box.innerHTML = head.join("") + `<div style="margin-top:6px;">${body}</div>`;
}

function saveSettings(){
  SETTINGS = {
    ttsSel: $("ttsSel")?.value || "off",
    ttsRate: $("ttsRate")?.value || "1",
    ttsAuto: $("ttsAuto")?.value || "off",
    uiLabelMode: $("uiLabelMode")?.value || "jp_id"
  };
  ls.set("aiga_settings_"+VARIANT, SETTINGS);
}

function runAutoTts(userTri, aiTri){
  const mode = $("ttsAuto")?.value || "off";
  const ttsMode = $("ttsSel")?.value || "off";
  if (mode === "off" || ttsMode === "off") return;

  const userText = (ttsMode === "roma") ? (userTri?.romaji || "") : (userTri?.hira || "");
  const aiText = (ttsMode === "roma") ? (aiTri?.romaji || "") : (aiTri?.hira || "");

  if (mode === "both"){
    speakSequence([userText, aiText], "ja-JP");
  } else if (mode === "ai"){
    speakSequence([aiText], "ja-JP");
  }
}

function setStatus(msg){ $("statusPill").textContent = msg; }

/* ========= global state ========= */
let CFG = null;
let EX = null;
let VARIANT = detectVariantFromPath();

let SETTINGS = Object.assign({}, DEFAULT_SETTINGS, ls.get("aiga_settings_"+VARIANT, {}));
let STATS = ls.get("aiga_stats_"+VARIANT, { scenes:{}, categories:{} });

let lastSuggested = null;
let lastAi = null;
let lastAnnotations = null;

let history = ls.get("aiga_history_"+VARIANT, []);
let unlocked = ls.get("aiga_unlocked_"+VARIANT, false);
let trialUsed = ls.get("aiga_trialUsed_"+VARIANT, 0);

/* ========= load config/examples ========= */
async function loadJson(path){
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`${path} load failed: ${r.status}`);
  return await r.json();
}

function setTrialInfo(){
  const limit = CFG?.trial_limit ?? 3;
  const remain = Math.max(0, limit - trialUsed);
  $("trialInfo").textContent = unlocked ? "âœ… è§£é™¤æ¸ˆã¿" : `ãŠè©¦ã—æ®‹ã‚Š: ${remain}/${limit}`;
}

function maybeLock(){
  if (unlocked) return false;
  const limit = CFG?.trial_limit ?? 3;
  if (trialUsed >= limit){
    $("lock").style.display = "flex";
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ©ãƒ³ï¼ˆtrainee=light / ssw=proï¼‰
    const defPlan = (VARIANT === "ssw") ? "pro" : "light";
    const radio = document.querySelector(`input[name="plan"][value="${defPlan}"]`);
    if (radio && !document.querySelector(`input[name="plan"]:checked`)) radio.checked = true;

    return true;
  }
  return false;
}

/* ========= select population ========= */
function fillSelect(selectEl, items, getVal, getLabel){
  selectEl.innerHTML = "";
  for (const it of items){
    const opt = document.createElement("option");
    opt.value = getVal(it);
    opt.textContent = getLabel(it);
    selectEl.appendChild(opt);
  }
}


function uiMode(){
  return $("uiLabelMode")?.value || SETTINGS?.uiLabelMode || "jp_id";
}
function fmtLabel(jp, id){
  const mode = uiMode();
  const a = (jp || "").trim();
  const b = (id || "").trim();
  if (mode === "jp") return a || b || "";
  if (mode === "id") return b || a || "";
  if (a && b && a !== b) return `${a}ï¼ˆ${b}ï¼‰`;
  return a || b || "";
}

const FALLBACK_SCENE_LABELS = {
  bath:{ jp:"å…¥æµ´", id:"Mandi" },
  meal:{ jp:"é£Ÿäº‹", id:"Makan" },
  toilet:{ jp:"æ’æ³„", id:"Toilet" },
  night:{ jp:"å¤œé–“", id:"Malam" },
  complaint:{ jp:"ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ", id:"Keluhan" }
};
const FALLBACK_PERSONA_ID = {
  user_calm:"Pengguna: Tenang",
  user_angry:"Pengguna: Marah",
  dementia:"Pengguna: Bingung",
  family_anxious:"Keluarga: Cemas",
  family_complaint:"Keluarga: Keluhan"
};
const FALLBACK_CAT_ID = {
  bath:{ voice:"Menyapa", temperature:"Cek suhu", privacy:"Menjaga privasi", refusal:"Menangani penolakan", safety:"Keamanan" },
  meal:{ start:"Mulai/persiapan", swallow:"Menelan/tersedak", pace:"Atur tempo", refusal:"Penolakan/selera", safety:"Keamanan/pencegahan aspirasi" },
  toilet:{ urge:"Mengajak/menyapa", transfer:"Pindah/berdiri", privacy:"Menjaga privasi", accident:"Kecelakaan (inkontinensia)", hygiene:"Kebersihan" },
  night:{ sleep:"Tidur", anxiety:"Cemas", pain:"Nyeri", wander:"Berkeliaran", safety:"Keamanan" },
  complaint:{ apology:"Permintaan maaf", fact:"Konfirmasi fakta", plan:"Rencana tindak lanjut", escalate:"Eskalasi ke atasan", followup:"Tindak lanjut" }
};

function getSceneLabel(sceneKey){
  const o = (EX && EX.scene_labels && EX.scene_labels[sceneKey]) ? EX.scene_labels[sceneKey] : (FALLBACK_SCENE_LABELS[sceneKey] || {jp:sceneKey, id:sceneKey});
  return fmtLabel(o.jp || sceneKey, o.id || sceneKey);
}
function getPersonaLabelByKey(personaKey){
  const p = (EX?.personas || []).find(x=>x.key===personaKey);
  const jp = p?.label || personaKey;
  const id = p?.label_id || FALLBACK_PERSONA_ID[personaKey] || "";
  return fmtLabel(jp, id);
}
function getCategoryLabel(sceneKey, cat){
  const jp = cat?.label || cat?.key || "";
  const id = cat?.label_id || (FALLBACK_CAT_ID[sceneKey]?.[cat?.key] || "");
  return fmtLabel(jp, id);
}

function populate(){
  // scenes
  const sceneKeys = Object.keys(EX.scenes || {});
  fillSelect($("sceneSel"), sceneKeys, k=>k, k=>getSceneLabel(k));
  // personas
  fillSelect($("personaSel"), EX.personas || [], p=>p.key, p=>getPersonaLabelByKey(p.key));

  // defaults
  $("sceneSel").value = (CFG.default_scene || "meal");
  $("personaSel").value = (CFG.default_persona || "user_calm");
  $("levelSel").value = (CFG.default_level || "beginner");

  updateCategories();
}

function updateCategories(){
  const scene = $("sceneSel").value;
  const cats = EX.scenes?.[scene] || [];
  fillSelect($("catSel"), cats, c=>c.key, c=>getCategoryLabel(scene, c));
}

function rebuildSelectLabels(){
  const sceneVal = $("sceneSel")?.value;
  const personaVal = $("personaSel")?.value;
  const catVal = $("catSel")?.value;

  // scenes
  const sceneKeys = Object.keys(EX.scenes || {});
  fillSelect($("sceneSel"), sceneKeys, k=>k, k=>getSceneLabel(k));
  // personas
  fillSelect($("personaSel"), EX.personas || [], p=>p.key, p=>getPersonaLabelByKey(p.key));

  if (sceneVal) $("sceneSel").value = sceneVal;
  if (personaVal) $("personaSel").value = personaVal;

  updateCategories();
  if (catVal) $("catSel").value = catVal;
}

/* ========= examples ========= */
function pickExample(scene, persona, category, level){
  try{
    const arr = EX.examples?.[scene]?.[persona]?.[category] || [];
    const filtered = (level === "beginner") ? arr.filter(x=>x.level==="beginner") :
                     (level === "intermediate") ? arr.filter(x=>x.level==="intermediate") :
                     (level === "advanced") ? arr.filter(x=>x.level==="advanced") : arr;
    const pool = filtered.length ? filtered : arr;
    if (!pool.length) return null;
    return pool[Math.floor(Math.random()*pool.length)];
  }catch(e){ return null; }
}

function insertExample(){
  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;

  const ex = pickExample(scene, persona, category, level);
  if (!ex){
    $("userInput").value = "ã‚†ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€‚";
    return;
  }
  // æ—¥æœ¬èªä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹ï¼ˆãƒ­ãƒ¼ãƒå­—ã‚„IDã¯å±¥æ­´è¡¨ç¤ºå´ã§å‡ºã™ï¼‰
  $("userInput").value = ex.jp || "";
  $("okBox").style.display="block";
  $("okBox").textContent = "ä¾‹æ–‡ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚é€ä¿¡ã—ã¦ä¼šè©±ã‚’ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚";
  setTimeout(()=>{$("okBox").style.display="none";}, 1800);
}

/* ========= render ========= */
function triHtml(tri, opts = {}){
  const mode = $("displayMode").value;
  const idx = (typeof opts.idx === "number") ? opts.idx : -1;
  const ann = opts.ann || null;

  const ttsMode = ($("ttsSel")?.value || "off");
  const canHira = (ttsMode === "both" || ttsMode === "hira");
  const canRoma = (ttsMode === "both" || ttsMode === "roma");

  const hl = getHighlightsForAnn(ann, tri);
  const lines = [];

  const hiraText = tri?.hira || tri?.jp || "";
  const romaText = tri?.romaji || "";
  const idText = tri?.id || "";

  if (mode === "all" || mode === "ja"){
    lines.push(`
      <div class="line">
        <div class="kRow">
          <div class="k">æ—¥æœ¬èªï¼ˆã²ã‚‰ãŒãªï¼‰</div>
          <div class="kBtns">
            <button class="ttsBtn" type="button" data-idx="${idx}" data-field="hira" ${canHira ? "" : "disabled"} title="èª­ã¿ä¸Šã’">â–¶</button>
          </div>
        </div>
        <div class="v">${applyHighlights(hiraText, hl.danger, hl.keigo)}</div>
      </div>
    `);
  }
  if (mode === "all" || mode === "roma"){
    lines.push(`
      <div class="line">
        <div class="kRow">
          <div class="k">ãƒ­ãƒ¼ãƒå­—</div>
          <div class="kBtns">
            <button class="ttsBtn" type="button" data-idx="${idx}" data-field="romaji" ${canRoma ? "" : "disabled"} title="èª­ã¿ä¸Šã’">â–¶</button>
          </div>
        </div>
        <div class="v">${applyHighlights(romaText, hl.dangerRoma, hl.keigoRoma)}</div>
      </div>
    `);
  }
  if (mode === "all" || mode === "id"){
    lines.push(`
      <div class="line">
        <div class="k">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</div>
        <div class="v">${esc(idText)}</div>
      </div>
    `);
  }
  return `<div class="tri">${lines.join("")}</div>`;
}

function renderHistory(){
  const box = $("history");
  box.innerHTML = "";
  const items = history || [];
  if (!items.length){
    box.innerHTML = `<div class="small" style="padding:10px;">ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã§ä¾‹æ–‡â†’é€ä¿¡ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }
  items.forEach((it, i)=>{
    const div = document.createElement("div");
    div.className = "msg";
    const meta = it.meta || {};
    const title = it.role === "user" ? "ã‚ãªãŸ" : "AIï¼ˆåˆ©ç”¨è€…/å®¶æ—ï¼‰";
    const tag = `${getSceneLabel(meta.scene)} / ${getPersonaLabelByKey(meta.persona)} / ${getCategoryLabel(meta.scene, {key: meta.category, label: (EX?.scenes?.[meta.scene]||[]).find(x=>x.key===meta.category)?.label || meta.category, label_id: (EX?.scenes?.[meta.scene]||[]).find(x=>x.key===meta.category)?.label_id || ""})} / ${meta.level}`;
    div.innerHTML = `
      <div class="who">
        <span>${esc(title)}</span>
        <span class="mono">${esc(tag)}</span>
      </div>
      ${triHtml(it.tri, { idx:i, ann: it.ann || null })}
    `;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function setSuggestBox(tri){
  if (!tri){ $("suggestBox").textContent="â€”"; return; }
  const mode = $("displayMode").value;
  const parts=[];
  if (mode==="all" || mode==="ja") parts.push(`æ—¥æœ¬èªï¼ˆã²ã‚‰ãŒãªï¼‰:\n${tri.hira || tri.jp || ""}`);
  if (mode==="all" || mode==="roma") parts.push(`\nãƒ­ãƒ¼ãƒå­—:\n${tri.romaji || ""}`);
  if (mode==="all" || mode==="id") parts.push(`\nã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª:\n${tri.id || ""}`);
  $("suggestBox").textContent = parts.join("\n");
}

/* ========= API ========= */
async function postChat({ text, meta }){
  const r = await fetch("/api/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ prompt: text, meta })
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok) throw new Error(j?.error ? `${j.error}\n${JSON.stringify(j, null, 2)}` : `HTTP ${r.status}`);
  return j;
}

async function send(){
  $("errBox").style.display="none";
  $("okBox").style.display="none";

  if (maybeLock()) return;

  const text = $("userInput").value.trim();
  if (!text){ alert("å…¥åŠ›ãŒç©ºã§ã™"); return; }

  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;
  const langSel = $("langSel").value;
  const user_lang = (langSel === "auto") ? detectLangAuto(text) : langSel;

  // client-side history to help context (last 6 turns)
  const ctx = (history || []).slice(-6).map(x=>({
    role: x.role, hira: x.tri?.hira || "", romaji: x.tri?.romaji || "", id: x.tri?.id || ""
  }));

  $("btnSend").disabled = true;
  setStatus("AIå¿œç­”ä¸­â€¦");

  try{
    const meta = { stage: 3, scene, persona, category, level, user_lang, variant: VARIANT, ctx };
    const out = await postChat({ text, meta });

    // trial count
    if (!unlocked){
      trialUsed += 1;
      ls.set("aiga_trialUsed_"+VARIANT, trialUsed);
      setTrialInfo();
    }

    // annotations & score
    const ann = normalizeAnnotations(out.annotations || null, out.ai || {});
    const scoreVal = Number(out.score?.scene_skill || 0);

    lastAi = out.ai || null;
    lastSuggested = out.suggested || null;
    lastAnnotations = ann;

    // add to history: user + ai
    history.push({ role:"user", tri: out.user || {}, meta:{ scene, persona, category, level } });
    history.push({ role:"ai", tri: out.ai || {}, ann, score: out.score || null, meta:{ scene, persona, category, level } });

    // persist
    ls.set("aiga_history_"+VARIANT, history);

    // UI
    $("feedbackBox").textContent = out.feedback_jp || out.feedback || "â€”";
    setSuggestBox(out.suggested || null);
    renderAnno(ann);
    if (scoreVal > 0) updateStats(scene, category, scoreVal);
    renderStats();

    $("userInput").value = "";
    renderHistory();
    setStatus("å®Œäº†");
    $("okBox").style.display="block";
    $("okBox").textContent = "OKã€‚ç¶šã‘ã¦å…¥åŠ›ã§ãã¾ã™ã€‚";
    setTimeout(()=>{$("okBox").style.display="none";}, 1200);

    // auto TTS (optional)
    runAutoTts(out.user || null, out.ai || null);

    // lock if just reached limit
    maybeLock();
  }catch(e){
    $("errBox").style.display="block";
    $("errBox").textContent = String(e.message || e);
    setStatus("ã‚¨ãƒ©ãƒ¼");
  }finally{
    $("btnSend").disabled = false;
  }
}

/* ========= Stripe unlock ========= */
async function startCheckout() {
  const msg = $("lockMsg");
  const plan = document.querySelector('input[name="plan"]:checked')?.value || ((VARIANT === "ssw") ? "pro" : "light");

  msg.textContent = "Stripeã¸ç§»å‹•ã—ã¾ã™â€¦";
  msg.className = "muted";

  try {
    const r = await fetch("/api/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ plan, variant: VARIANT }) // variantã¯ãƒ­ã‚°ç”¨é€”ï¼ˆã‚µãƒ¼ãƒå´ã§ç„¡è¦–ã—ã¦OKï¼‰
    });

    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || "Checkoutä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    if (!data?.url) throw new Error("Checkout URL ãŒè¿”ã£ã¦ãã¾ã›ã‚“");

    location.href = data.url;
  } catch (e) {
    msg.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message + "\nï¼ˆplan ã¨ PRICE_ID ã®å¯¾å¿œã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    msg.className = "muted warn";
  }
}

async function verifyFromUrl(){
  const url = new URL(location.href);
  const sessionId = url.searchParams.get("session_id");
  const success = url.searchParams.get("success");
  if (!sessionId || success !== "1") return;

  setStatus("æ±ºæ¸ˆç¢ºèªä¸­â€¦");
  try{
    const r = await fetch(`/api/verify-session?session_id=${encodeURIComponent(sessionId)}`);
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error || "verify error");
    if (j.paid){
      unlocked = true;
      ls.set("aiga_unlocked_"+VARIANT, true);
      $("okBox").style.display="block";
      $("okBox").textContent = "âœ… è§£é™¤ã—ã¾ã—ãŸï¼ˆæ±ºæ¸ˆç¢ºèªæ¸ˆã¿ï¼‰";
      $("lock").style.display="none";
      setTrialInfo();
    }else{
      $("lockMsg").textContent = "æ±ºæ¸ˆã¯ã¾ã ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å°‘ã—å¾…ã£ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
    }
  }catch(e){
    $("lockMsg").textContent = "æ±ºæ¸ˆç¢ºèªã«å¤±æ•—: " + String(e.message || e);
  }finally{
    // clean URL (keep path)
    url.searchParams.delete("success");
    url.searchParams.delete("session_id");
    history.replaceState({}, "", url.pathname + url.search);
    setStatus("æº–å‚™OK");
  }
}

function unlockByCode(){
  const code = $("unlockCode").value.trim();
  if (!code) return;
  if (code === (CFG.unlock_code || "")){
    unlocked = true;
    ls.set("aiga_unlocked_"+VARIANT, true);
    $("lock").style.display="none";
    $("lockMsg").textContent = "";
    setTrialInfo();
  }else{
    $("lockMsg").textContent = "è§£é™¤ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
  }
}

/* ========= init ========= */
async function init(){
  try{
    $("variantPill").textContent = VARIANT;
    setStatus("ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­â€¦");

    // load json
    CFG = await loadJson("/config.json");
    EX = await loadJson("/examples.json");

    // allow override by path variant (so /app/ssw ã§ã‚‚OK)
    if (VARIANT !== CFG.variant && (VARIANT === "ssw" || VARIANT === "trainee")){
      // config.json ã®å†…å®¹ã¯å…±é€šã§ä½¿ã„ã€variantã ã‘ã¯è¡¨ç¤ºä¸Šåˆ‡æ›¿
    }

    populate();

    // apply settings to UI
    if ($("ttsSel")) $("ttsSel").value = SETTINGS.ttsSel || "off";
    if ($("ttsRate")) $("ttsRate").value = SETTINGS.ttsRate || "1";
    if ($("ttsAuto")) $("ttsAuto").value = SETTINGS.ttsAuto || "off";
    if ($("uiLabelMode")) $("uiLabelMode").value = SETTINGS.uiLabelMode || "jp_id";

    setTrialInfo();

    renderHistory();
    renderStats();
    renderAnno(lastAnnotations);
    setStatus("æº–å‚™OK");

    await verifyFromUrl();

    // events
    $("sceneSel").addEventListener("change", updateCategories);
    $("btnExample").addEventListener("click", insertExample);
    $("btnClear").addEventListener("click", ()=>{
      if (!confirm("å±¥æ­´ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
      history = [];
      ls.set("aiga_history_"+VARIANT, history);
      renderHistory();
    });
    $("btnSend").addEventListener("click", send);
    $("userInput").addEventListener("keydown", (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") send();
    });
    $("btnPay").addEventListener("click", startCheckout);
    $("btnCloseLock").addEventListener("click", ()=>{ $("lock").style.display="none"; });
    $("btnUnlock").addEventListener("click", unlockByCode);
    // TTS controls
    $("btnStopTts")?.addEventListener("click", stopTts);
    $("ttsSel")?.addEventListener("change", ()=>{ saveSettings(); renderHistory(); });
    $("ttsRate")?.addEventListener("change", saveSettings);
    $("ttsAuto")?.addEventListener("change", saveSettings);
    $("uiLabelMode")?.addEventListener("change", ()=>{ saveSettings(); rebuildSelectLabels(); renderHistory(); renderStats(); });

    // Speak suggested
    $("btnSpeakSuggestHira")?.addEventListener("click", ()=>{ unlockTts(); if (lastSuggested) speakOnce(lastSuggested.hira || ""); else showErr("ã¾ã ææ¡ˆæ–‡ãŒã‚ã‚Šã¾ã›ã‚“"); });
    $("btnSpeakSuggestRoma")?.addEventListener("click", ()=>{ unlockTts(); if (lastSuggested) speakOnce(lastSuggested.romaji || ""); else showErr("ã¾ã ææ¡ˆæ–‡ãŒã‚ã‚Šã¾ã›ã‚“"); });

    // Click-to-speak in history (event delegation)
    $("history")?.addEventListener("click", (e)=>{
      const btn = e.target.closest(".ttsBtn");
      unlockTts();
      if (!btn) return;
      const idx = Number(btn.dataset.idx || -1);
      const field = btn.dataset.field || "";
      const item = (history || [])[idx];
      const text = item?.tri?.[field] || "";
      if (field === "hira") speakOnce(text, "ja-JP");
      else if (field === "romaji") speakOnce(text, "ja-JP");
    });

    // Reset learning log
    $("btnResetLog")?.addEventListener("click", ()=>{
      if (!confirm("å­¦ç¿’ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
      STATS = { scenes:{}, categories:{} };
      ls.set("aiga_stats_"+VARIANT, STATS);
      renderStats();
    });

  }catch(e){
    setStatus("èµ·å‹•å¤±æ•—");
    $("errBox").style.display="block";
    $("errBox").textContent = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + String(e.message || e);
  }
}

init();
</script>
</body>
</html>
