<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI (SSW)</title>
<style>
  :root{
    --border:#d9d9d9;
    --bg:#ffffff;
    --muted:#666;
    --card:#fafafa;
    --btn:#f3f3f3;
  }
  *{box-sizing:border-box}
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; margin:16px; color:#111; background:var(--bg)}
  h1{font-size:22px; margin:0 0 10px}
  .subtabs{font-size:13px; color:var(--muted); margin-bottom:10px}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  label{font-size:13px; color:var(--muted)}
  select, textarea, input[type="text"]{
    border:1px solid var(--border);
    border-radius:8px;
    padding:8px 10px;
    font-size:14px;
    background:#fff;
  }
  select{min-width:150px}
  textarea{width:100%; min-height:120px; resize:vertical}
  .btn{
    border:1px solid var(--border);
    background:var(--btn);
    border-radius:10px;
    padding:8px 12px;
    font-size:14px;
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#111; color:#fff; border-color:#111}
  .btn.small{padding:6px 10px; font-size:13px}
  .btn.icon{display:inline-flex; align-items:center; gap:6px}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .help{font-size:12px; color:var(--muted); margin:8px 0 0}
  .panel{
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    padding:12px;
  }
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width: 960px){ .grid2{grid-template-columns:1fr} }
  .card{
    border:1px solid var(--border);
    border-radius:14px;
    background:var(--card);
    padding:12px;
    min-height:110px;
  }
  .card h3{font-size:14px; margin:0 0 8px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .out{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:#fff;
    min-height:80px;
    white-space:pre-wrap;
    overflow-wrap:anywhere;
  }
  .out.mini{min-height:60px}
  .right{margin-left:auto}
  .badge{font-size:12px; color:var(--muted)}
  .divider{height:1px; background:var(--border); margin:12px 0}
  .toast{font-size:12px; color:var(--muted)}
</style>
</head>
<body>

<h1>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI</h1>
<div class="subtabs">â‘ ä¾‹æ–‡æŠ•å…¥ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰ â†’ â‘¡ä»‹è­·å£«ç™ºè©±ãƒ­ãƒ¼ãƒå­— â†’ â‘¢Stage1 â†’ â‘£Stage2ï¼ˆæ¨å¥¨è¿”ç­”ã®ãƒ­ãƒ¼ãƒå­—ï¼‹ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</div>

<div class="panel">
  <div class="row">
    <label>Scene
      <select id="sceneSel"></select>
    </label>
    <label>Persona
      <select id="personaSel"></select>
    </label>
    <label>ã‚«ãƒ†ã‚´ãƒª
      <select id="catSel"></select>
    </label>
    <label>ãƒ¬ãƒ™ãƒ«
      <select id="levelSel"></select>
    </label>

    <button class="btn" id="btnExample">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
      <button class="btn" id="btnExampleAI" title="AIã§ä¾‹æ–‡ã‚’è¿½åŠ ç”Ÿæˆ">ä¾‹æ–‡AI</button>
    <button class="btn small" id="btnExampleJA">ä¾‹æ–‡(JA)</button>
    <button class="btn small" id="btnExampleRoma">ãƒ­ãƒ¼ãƒå­—</button>
    <button class="btn small" id="btnExampleID">ID</button>
    <button class="btn small" id="btnTest">ãƒ†ã‚¹ãƒˆ</button>

    <label class="right" style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" id="autoStage2" checked />
      <span class="badge">Stage2ã‚’è‡ªå‹•å®Ÿè¡Œ</span>
    </label>
    <span id="statusMsg" class="badge"> </span>
  </div>

  <div class="divider"></div>

  <label>ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰</label>
  <textarea id="jpInput" placeholder="ä¾‹æ–‡ãƒœã‚¿ãƒ³ã§è‡ªå‹•å…¥åŠ›ã€ã¾ãŸã¯è‡ªç”±å…¥åŠ›"></textarea>
  <div class="help">â€» examples ãŒã‚ã‚‹å ´åˆï¼šscene Ã— persona Ã— ã‚«ãƒ†ã‚´ãƒª ã®ä¾‹æ–‡ãŒå‡ºã¾ã™ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰</div>

  <div style="margin-top:10px;">
    <label>ä»‹è­·å£«ç™ºè©±ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</label>
    <div id="romaInput" class="out mono mini"></div>
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="btn primary" id="btnSend">é€ä¿¡</button>
    <button class="btn" id="btnStage2Only">Stage2ã ã‘å®Ÿè¡Œ</button>
    <span class="toast" id="hint"></span>
  </div>
</div>

<div class="grid2" style="margin-top:14px;">
  <div class="card">
    <h3>Stage1ï¼ˆæ—¥æœ¬èªï¼‰</h3>
    <div style="margin-top:8px;"><b>ç›¸æ‰‹ï¼ˆAIå´ï¼‰ã®è¿”ç­”</b></div>
    <div id="aiReplyJp" class="out" style="margin-top:6px;"></div>

    <div style="margin-top:10px;"><b>ã‚ãªãŸã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</b></div>
    <div id="feedbackJp" class="out" style="margin-top:6px;"></div>

    <div style="margin-top:10px;"><b>æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰</b></div>
    <div id="suggestedJp" class="out" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <h3>Stage2ï¼ˆç¿»è¨³ãƒ»æ¨å¥¨è¿”ç­”ï¼‰</h3>

    <div class="row" style="justify-content:space-between;">
      <b>ãƒ­ãƒ¼ãƒå­—ï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b>
      <button class="btn small icon" id="speakRoma" title="èª­ã¿ä¸Šã’ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰">ğŸ”Š</button>
    </div>
    <div id="suggestedRoma" class="out mono" style="margin-top:6px;"></div>

    <div class="row" style="justify-content:space-between; margin-top:10px;">
      <b>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼ˆæ¨å¥¨è¿”ç­”ï¼‰</b>
      <button class="btn small icon" id="speakID" title="èª­ã¿ä¸Šã’ï¼ˆã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰">ğŸ”Š</button>
    </div>
    <div id="suggestedID" class="out" style="margin-top:6px;"></div>
  </div>
</div>

<script>
/** ==========
 *  ä¾‹æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã›ã¾ã™ï¼‰
 *  ========== */
const EXAMPLES = {
  bath: {
    user_calm: {
      calling: [
        {jp:"ã‚†ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€‚æ°—æŒã¡ã‚ˆãå…¥ã‚Šã¾ã—ã‚‡ã†ã€‚", id:"Pelan-pelan saja, tidak apa-apa. Mari mandi dengan nyaman."},
        {jp:"å¯’ããªã„ã§ã™ã‹ï¼ŸãŠæ¹¯ã®æ¸©åº¦ã¯å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ", id:"Apakah Anda merasa dingin? Apakah suhu airnya sudah pas?"}
      ],
      complaint: [
        {jp:"ä¸å®‰ã§ã—ãŸã­ã€‚ä»Šã®çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚", id:"Anda merasa cemas, ya. Tolong ceritakan situasinya sekarang."}
      ]
    }
  },
  toilet: {
    user_calm: {
      privacy: [
        {jp:"ãƒˆã‚¤ãƒ¬ã«è¡Œãæº–å‚™ã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿå¿…è¦ãªã‚‰ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚", id:"Apakah Anda siap ke toilet? Jika perlu, saya bantu."}
      ],
      urge: [
        {jp:"æ€¥ãã¾ã—ã‚‡ã†ã€‚è»¢ã°ãªã„ã‚ˆã†ã«ã‚†ã£ãã‚Šæ­©ãã¾ã™ã€‚", id:"Mari kita cepat, tapi berjalan pelan agar tidak jatuh."}
      ]
    }
  },
  meal: {
    user_calm: {
      refusal: [
        {jp:"ä»Šã¯é£Ÿã¹ãŸããªã„æ°—åˆ†ã§ã™ã­ã€‚ç„¡ç†ã—ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚", id:"Sepertinya Anda sedang tidak ingin makan. Tidak apa-apa jika tidak dipaksakan."}
      ]
    }
  },
  night: {
    family_complaint: {
      anxiety: [
        {jp:"å¤§ä¸ˆå¤«ã§ã™ã€‚ã“ã“ã¯å®‰å…¨ã§ã™ã€‚", id:"Tidak apa-apa. Di sini aman."},
        {jp:"ä½•ãŒä¸€ç•ªå¿ƒé…ã§ã™ã‹ï¼Ÿæ•™ãˆã¦ãã ã•ã„ã€‚", id:"Apa yang paling Anda khawatirkan? Tolong beri tahu saya."}
      ]
    }
  }
};

/** ==========
 *  Select optionsï¼ˆè¡¨ç¤ºåã¨å†…éƒ¨å€¤ã‚’åˆ†ã‘ã‚‹ï¼‰
 *  ========== */
const OPTIONS = {
  scene: [
    {v:"bath", t:"å…¥æµ´"},
    {v:"toilet", t:"ãƒˆã‚¤ãƒ¬"},
    {v:"meal", t:"é£Ÿäº‹"},
    {v:"night", t:"å¤œé–“"},
  ],
  persona: [
    {v:"user_calm", t:"åˆ©ç”¨è€…ï¼šç©ã‚„ã‹"},
    {v:"dementia", t:"åˆ©ç”¨è€…ï¼šèªçŸ¥ç—‡"},
    {v:"user_angry", t:"åˆ©ç”¨è€…ï¼šæ€’ã‚Š"},
    {v:"family_complaint", t:"å®¶æ—ï¼šã‚¯ãƒ¬ãƒ¼ãƒ "},
  ],
  category: [
    {v:"calling", t:"å£°ã‹ã‘"},
    {v:"privacy", t:"ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼"},
    {v:"urge", t:"æ€¥ã"},
    {v:"refusal", t:"æ‹’å¦"},
    {v:"complaint", t:"ã‚¯ãƒ¬ãƒ¼ãƒ "},
    {v:"anxiety", t:"ä¸å®‰/æ··ä¹±"},
    {v:"start", t:"start"},
    {v:"all", t:"å…¨ã¦"},
  ],
  level: [
    {v:"basic", t:"åˆç´š"},
    {v:"mid", t:"ä¸­ç´š"},
    {v:"all", t:"å…¨ã¦"},
  ]
};

function $(id){ return document.getElementById(id); }

// --- Normalization helpers ---
// Normalize Japanese text to a consistent form (full/half width, punctuation, etc.)
// NOTE: Some builds referenced normalizeJP() but didn't define it, which breaks all buttons.
function normalizeJP(str){
  if (str == null) return "";
  let s = String(str);
  // Normalize widths/compatibility characters
  try { s = s.normalize('NFKC'); } catch(e) {}
  // Normalize common punctuation variants
  s = s
    .replace(/[â€œâ€]/g,'"')
    .replace(/[â€˜â€™]/g,"'")
    .replace(/[âˆ’â€•ãƒ¼]/g,'-')
    .replace(/ã€€/g,' ');
  // Collapse spaces
  s = s.replace(/[ \t\n\r]+/g,' ').trim();
  return s;
}

// Romaji formatting: keep ASCII-only, normalize spaces around punctuation.
function normalizeRomaji(str){
  if (str == null) return "";
  let s = String(str);
  try { s = s.normalize('NFKC'); } catch(e) {}
  // Replace full-width spaces and collapse
  s = s.replace(/ã€€/g,' ');
  // Ensure spacing after punctuation when missing
  s = s
    .replace(/([\.!\?])(?=\S)/g, '$1 ')
    .replace(/\s+([\.!\?,:;])/g, '$1')
    .replace(/[ \t\n\r]+/g,' ')
    .trim();
  return s;
}
function setStatus(msg){ const el = $("statusMsg"); if(el) el.textContent = msg || ""; }

function fillSelect(id, list, defaultV){
  const sel = $(id);
  if(!sel) return;
  sel.innerHTML = "";
  list.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o.v;
    opt.textContent = o.t;
    sel.appendChild(opt);
  });
  sel.value = defaultV || (list[0]?.v ?? "");
}

function getConfig(){
  return {
    scene: $("sceneSel")?.value || "bath",
    persona: $("personaSel")?.value || "user_calm",
    category: $("catSel")?.value || "calling",
    level: $("levelSel")?.value || "basic",
  };
}

/** ==========
 *  æ—¥æœ¬èªã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆç°¡æ˜“ãƒ˜ãƒœãƒ³å¼ï¼‰
 *  ç›®çš„ï¼šèª­ã¿ä¸Šã’éŸ³ã®ã€Œæ–‡å­—åŒ–ã€ãªã®ã§ã€å®Œç’§ã‚ˆã‚Šâ€œå®‰å®šâ€å„ªå…ˆ
 *  ========== */
const KANA_MAP = {
  "ã‚":"a","ã„":"i","ã†":"u","ãˆ":"e","ãŠ":"o",
  "ã‹":"ka","ã":"ki","ã":"ku","ã‘":"ke","ã“":"ko",
  "ã•":"sa","ã—":"shi","ã™":"su","ã›":"se","ã":"so",
  "ãŸ":"ta","ã¡":"chi","ã¤":"tsu","ã¦":"te","ã¨":"to",
  "ãª":"na","ã«":"ni","ã¬":"nu","ã­":"ne","ã®":"no",
  "ã¯":"ha","ã²":"hi","ãµ":"fu","ã¸":"he","ã»":"ho",
  "ã¾":"ma","ã¿":"mi","ã‚€":"mu","ã‚":"me","ã‚‚":"mo",
  "ã‚„":"ya","ã‚†":"yu","ã‚ˆ":"yo",
  "ã‚‰":"ra","ã‚Š":"ri","ã‚‹":"ru","ã‚Œ":"re","ã‚":"ro",
  "ã‚":"wa","ã‚’":"o",
  "ã‚“":"n",
  "ãŒ":"ga","ã":"gi","ã":"gu","ã’":"ge","ã”":"go",
  "ã–":"za","ã˜":"ji","ãš":"zu","ãœ":"ze","ã":"zo",
  "ã ":"da","ã¢":"ji","ã¥":"zu","ã§":"de","ã©":"do",
  "ã°":"ba","ã³":"bi","ã¶":"bu","ã¹":"be","ã¼":"bo",
  "ã±":"pa","ã´":"pi","ã·":"pu","ãº":"pe","ã½":"po",
  "ã":"a","ãƒ":"i","ã…":"u","ã‡":"e","ã‰":"o",
  "ã‚ƒ":"ya","ã‚…":"yu","ã‚‡":"yo",
  "ã‚”":"vu",
  // ã‚«ã‚¿ã‚«ãƒŠ
  "ã‚¢":"a","ã‚¤":"i","ã‚¦":"u","ã‚¨":"e","ã‚ª":"o",
  "ã‚«":"ka","ã‚­":"ki","ã‚¯":"ku","ã‚±":"ke","ã‚³":"ko",
  "ã‚µ":"sa","ã‚·":"shi","ã‚¹":"su","ã‚»":"se","ã‚½":"so",
  "ã‚¿":"ta","ãƒ":"chi","ãƒ„":"tsu","ãƒ†":"te","ãƒˆ":"to",
  "ãƒŠ":"na","ãƒ‹":"ni","ãƒŒ":"nu","ãƒ":"ne","ãƒ":"no",
  "ãƒ":"ha","ãƒ’":"hi","ãƒ•":"fu","ãƒ˜":"he","ãƒ›":"ho",
  "ãƒ":"ma","ãƒŸ":"mi","ãƒ ":"mu","ãƒ¡":"me","ãƒ¢":"mo",
  "ãƒ¤":"ya","ãƒ¦":"yu","ãƒ¨":"yo",
  "ãƒ©":"ra","ãƒª":"ri","ãƒ«":"ru","ãƒ¬":"re","ãƒ­":"ro",
  "ãƒ¯":"wa","ãƒ²":"o","ãƒ³":"n",
  "ã‚¬":"ga","ã‚®":"gi","ã‚°":"gu","ã‚²":"ge","ã‚´":"go",
  "ã‚¶":"za","ã‚¸":"ji","ã‚º":"zu","ã‚¼":"ze","ã‚¾":"zo",
  "ãƒ€":"da","ãƒ‚":"ji","ãƒ…":"zu","ãƒ‡":"de","ãƒ‰":"do",
  "ãƒ":"ba","ãƒ“":"bi","ãƒ–":"bu","ãƒ™":"be","ãƒœ":"bo",
  "ãƒ‘":"pa","ãƒ”":"pi","ãƒ—":"pu","ãƒš":"pe","ãƒ":"po",
  "ã‚¡":"a","ã‚£":"i","ã‚¥":"u","ã‚§":"e","ã‚©":"o",
  "ãƒ£":"ya","ãƒ¥":"yu","ãƒ§":"yo",
  "ãƒ´":"vu",
};

const DIGRAPH_MAP = {
  "ãã‚ƒ":"kya","ãã‚…":"kyu","ãã‚‡":"kyo",
  "ã—ã‚ƒ":"sha","ã—ã‚…":"shu","ã—ã‚‡":"sho",
  "ã¡ã‚ƒ":"cha","ã¡ã‚…":"chu","ã¡ã‚‡":"cho",
  "ã«ã‚ƒ":"nya","ã«ã‚…":"nyu","ã«ã‚‡":"nyo",
  "ã²ã‚ƒ":"hya","ã²ã‚…":"hyu","ã²ã‚‡":"hyo",
  "ã¿ã‚ƒ":"mya","ã¿ã‚…":"myu","ã¿ã‚‡":"myo",
  "ã‚Šã‚ƒ":"rya","ã‚Šã‚…":"ryu","ã‚Šã‚‡":"ryo",
  "ãã‚ƒ":"gya","ãã‚…":"gyu","ãã‚‡":"gyo",
  "ã˜ã‚ƒ":"ja","ã˜ã‚…":"ju","ã˜ã‚‡":"jo",
  "ã³ã‚ƒ":"bya","ã³ã‚…":"byu","ã³ã‚‡":"byo",
  "ã´ã‚ƒ":"pya","ã´ã‚…":"pyu","ã´ã‚‡":"pyo",
  // ã‚«ã‚¿ã‚«ãƒŠ
  "ã‚­ãƒ£":"kya","ã‚­ãƒ¥":"kyu","ã‚­ãƒ§":"kyo",
  "ã‚·ãƒ£":"sha","ã‚·ãƒ¥":"shu","ã‚·ãƒ§":"sho",
  "ãƒãƒ£":"cha","ãƒãƒ¥":"chu","ãƒãƒ§":"cho",
  "ãƒ‹ãƒ£":"nya","ãƒ‹ãƒ¥":"nyu","ãƒ‹ãƒ§":"nyo",
  "ãƒ’ãƒ£":"hya","ãƒ’ãƒ¥":"hyu","ãƒ’ãƒ§":"hyo",
  "ãƒŸãƒ£":"mya","ãƒŸãƒ¥":"myu","ãƒŸãƒ§":"myo",
  "ãƒªãƒ£":"rya","ãƒªãƒ¥":"ryu","ãƒªãƒ§":"ryo",
  "ã‚®ãƒ£":"gya","ã‚®ãƒ¥":"gyu","ã‚®ãƒ§":"gyo",
  "ã‚¸ãƒ£":"ja","ã‚¸ãƒ¥":"ju","ã‚¸ãƒ§":"jo",
  "ãƒ“ãƒ£":"bya","ãƒ“ãƒ¥":"byu","ãƒ“ãƒ§":"byo",
  "ãƒ”ãƒ£":"pya","ãƒ”ãƒ¥":"pyu","ãƒ”ãƒ§":"pyo",
};

function isVowel(ch){ return ["a","i","u","e","o"].includes(ch); }

function kanaToRomaji(input){
  // Lightweight fallback: convert kana -> romaji, and avoid mixing kanji into the romaji field.
  // For accurate romaji (incl. kanji), we request `user_romaji` from the API after "é€ä¿¡".
  if(!input) return "";
  const s = normalizeJP(input);

  let out = "";
  let i = 0;

  const isKana = (ch)=> /[ã-ã‚–ã‚¡-ãƒºãƒ¼]/.test(ch);
  const isLatinOrNum = (ch)=> /[A-Za-z0-9]/.test(ch);

  while(i < s.length){
    const c = s[i];

    // Keep ASCII spaces/punct as separators
    if(/[\s.,!?;:()\[\]{}"'-]/.test(c)){
      out += c;
      i++;
      continue;
    }

    // Keep latin/nums (user may type romaji already)
    if(isLatinOrNum(c)){
      out += c;
      i++;
      continue;
    }

    // Convert kana
    if(isKana(c)){
      const next2 = (s[i] || "") + (s[i+1] || "");
      const next1 = s[i+1] || "";

      let r = DIGRAPH_MAP[next2] || DIGRAPH_MAP[normalizeJP(next2)] || null;
      if(r){
        out += r;
        i += 2;
        continue;
      }

      r = KANA_MAP[c] || KANA_MAP[normalizeJP(c)] || "";
      if(c === "ã£" || c === "ãƒƒ"){
        // small tsu: double the next consonant if possible
        const look2 = (s[i+1] || "") + (s[i+2] || "");
        const look1 = s[i+1] || "";
        const nextRoma = DIGRAPH_MAP[look2] || KANA_MAP[look1] || "";
        out += (nextRoma && nextRoma[0]) ? nextRoma[0] : "";
        i += 1;
        continue;
      }

      // long vowel mark
      if(c === "ãƒ¼"){
        out += "-";
        i += 1;
        continue;
      }

      out += r;
      i += 1;
      continue;
    }

    // Any other char (kanji, emoji, etc.) -> separator
    out += " ";
    i++;
  }

  // Tidy: collapse spaces
  out = out.replace(/\s+/g, " ").trim();
  return out;
}

/** ==========
 *  examplesé¸æŠãƒ­ã‚¸ãƒƒã‚¯
 *  ========== */
const exampleCursor = new Map(); // key -> idx

function getExamplesFor(cfg){
  const {scene, persona, category} = cfg;
  const byScene = EXAMPLES[scene] || {};
  const byPersona = byScene[persona] || {};

  // category ãŒ all ã®å ´åˆã¯ã€å…¨ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ•ãƒ©ãƒƒãƒˆã«
  if(category === "all"){
    const arr = [];
    Object.keys(byPersona).forEach(cat=>{
      (byPersona[cat] || []).forEach(ex=>arr.push({ ...ex, _cat: cat }));
    });
    return arr;
  }
  return (byPersona[category] || []);
}

function pickNextExample(){
  const cfg = getConfig();
  const list = getExamplesFor(cfg);
  if(!list.length) return null;
  const key = `${cfg.scene}|${cfg.persona}|${cfg.category}`;
  const idx = (exampleCursor.get(key) ?? -1) + 1;
  const next = list[idx % list.length];
  exampleCursor.set(key, idx % list.length);
  return next;
}

function setInputJP(text){
  const jp = $("jpInput");
  if(!jp) return;
  jp.value = text || "";
  updateRomaFromJP();
}

function updateRomaFromJP(){
  const jp = $("jpInput")?.value?.trim() || "";
  const roma = kanaToRomaji(jp);
  const el = $("romaInput");
  if(el) el.textContent = roma || "";
}

/** ==========
 *  Stage2: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚­ãƒ¼æºã‚Œå¯¾ç­–
 *  ========== */
function pick(obj, keys){
  if(!obj) return "";
  for(const k of keys){
    if(Object.prototype.hasOwnProperty.call(obj,k) && obj[k] != null && String(obj[k]).trim() !== ""){
      return String(obj[k]);
    }
  }
  return "";
}

function parseMaybeJSON(txt){
  if(!txt) return null;
  try{ return JSON.parse(txt); }catch(_){ return null; }
}

/** ==========
 *  APIå‘¼ã³å‡ºã—ï¼ˆ/api/chatï¼‰
 *  ==========
 *  æœŸå¾…ï¼šJSON
 *  - ai_reply_jp
 *  - feedback_jp
 *  - suggested_reply_jp
 *  è¿½åŠ ãŒã‚ã‚Œã°ï¼š
 *  - suggested_reply_romaji / romaji_reply / romaji
 *  - suggested_reply_id / indonesian / id_reply
 */
async function callChatAPI(payload){
  const res = await fetch("/api/chat", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  const data = parseMaybeJSON(text);
  if(!res.ok){
    const msg = data?.error || data?.message || text || ("HTTP " + res.status);
    throw new Error(msg);
  }
  return data || {};
}

function buildPromptForStage1(jpText, cfg){
  // Stage1: AIå´ã®è¿”ç­”(æ—¥æœ¬èª) + ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯(æ—¥æœ¬èª) + æ¨å¥¨è¿”ç­”(æ—¥æœ¬èª)
  // ã•ã‚‰ã«ã€Œã‚ãªãŸã®ç™ºè©±ã€ã‚’ãƒ­ãƒ¼ãƒå­—åŒ–ã—ã¦è¿”ã™ï¼ˆæ•™æå“è³ªã®å®‰å®šåŒ–ç”¨ï¼‰
  return [
`ã‚ãªãŸã¯ä»‹è­·ç¾å ´ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AIã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§ã€å¿…ãšJSONã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ç¦æ­¢ï¼‰ã€‚`,
``,
`ã€è¨­å®šã€‘`,
`scene: ${cfg.scene}`,
`persona: ${cfg.persona}`,
`category: ${cfg.category}`,
`level: ${cfg.level}`,
``,
`ã€ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰ã€‘`,
jpText,
``,
`ã€å‡ºåŠ›JSONã®å½¢å¼ã€‘`,
`{`,
`  "ai_reply_jp": "ç›¸æ‰‹ï¼ˆAIå´ï¼‰ã®è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰",`,
`  "feedback_jp": "ã‚ãªãŸã®ç™ºè©±ã¸ã®çŸ­ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ—¥æœ¬èªã€1ã€œ2æ–‡ï¼‰",`,
`  "suggested_reply_jp": "æ¬¡ã«ã‚ãªãŸãŒè¨€ã†æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªã€1æ–‡ï¼‰",`,
`  "user_romaji": "ä¸Šã®ã€ä»‹è­·å£«ã®ç™ºè©±ã€ã‚’ãƒ­ãƒ¼ãƒå­—ã«ã—ãŸã‚‚ã®ï¼ˆãƒ˜ãƒœãƒ³å¼å¯„ã‚Šã€å˜èªã®é–“ã¯ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚‹ã€‚å¥èª­ç‚¹ã¯æ®‹ã™ï¼‰"`,
`}`,
``,
`ã€ãƒ«ãƒ¼ãƒ«ã€‘`,
`- å¿…ãšæœ‰åŠ¹ãªJSONã®ã¿è¿”ã™ã€‚ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹ç¦æ­¢ã€‚`,
`- user_romajiã¯ã€æ¼¢å­—ã‚‚å«ã‚ã¦èª­ã¿ã‚’æ¨å®šã—ã¦ãƒ­ãƒ¼ãƒå­—åŒ–ã™ã‚‹ï¼ˆåˆ†ã‹ã‚‰ãªã„å ´åˆã¯ã€ã²ã‚‰ãŒãªã«ã—ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒå­—åŒ–ã—ã¦ã‚ˆã„ï¼‰ã€‚`,
`- æ–½è¨­ã®ä¼šè©±ã¨ã—ã¦ä¸å¯§ã§è‡ªç„¶ãªæ—¥æœ¬èªã«ã™ã‚‹ã€‚`,
  ].join("\n");
}

function buildPromptForStage2(suggestedJp, cfg){
  return [
    "ã‚ãªãŸã¯æ—¥æœ¬èªâ†’ãƒ­ãƒ¼ãƒå­—ã€æ—¥æœ¬èªâ†’ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã®å¤‰æ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚",
    "æ¬¡ã®ã€æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰ã€ã‚’ã€(A)ãƒ­ãƒ¼ãƒå­—ï¼ˆãƒ˜ãƒœãƒ³å¼ã£ã½ãã€èª­ã¿ã‚„ã™ãï¼‰ã€(B)ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚",
    "å‡ºåŠ›ã¯JSONã®ã¿ã§ã€ã‚­ãƒ¼ã¯ suggested_reply_romaji ã¨ suggested_reply_id ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚",
    "",
    "æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰:",
    suggestedJp
  ].join("\n");
}

async function runStage1AndMaybeStage2(){
  const cfg = getConfig();
  const jpText = $("jpInput")?.value?.trim() || "";
  if(!jpText){
    alert("æ—¥æœ¬èªã®ç™ºè©±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  setStatus("å®Ÿè¡Œä¸­â€¦");
  $("btnSend")?.setAttribute("disabled","disabled");
  $("btnStage2Only")?.setAttribute("disabled","disabled");

  try{
    const stage1 = await callChatAPI({
      prompt: buildPromptForStage1(jpText, cfg),
      trace: cfg
    });

    const ai = pick(stage1, ["ai_reply_jp","aiReplyJp","ai_reply","reply"]);
    const fb = pick(stage1, ["feedback_jp","feedback","coach_jp"]);
    const sug = pick(stage1, ["suggested_reply_jp","suggestedJp","suggested_reply","suggested"]);

    if($("aiReplyJp")) $("aiReplyJp").textContent = ai || "";
    if($("feedbackJp")) $("feedbackJp").textContent = fb || "";
    if($("suggestedJp")) $("suggestedJp").textContent = sug || "";

    // Stage2
    if($("autoStage2")?.checked){
      await runStage2FromSuggested(sug || jpText, cfg);
    }else{
      // ãƒ­ãƒ¼ãƒå­—ã¯æœ€ä½é™ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ›ã§è¡¨ç¤º
      if($("suggestedRoma")) $("suggestedRoma").textContent = kanaToRomaji(sug || jpText);
    }

    setStatus("å®Œäº†");
  }catch(err){
    console.error(err);
    setStatus("ã‚¨ãƒ©ãƒ¼");
    alert("ã‚¨ãƒ©ãƒ¼: " + (err?.message || err));
  }finally{
    $("btnSend")?.removeAttribute("disabled");
    $("btnStage2Only")?.removeAttribute("disabled");
    setTimeout(()=>setStatus(""), 2500);
  }
}

async function runStage2Only(){
  const cfg = getConfig();
  const sug = ($("suggestedJp")?.textContent || "").trim();
  const jpText = ($("jpInput")?.value || "").trim();
  const base = sug || jpText;
  if(!base){
    alert("Stage2ã®å…ƒã«ãªã‚‹æ—¥æœ¬èªãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¥åŠ› or Stage1 å®Ÿè¡Œï¼‰ã€‚");
    return;
  }
  setStatus("Stage2ä¸­â€¦");
  $("btnStage2Only")?.setAttribute("disabled","disabled");
  try{
    await runStage2FromSuggested(base, cfg);
    setStatus("å®Œäº†");
  }catch(err){
    console.error(err);
    setStatus("ã‚¨ãƒ©ãƒ¼");
    alert("Stage2 ã‚¨ãƒ©ãƒ¼: " + (err?.message || err));
  }finally{
    $("btnStage2Only")?.removeAttribute("disabled");
    setTimeout(()=>setStatus(""), 2500);
  }
}

async function runStage2FromSuggested(suggestedJp, cfg){
  // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ­ãƒ¼ãƒå­—ï¼ˆè¡¨ç¤ºã®æœ€ä½ä¿è¨¼ï¼‰
  const localRoma = kanaToRomaji(suggestedJp);
  if($("suggestedRoma")) $("suggestedRoma").textContent = localRoma;

  // APIãŒå¯¾å¿œã—ã¦ã„ã‚Œã°IDè¨³ã‚‚å–å¾—
  const stage2 = await callChatAPI({
    prompt: buildPromptForStage2(suggestedJp, cfg),
    trace: cfg
  });

  const roma = pick(stage2, ["suggested_reply_romaji","romaji_reply","romaji","suggestedRoma"]);
  const id = pick(stage2, ["suggested_reply_id","indonesian_reply","indonesian","id_reply","suggestedID"]);

  if($("suggestedRoma")) $("suggestedRoma").textContent = roma || localRoma || "";
  if($("suggestedID")) $("suggestedID").textContent = id || "";
}

/** ==========
 *  éŸ³å£°ï¼ˆSpeechSynthesisï¼‰
 *  ========== */
function speak(text, lang){
  if(!text) return;
  if(!("speechSynthesis" in window)) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || "ja-JP";
    u.rate = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn(e);
  }
}

function bind(){
  // selectåˆæœŸåŒ–
  fillSelect("sceneSel", OPTIONS.scene, "bath");
  fillSelect("personaSel", OPTIONS.persona, "user_calm");
  fillSelect("catSel", OPTIONS.category, "calling");
  fillSelect("levelSel", OPTIONS.level, "basic");

  // å…¥åŠ›â†’ãƒ­ãƒ¼ãƒå­—è‡ªå‹•æ›´æ–°
  $("jpInput")?.addEventListener("input", updateRomaFromJP);

  // ä¾‹æ–‡ãƒœã‚¿ãƒ³
  $("btnExample")?.addEventListener("click", ()=>{
    const ex = pickNextExample();
    if(!ex){
      alert("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆscene/persona/ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰ãˆã¦ãã ã•ã„ï¼‰ã€‚");
      return;
    }
    setInputJP(ex.jp);
    $("hint").textContent = `ä¾‹æ–‡ã‚’å…¥åŠ›ã—ã¾ã—ãŸ`;
    // Stage2è‡ªå‹•ãªã‚‰ã€ä¾‹æ–‡IDã‚‚å…ˆã«è¡¨ç¤ºã—ã¦ãŠãï¼ˆå­¦ç¿’å°ç·šï¼‰
    if($("autoStage2")?.checked && $("suggestedID")){
      $("suggestedID").textContent = ex.id || "";
    }
  });
  // ===== AIã§ä¾‹æ–‡ã‚’å¢—ã‚„ã™ï¼ˆæ•™æå“è³ªã‚¢ãƒƒãƒ—ï¼‰ =====
  function cfgKey(scene, persona, category, level){
    return [scene||"", persona||"", category||"", level||""].join("|");
  }
  function getCfg(){
    return {
      scene: $("sceneSel")?.value || "",
      persona: $("personaSel")?.value || "",
      category: $("catSel")?.value || "",
      level: $("lvlSel")?.value || ""
    };
  }
  function getAIExampleCache(cfg){
    try{
      const k = "aiExamples:" + cfgKey(cfg.scene,cfg.persona,cfg.category,cfg.level);
      const raw = localStorage.getItem(k);
      if(!raw) return [];
      const obj = JSON.parse(raw);
      // 7æ—¥ã§æ›´æ–°
      if(Date.now() - (obj.ts||0) > 7*24*60*60*1000) return [];
      return Array.isArray(obj.examples) ? obj.examples : [];
    }catch(e){ return []; }
  }
  function setAIExampleCache(cfg, examples){
    try{
      const k = "aiExamples:" + cfgKey(cfg.scene,cfg.persona,cfg.category,cfg.level);
      localStorage.setItem(k, JSON.stringify({ts: Date.now(), examples}));
    }catch(e){}
  }
  function extractJson(text){
    if(!text) return null;
    const s = text.indexOf("{");
    const e = text.lastIndexOf("}");
    if(s>=0 && e>s){
      const cand = text.slice(s, e+1);
      try{ return JSON.parse(cand); }catch(_){}
    }
    const a1 = text.indexOf("[");
    const a2 = text.lastIndexOf("]");
    if(a1>=0 && a2>a1){
      const cand = text.slice(a1, a2+1);
      try{ return {examples: JSON.parse(cand)}; }catch(_){}
    }
    return null;
  }
  function cleanExample(ex){
    if(!ex) return null;
    const jp = (ex.jp || ex.ja || ex.japanese || "").toString().trim();
    const romaji = (ex.romaji || ex.roma || "").toString().trim();
    const id = (ex.id || ex.indonesian || "").toString().trim();
    if(!jp) return null;
    return {jp, romaji, id};
  }
  async function generateExamplesAI(cfg, n=10){
    const prompt = [
      "ã‚ãªãŸã¯ä»‹è­·ç¾å ´ã®æ—¥æœ¬èªæ•™æä½œæˆAIã§ã™ã€‚",
      "å¤–å›½äººä»‹è­·äººæå‘ã‘ã«ã€ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã€ãŒä½¿ã†å£°ã‹ã‘ä¾‹æ–‡ã‚’ä½œã£ã¦ãã ã•ã„ã€‚",
      "æ¡ä»¶:",
      "- ä¸å¯§ã§è‡ªç„¶ã€ç¾å ´ã§ãã®ã¾ã¾ä½¿ãˆã‚‹ã€‚",
      "- æ—¥æœ¬èª(jp)ãƒ»ãƒ­ãƒ¼ãƒå­—(romaji: ãƒ˜ãƒœãƒ³å¼ã€è‹±å­—ã®ã¿ã€æ—¥æœ¬èªæ–‡å­—ãªã—ã€ã§ãã‚Œã°å˜èªé–“ã«ã‚¹ãƒšãƒ¼ã‚¹)ãƒ»ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª(id)ã‚’å¿…ãšä»˜ã‘ã‚‹ã€‚",
      "- é‡è¤‡ã‚’é¿ã‘ã€ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‡ºã™ã€‚",
      `- ä»¶æ•°: ${n}å€‹`,
      cfg.scene ? `Scene: ${cfg.scene}` : "",
      cfg.persona ? `Persona: ${cfg.persona}` : "",
      cfg.category ? `Category: ${cfg.category}` : "",
      cfg.level ? `Level: ${cfg.level}` : "",
      "",
      "å‡ºåŠ›ã¯JSONã®ã¿ã€‚",
      'å½¢å¼: {"examples":[{"jp":"...","romaji":"...","id":"..."}, ... ]}'
    ].filter(Boolean).join("\n");

    const payload = { prompt, trace: { mode: "examples", ...cfg } };
    const res = await callChatAPI(payload);
    const text = (res && (res.ai_reply_jp || res.suggested_reply_jp || res.text || "")) || "";
    const obj = extractJson(text);
    if(!obj || !Array.isArray(obj.examples)) throw new Error("AIä¾‹æ–‡ã®JSONè§£æã«å¤±æ•—");
    const list = obj.examples.map(cleanExample).filter(Boolean);
    if(list.length === 0) throw new Error("AIä¾‹æ–‡ãŒç©ºã§ã—ãŸ");
    return list;
  }
  function applyExample(ex){
    if(!ex) return;
    $("jpInput").value = ex.jp;
    // ãƒ­ãƒ¼ãƒå­—ãŒç©ºãªã‚‰å¾“æ¥ã®ç°¡æ˜“å¤‰æ›ï¼ˆä¿é™ºï¼‰
    $("romaInput").value = ex.romaji || toRomaji(ex.jp);
    if($("idOut") && ex.id) $("idOut").value = ex.id;
    showToast("ä¾‹æ–‡ã‚’å…¥åŠ›ã—ã¾ã—ãŸï¼ˆAIï¼‰");
  }

  $("btnExampleAI")?.addEventListener("click", async () => {
    const cfg = getCfg();
    try{
      showToast("AIã§ä¾‹æ–‡ã‚’ç”Ÿæˆä¸­...");
      const list = await generateExamplesAI(cfg, 12);
      setAIExampleCache(cfg, list);
      applyExample(list[0]);
    }catch(e){
      alert("ä¾‹æ–‡AIã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
      console.error(e);
    }
  });

  // æ—¢å­˜ã®ä¾‹æ–‡ãƒªã‚¹ãƒˆã«ã‚‚AIã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†ã‚’æ··ãœã‚‹ï¼ˆä¾‹æ–‡ãŒå°‘ãªã„å•é¡Œã‚’è§£æ¶ˆï¼‰
  const _getExamplesForCurrent = getExamplesForCurrent;
  getExamplesForCurrent = function(){
    const base = _getExamplesForCurrent();
    const cfg = getCfg();
    const ai = getAIExampleCache(cfg);
    const map = new Map();
    [...(base||[]), ...(ai||[])].forEach(ex=>{
      const c = cleanExample(ex);
      if(c && !map.has(c.jp)) map.set(c.jp, c);
    });
    return Array.from(map.values());
  };


  $("btnExampleJA")?.addEventListener("click", ()=>{
    const ex = pickNextExample();
    if(!ex){ alert("ä¾‹æ–‡ãªã—"); return; }
    setInputJP(ex.jp);
  });

  $("btnExampleRoma")?.addEventListener("click", ()=>{
    // å…¥åŠ›æ–‡ã®ãƒ­ãƒ¼ãƒå­—ã‚’ç¢ºå®Ÿã«è¡¨ç¤ºã™ã‚‹ï¼ˆãƒœã‚¿ãƒ³ã®å­˜åœ¨æ„ç¾©ï¼šè¦‹ã›ã‚‹ï¼‰
    updateRomaFromJP();
  });

  $("btnExampleID")?.addEventListener("click", ()=>{
    const cfg = getConfig();
    const list = getExamplesFor(cfg);
    if(!list.length){ alert("ä¾‹æ–‡ãªã—"); return; }
    const ex = pickNextExample() || list[0];
    if($("suggestedID")) $("suggestedID").textContent = ex.id || "";
  });

  $("btnTest")?.addEventListener("click", ()=>{
    setInputJP("å¤§ä¸ˆå¤«ã§ã™ã€‚ã“ã“ã¯å®‰å…¨ã§ã™ã€‚");
    $("aiReplyJp").textContent = "ï¼ˆãƒ†ã‚¹ãƒˆï¼‰ç›¸æ‰‹ã®è¿”ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    $("feedbackJp").textContent = "ï¼ˆãƒ†ã‚¹ãƒˆï¼‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    $("suggestedJp").textContent = "ï¼ˆãƒ†ã‚¹ãƒˆï¼‰æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    $("suggestedRoma").textContent = kanaToRomaji($("suggestedJp").textContent);
    $("suggestedID").textContent = "ï¼ˆãƒ†ã‚¹ãƒˆï¼‰Terjemahan bahasa Indonesia akan muncul di sini.";
  });

  // å®Ÿè¡Œãƒœã‚¿ãƒ³
  $("btnSend")?.addEventListener("click", runStage1AndMaybeStage2);
  $("btnStage2Only")?.addEventListener("click", runStage2Only);

  // èª­ã¿ä¸Šã’
  $("speakRoma")?.addEventListener("click", ()=> speak($("suggestedRoma")?.textContent || "", "ja-JP"));
  $("speakID")?.addEventListener("click", ()=> speak($("suggestedID")?.textContent || "", "id-ID"));

  // selectãŒå¤‰ã‚ã£ãŸã‚‰ãƒ’ãƒ³ãƒˆã ã‘æ›´æ–°ï¼ˆä¾‹æ–‡ã®å–ã‚Šé•ãˆé˜²æ­¢ï¼‰
  ["sceneSel","personaSel","catSel","levelSel"].forEach(id=>{
    $(id)?.addEventListener("change", ()=>{
      $("hint").textContent = "";
    });
  });

  updateRomaFromJP();
}

document.addEventListener("DOMContentLoaded", bind);
</script>

</body>
</html>
