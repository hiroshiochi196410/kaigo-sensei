<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI</title>
<style>
  body{font-family:system-ui;margin:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,textarea,button{font-size:14px}
  textarea{width:100%;min-height:90px}
  button{padding:6px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid #ddd;border-radius:10px;padding:10px;margin-top:10px}
  .muted{color:#666;font-size:12px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>

<h2>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI</h2>

<div class="row">
  Scene <select id="scene"></select>
  Persona <select id="persona"></select>
  ã‚«ãƒ†ã‚´ãƒª <select id="category"></select>
  ãƒ¬ãƒ™ãƒ« <select id="level"></select>
  <button id="fillExample">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
  <button id="btnStage2">Stage2ç”Ÿæˆ</button>
</div>

<div class="row">
  <button id="btnSpeakJa">ğŸ”Šä¾‹æ–‡(JA)</button>
  <button id="btnSpeakRomaji">ğŸ”Šãƒ­ãƒ¼ãƒå­—</button>
  <button id="btnSpeakId">ğŸ”ŠID</button>
  <button id="btnTest">ğŸ”Šãƒ†ã‚¹ãƒˆ</button>
</div>

<p class="muted" id="status">loadingâ€¦</p>

<textarea id="prompt" placeholder="ã“ã“ã«ä¾‹æ–‡ãŒå…¥ã‚Šã¾ã™"></textarea>

<div class="card">
  <b>Stage2ï¼ˆæ¨å¥¨è¿”ç­”ï¼šç”Ÿæˆï¼‰</b><br><br>

  <b>ãƒ­ãƒ¼ãƒå­—</b>
  <pre id="romaji" class="mono"></pre>

  <br>

  <b>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</b>
  <pre id="indonesian" class="mono"></pre>
</div>

<script>
const $=id=>document.getElementById(id);
let db=null, list=[], idx=-1;
let currentExample=null;
let busy=false;

function setBusy(b){
  busy=b;
  ["fillExample","btnStage2","scene","persona","category","level"].forEach(id=>{
    const el=$(id); if(el) el.disabled=b;
  });
}

function setStatus(s){ $("status").textContent=s; }

async function load(){
  // v2å„ªå…ˆ
  const urls=["./examples.v2.json","./examples.json","/examples.v2.json","/examples.json"];
  for(const u of urls){
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) continue;
      db=await r.json();
      setStatus("examples loaded: "+u);
      init();
      return;
    }catch(e){}
  }
  setStatus("examples not found");
}

function uniq(a){return [...new Set(a.filter(Boolean))];}

function fill(sel,arr){
  sel.innerHTML="<option value=''>å…¨ã¦</option>";
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=o.textContent=v; sel.appendChild(o);
  });
}

function normalizeLevel(v){
  if(!v) return "";
  // UIãŒbasicã§ã‚‚v2å´ãŒbeginnerãªã‚‰å¸å
  if(v==="basic") return "beginner";
  return v;
}

function items(){
  // v2: examples[]
  if(Array.isArray(db?.examples)) return db.examples;
  // v1 fallback
  if(Array.isArray(db?.items)) return db.items;
  return [];
}

function init(){
  const it=items();

  // Scene = categoryï¼ˆbath/meal/toilet/complaint/nightâ€¦ï¼‰
  fill($("scene"), uniq(it.map(x=>x.category)));

  // Persona = persona key
  fill($("persona"), uniq(it.map(x=>x.persona)));

  // Level = levelå€¤ï¼ˆbeginner/intermediateâ€¦ï¼‰ï¼‹UIäº’æ›
  fill($("level"), uniq(it.map(x=>x.level)));

  rebuildSub();
  $("scene").onchange=()=>{ rebuildSub(); idx=-1; currentExample=null; setStatus("æ¡ä»¶å¤‰æ›´"); };
}

function rebuildSub(){
  const s=$("scene").value;
  const subs=uniq(items()
    .filter(x=>!s||x.category===s)
    .map(x=>x.subscene));
  fill($("category"), subs);
}

function filter(){
  const s=$("scene").value;
  const p=$("persona").value;
  const c=$("category").value;
  const lv=normalizeLevel($("level").value);

  return items().filter(x=>
    (!s||x.category===s) &&
    (!p||x.persona===p) &&
    (!c||x.subscene===c) &&
    (!lv||x.level===lv)
  );
}

function putExample(ex){
  currentExample=ex;
  $("prompt").value = ex?.text?.ja || "";
  // ä¾‹æ–‡ã« romaji/id ãŒã‚ã‚‹ãªã‚‰ä»®è¡¨ç¤ºï¼ˆç„¡ã‘ã‚Œã°ç©ºï¼‰
  $("romaji").textContent = ex?.romaji || "";
  $("indonesian").textContent = ex?.text?.id || "";
}

// ä¾‹æ–‡æŠ•å…¥ï¼ˆæŠ¼ã™ãŸã³åˆ‡æ›¿ï¼‰
$("fillExample").onclick=async ()=>{
  list=filter();
  if(!list.length){
    setStatus("è©²å½“ä¾‹æ–‡ãªã—ï¼ˆæ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ï¼‰");
    return;
  }
  idx=(idx+1)%list.length;
  const ex=list[idx];
  putExample(ex);
  setStatus(`ä¾‹æ–‡ ${idx+1}/${list.length}`);

  // å®‰å…¨ã®ãŸã‚ã€Œè‡ªå‹•ç”Ÿæˆã€ã¯ã—ãªã„ï¼ˆé‡ãæ„Ÿã˜ã‚‹ã®ã‚’é¿ã‘ã‚‹ï¼‰
  // å¿…è¦ãªã‚‰ Stage2ç”Ÿæˆ ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†
};

// ===== Stage2ç”Ÿæˆï¼ˆAPIï¼‰ =====
async function callStage2(text){
  const r = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: text,
      mode: "stage2",
      scene: $("scene")?.value || "",
      persona: $("persona")?.value || "",
      category: $("category")?.value || "",
      level: normalizeLevel($("level")?.value || "")
    })
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(no body)");
    throw new Error("API error " + r.status + ": " + t);
  }
  return await r.json();
}

$("btnStage2").onclick=async ()=>{
  const ja = $("prompt").value.trim();
  if(!ja){ alert("å…ˆã«ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹ã‹ã€æ—¥æœ¬èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  try{
    setBusy(true);
    setStatus("Stage2ç”Ÿæˆä¸­â€¦");
    const out = await callStage2(ja);
    // APIã®è¿”å´ã‚­ãƒ¼ã«åˆã‚ã›ã¦è¡¨ç¤º
    const jp = out?.suggested_reply_jp || out?.ai_reply_jp || "";
    $("romaji").textContent = jp;
    $("indonesian").textContent = out?.indonesian || out?.id || out?.text?.id || "";
    // å‚è€ƒï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚„AIè¿”ç­”ã‚’è¦‹ãŸã„å ´åˆã¯ console ã«å‡ºã—ã¦ã„ã‚‹
    console.log("stage2 raw:", out);
    setStatus("Stage2å®Œäº†");
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
    setStatus("Stage2ã‚¨ãƒ©ãƒ¼");
  }finally{
    setBusy(false);
  }
};

// ===== TTS =====
function ttsOK(){ return "speechSynthesis" in window && "SpeechSynthesisUtterance" in window; }

function romajiToNaturalJa(s){
  // åŠ©è©ã ã‘è‡ªç„¶åŒ–ï¼ˆwa/ga/no/ni/de/to/woâ€¦ï¼‰
  let t = (s||"");
  t = t.replace(/\bwa\b/g,"ã¯")
       .replace(/\bga\b/g,"ãŒ")
       .replace(/\bwo\b/g,"ã‚’")
       .replace(/\bno\b/g,"ã®")
       .replace(/\bni\b/g,"ã«")
       .replace(/\bde\b/g,"ã§")
       .replace(/\bto\b/g,"ã¨")
       .replace(/\bkara\b/g,"ã‹ã‚‰")
       .replace(/\bmade\b/g,"ã¾ã§")
       .replace(/\s+/g," ").trim();
  return t;
}

function speak(text, lang){
  if(!ttsOK()){ alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’éå¯¾å¿œã§ã™ï¼ˆChromeæ¨å¥¨ï¼‰"); return; }
  const t=(text||"").trim();
  if(!t){ alert("èª­ã¿ä¸Šã’ã‚‹æ–‡ç« ãŒç©ºã§ã™"); return; }
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t);
  u.lang = (lang==="id") ? "id-ID" : "ja-JP";
  u.rate = (lang==="id") ? 0.9 : 1.0;
  speechSynthesis.speak(u);
}

document.addEventListener("click",(e)=>{
  const b = e.target.closest ? e.target.closest("button") : null;
  if(!b) return;

  if(b.id==="btnTest"){
    speak("ãƒ†ã‚¹ãƒˆã§ã™ã€‚éŸ³ãŒèã“ãˆã¾ã™ã‹ã€‚","ja");
  }
  if(b.id==="btnSpeakJa"){
    speak($("prompt").value,"ja");
  }
  if(b.id==="btnSpeakRomaji"){
    // ãƒ­ãƒ¼ãƒå­—ã‚’æ—¥æœ¬èªTTSã§èª­ã‚€ï¼ˆwa/ni/deç­‰ã ã‘è‡ªç„¶åŒ–ï¼‰
    const fixed = romajiToNaturalJa($("romaji").textContent);
    speak(fixed,"ja");
  }
  if(b.id==="btnSpeakId"){
    speak($("indonesian").textContent,"id");
  }
});

load();
</script>

</body>
</html>
