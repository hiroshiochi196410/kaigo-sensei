<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kaigo-Senseiï¼ˆSSW å…¬é–‹ãƒŸãƒ‹ç‰ˆï¼‰</title>
<style>
  :root{ --bg:#fafafa; --card:#fff; --line:#e5e7eb; --txt:#111; --muted:#666; }
  body{ margin:16px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color:var(--txt); background:var(--bg); }
  h1{ font-size:20px; margin:0 0 8px; }
  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  select, button{ padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; }
  button{ cursor:pointer; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; flex:1; min-width:320px; }
  textarea{ width:100%; min-height:84px; border:1px solid var(--line); border-radius:12px; padding:10px; box-sizing:border-box; }
  .muted{ color:var(--muted); font-size:12px; }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
  .kpi{ margin-left:auto; }
  .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; background:#fff; }
  .speak{ padding:6px 8px; border-radius:999px; }
</style>
</head>
<body>

<h1>ä»‹è­·ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AIï¼ˆSSW å…¬é–‹ãƒŸãƒ‹ç‰ˆï¼‰</h1>
<div class="toolbar">
  <label>ã‚·ãƒ¼ãƒ³ <select id="sceneSel"></select></label>
  <label>ç›¸æ‰‹ <select id="personaSel"></select></label>
  <label>ã‚«ãƒ†ã‚´ãƒª <select id="catSel"></select></label>
  <label>ãƒ¬ãƒ™ãƒ« <select id="levelSel"></select></label>

  <button type="button" id="btnExample">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>

  <span class="kpi muted" id="statusMsg">ä¾‹æ–‡: èª­ã¿è¾¼ã¿æ¸ˆã¿ï¼ˆç›´æ›¸ãï¼‰</span>
</div>

<div class="card" style="margin-top:12px;">
  <div class="muted">ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰</div>
  <textarea id="jpInput" placeholder="ä¾‹æ–‡ãƒœã‚¿ãƒ³ã§å…¥åŠ› / è‡ªç”±å…¥åŠ›"></textarea>

  <div class="muted" style="margin-top:10px;">ä»‹è­·å£«ï¼ˆã‚ãªãŸï¼‰ã®ç™ºè©±ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼šä»»æ„ï¼‰</div>
  <textarea id="romaInput" placeholder="ä»»æ„ï¼ˆç©ºã§ã‚‚OKï¼‰"></textarea>

  <div class="actions">
    <button type="button" id="btnSend">é€ä¿¡</button>
    <button type="button" id="btnStage2Only">Stage2ã ã‘å®Ÿè¡Œ</button>
    <label class="muted"><input type="checkbox" id="autoStage2" checked> Stage2ã‚’è‡ªå‹•å®Ÿè¡Œ</label>
  </div>
  <div class="muted" id="hint">â€» ä¾‹æ–‡ã¯ index.html ç›´æ›¸ãæ–¹å¼ï¼ˆAï¼‰ã€‚ã¾ãšâ€œå¿…ãšå‹•ãâ€ã‚’å„ªå…ˆã€‚</div>
</div>

<div class="row">
  <div class="card">
    <div style="display:flex; align-items:center; gap:8px;">
      <strong>Stage1ï¼ˆæ—¥æœ¬èªï¼‰</strong>
      <span class="pill">AIå¿œç­”</span>
    </div>
    <div id="aiReplyJp" style="margin-top:8px;"></div>
    <div id="feedbackJp" class="muted" style="margin-top:8px;"></div>

    <div class="muted" style="margin-top:12px;">æ¨å¥¨è¿”ç­”ï¼ˆæ—¥æœ¬èªï¼‰</div>
    <textarea id="suggestedJp" placeholder="Stage1å¾Œã«å…¥ã‚Šã¾ã™"></textarea>

    <div class="muted" style="margin-top:10px;">ï¼ˆä¾‹æ–‡ã®æ—¥æœ¬èªï¼‰</div>
    <div class="actions">
      <button class="speak" type="button" id="btnExampleJA">ä¾‹æ–‡ï¼ˆæ—¥æœ¬èªï¼‰</button>
      <button class="speak" type="button" id="btnExampleRoma">ä¾‹æ–‡ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</button>
      <button class="speak" type="button" id="btnExampleID">ä¾‹æ–‡ï¼ˆã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; gap:8px;">
      <strong>Stage2ï¼ˆç¿»è¨³ãƒ»æ¨å¥¨è¿”ç­”ï¼‰</strong>
      <span class="pill">ãƒ­ãƒ¼ãƒå­— / ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</span>
    </div>

    <div class="muted" style="margin-top:10px;">æ¨å¥¨è¿”ç­”ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="suggestedRoma" style="flex:1;"></div>
      <button type="button" class="speak" id="speakRoma" title="èª­ã¿ä¸Šã’ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰">ğŸ”Š</button>
    </div>

    <div class="muted" style="margin-top:12px;">æ¨å¥¨è¿”ç­”ï¼ˆã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="suggestedID" style="flex:1;"></div>
      <button type="button" class="speak" id="speakID" title="èª­ã¿ä¸Šã’ï¼ˆã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰">ğŸ”Š</button>
    </div>
  </div>
</div>

<script>
// ====== å…¬é–‹ãƒŸãƒ‹ç‰ˆï¼ˆAæ–¹å¼ï¼‰ï¼šä¾‹æ–‡ã‚’ index.html ã«å›ºå®š ======
const OPTIONS = {
  scene: [
    {v:"night",    t:"å¤œé–“å¯¾å¿œ"},
    {v:"handover", t:"ç”³ã—é€ã‚Š/å ±å‘Š"},
    {v:"emergency",t:"æ€¥å¤‰"},
    {v:"fall",     t:"è»¢å€’"},
  ],
  persona: [
    {v:"user_calm",        t:"åˆ©ç”¨è€…ï¼šç©ã‚„ã‹"},
    {v:"dementia",         t:"åˆ©ç”¨è€…ï¼šèªçŸ¥ç—‡"},
    {v:"family_complaint", t:"å®¶æ—ï¼šä¸å®‰/ã‚¯ãƒ¬ãƒ¼ãƒ "},
    {v:"jp_staff_senior",  t:"å…ˆè¼©è·å“¡"},
  ],
  category: [
    {v:"calling",  t:"å£°ã‹ã‘"},
    {v:"anxiety",  t:"ä¸å®‰/æ··ä¹±"},
    {v:"report",   t:"ç”³ã—é€ã‚Š/å ±å‘Š"},
    {v:"emergency",t:"æ€¥å¤‰"},
    {v:"fall",     t:"è»¢å€’"},
    {v:"all",      t:"å…¨ã¦"},
  ],
  level: [
    {v:"basic", t:"åˆç´š"},
    {v:"mid",   t:"ä¸­ç´š"},
    {v:"all",   t:"å…¨ã¦"},
  ]
};

const EXAMPLES = {
  night: {
    user_calm: {
      calling: [
        {level:"basic", jp:"çœ ã‚Œãªã„ã§ã™ã‹ï¼Ÿå°‘ã—ãŠè©±ã—ã¾ã—ã‚‡ã†ã€‚", roma:"Nemurenai desu ka? Sukoshi ohanashi shimashou.", id:"Tidak bisa tidur? Mari kita bicara sebentar."},
        {level:"basic", jp:"å¯’ããªã„ã§ã™ã‹ï¼Ÿæ¯›å¸ƒã‚’ã‹ã‘ã¾ã—ã‚‡ã†ã€‚", roma:"Samukunai desu ka? Moufu o kagemashou.", id:"Apakah kedinginan? Saya selimuti ya."},
        {level:"mid",   jp:"å¤œé–“ã‚‚è·å“¡ãŒå®šæœŸçš„ã«å·¡å›ã—ã¦ã„ã¾ã™ã€‚ã”å®‰å¿ƒãã ã•ã„ã€‚", roma:"Yakan mo shokuin ga teikiteki ni junkai shiteimasu. Goanshin kudasai.", id:"Staf berpatroli secara berkala pada malam hari. Silakan tenang."}
      ],
      anxiety: [
        {level:"basic", jp:"ä¸å®‰ã§ã™ã‹ï¼Ÿä½•ãŒå¿ƒé…ã‹æ•™ãˆã¦ãã ã•ã„ã€‚", roma:"Fuan desu ka? Nani ga shinpai ka oshiete kudasai.", id:"Apakah Anda cemas? Tolong ceritakan apa yang dikhawatirkan."},
        {level:"basic", jp:"å¤§ä¸ˆå¤«ã§ã™ã€‚ã“ã“ã«ã„ã¾ã™ã‚ˆã€‚", roma:"Daijoubu desu. Koko ni imasu yo.", id:"Tidak apa-apa. Saya ada di sini."},
        {level:"mid",   jp:"å¿…è¦ãªã‚‰çœ‹è­·å¸«ã«é€£çµ¡ã—ã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚", roma:"Hitsuyou nara kangoshi ni renraku shimasu. Sukoshi matte kudasai.", id:"Jika perlu saya hubungi perawat. Mohon tunggu sebentar."}
      ],
      all: [] // ã¾ã¨ã‚å–ã‚Šç”¨ï¼ˆç©ºã§ã‚‚OKï¼‰
    },
    dementia: {
      calling: [
        {level:"basic", jp:"ã“ã“ã¯æ–½è¨­ã§ã™ã€‚ç§ã¯è·å“¡ã§ã™ã€‚å®‰å¿ƒã—ã¦ãã ã•ã„ã€‚", roma:"Koko wa shisetsu desu. Watashi wa shokuin desu. Anshin shite kudasai.", id:"Ini adalah fasilitas. Saya petugas. Silakan tenang."},
        {level:"basic", jp:"è»¢ã°ãªã„ã‚ˆã†ã«ã€ã‚†ã£ãã‚Šæ­©ãã¾ã—ã‚‡ã†ã€‚", roma:"Korobanai you ni, yukkuri arukimashou.", id:"Agar tidak jatuh, mari berjalan pelan-pelan."}
      ],
      anxiety: [
        {level:"basic", jp:"å¤§ä¸ˆå¤«ã§ã™ã€‚ç§ã¯ã“ã“ã«ã„ã¾ã™ã€‚", roma:"Daijoubu desu. Watashi wa koko ni imasu.", id:"Tidak apa-apa. Saya ada di sini."},
        {level:"mid",   jp:"è½ã¡ç€ãã¾ã§ä¸€ç·’ã«ã„ã¾ã™ã€‚ã‚†ã£ãã‚Šå‘¼å¸ã—ã¾ã—ã‚‡ã†ã€‚", roma:"Ochitsuku made issho ni imasu. Yukkuri kokyuu shimashou.", id:"Saya akan menemani sampai tenang. Mari bernapas pelan-pelan."}
      ],
      all: []
    },
    family_complaint: {
      anxiety: [
        {level:"basic", jp:"ã”å¿ƒé…ã‚’ãŠã‹ã‘ã—ã¦ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚", roma:"Goshinpai o okake shite moushiwake arimasen. Joukyou o kakunin shimasu.", id:"Maaf membuat Anda khawatir. Saya akan cek situasinya."},
        {level:"mid",   jp:"å¤œé–“ã¯å·¡å›ã—ã¦ã„ã¾ã™ã€‚æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°ã™ããŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚", roma:"Yakan wa junkai shiteimasu. Kininaru koto ga areba sugu oshirase kudasai.", id:"Pada malam hari kami berpatroli. Jika ada yang mengkhawatirkan, segera beri tahu kami."}
      ],
      report: [
        {level:"mid", jp:"ç¾åœ¨ã®æ§˜å­ã‚’æ‹…å½“è€…ã‹ã‚‰ç¢ºèªã—ã€ã™ãã«ã”å ±å‘Šã—ã¾ã™ã€‚", roma:"Genzai no yousu o tantousha kara kakunin shi, sugu ni gohoukoku shimasu.", id:"Saya akan konfirmasi ke penanggung jawab dan segera melaporkan kepada Anda."}
      ],
      all: []
    },
    jp_staff_senior: {
      report: [
        {level:"basic", jp:"å…ˆè¼©ã€å¤œé–“ã®æ§˜å­ã‚’å ±å‘Šã—ã¾ã™ã€‚", roma:"Senpai, yakan no yousu o houkoku shimasu.", id:"Senior, saya akan melaporkan kondisi malam ini."},
        {level:"mid",   jp:"ä¸å®‰ãŒå¼·ã‹ã£ãŸã®ã§ã€è¦‹å®ˆã‚Šã‚’å¢—ã‚„ã—ã¦ã„ã¾ã™ã€‚", roma:"Fuan ga tsuyokatta node, mimamori o fuyashiteimasu.", id:"Karena kecemasannya kuat, kami meningkatkan pemantauan."}
      ],
      all: []
    }
  },

  handover: {
    jp_staff_senior: {
      report: [
        {level:"basic", jp:"ç”³ã—é€ã‚Šã§ã™ã€‚å¤œé–“ã®æ§˜å­ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚", roma:"Moushiokuri desu. Yakan no yousu o oshiete kudasai.", id:"Ini serah-terima. Tolong beritahu kondisi malam hari."}
      ],
      all: []
    },
    user_calm: {
      report: [
        {level:"basic", jp:"ç”³ã—é€ã‚Šã§ã™ã€‚å¤œé–“ã¯è½ã¡ç€ã„ã¦ä¼‘ã‚ã¾ã—ãŸã€‚", roma:"Moushiokuri desu. Yakan wa ochitsuite yasumemashita.", id:"Serah-terima: malamnya bisa istirahat dengan tenang."},
        {level:"mid",   jp:"å¤œé–“ã«1å›ãƒˆã‚¤ãƒ¬ä»‹åŠ©ã€‚è»¢å€’ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", roma:"Yakan ni ikkai toire kaijo. Tentou wa arimasen deshita.", id:"Malam hari 1x bantuan toilet. Tidak ada jatuh."}
      ],
      all: []
    },
    dementia: {
      report: [
        {level:"basic", jp:"å¤œé–“ã«ä¸ç©ãŒã‚ã‚Šã¾ã—ãŸãŒã€å£°ã‹ã‘ã§è½ã¡ç€ãã¾ã—ãŸã€‚", roma:"Yakan ni fuon ga arimashita ga, koekake de ochitsukimashita.", id:"Ada gelisah pada malam hari, tapi tenang setelah diarahkan."}
      ],
      all: []
    },
    family_complaint: { all: [] }
  },

  emergency: {
    user_calm: {
      emergency: [
        {level:"basic", jp:"æ¯ãŒè‹¦ã—ã„ã§ã™ã‹ï¼Ÿã™ãçœ‹è­·å¸«ã‚’å‘¼ã³ã¾ã™ã€‚", roma:"Iki ga kurushii desu ka? Sugu kangoshi o yobimasu.", id:"Apakah sulit bernapas? Saya panggil perawat sekarang."},
        {level:"mid",   jp:"è¡€åœ§ã¨SpO2ã‚’ç¢ºèªã—ã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚", roma:"Ketsuatsu to SpO2 o kakunin shimasu. Sukoshi matte kudasai.", id:"Saya akan cek tekanan darah dan SpO2. Mohon tunggu sebentar."}
      ],
      calling: [
        {level:"basic", jp:"å¤§ä¸ˆå¤«ã§ã™ã€‚æ¥½ãªå§¿å‹¢ã«ã—ã¾ã—ã‚‡ã†ã€‚", roma:"Daijoubu desu. Raku na shisei ni shimashou.", id:"Tidak apa-apa. Mari atur posisi yang nyaman."}
      ],
      all: []
    },
    jp_staff_senior: {
      report: [
        {level:"basic", jp:"å…ˆè¼©ã€æ€¥å¤‰ã§ã™ã€‚ã™ãæ¥ã¦ãã ã•ã„ã€‚", roma:"Senpai, kyuuhen desu. Sugu kite kudasai.", id:"Senior, kondisi darurat. Tolong segera datang."},
        {level:"mid",   jp:"å‘¼å¸çŠ¶æ…‹æ‚ªåŒ–ã€‚ãƒã‚¤ã‚¿ãƒ«ç¢ºèªä¸­ã§ã™ã€‚", roma:"Kokyuu joutai akka. Baitaru kakunin chuu desu.", id:"Kondisi napas memburuk. Sedang cek tanda vital."}
      ],
      all: []
    },
    dementia: { all: [] },
    family_complaint: { all: [] }
  },

  fall: {
    user_calm: {
      fall: [
        {level:"basic", jp:"è»¢ã³ã¾ã—ãŸã‹ï¼Ÿç—›ã„ã¨ã“ã‚ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", roma:"Korobimashita ka? Itai tokoro wa arimasu ka?", id:"Apakah jatuh? Ada yang sakit?"},
        {level:"mid",   jp:"å‹•ã‹ãªã„ã§ãã ã•ã„ã€‚å®‰å…¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰èµ·ã“ã—ã¾ã™ã€‚", roma:"Ugokanaide kudasai. Anzen o kakunin shite kara okoshimasu.", id:"Jangan bergerak dulu. Kami akan bantu setelah memastikan aman."}
      ],
      safety: [
        {level:"basic", jp:"æ»‘ã‚Šã‚„ã™ã„ã®ã§ã€ã‚†ã£ãã‚Šæ­©ãã¾ã—ã‚‡ã†ã€‚", roma:"Suberiyasui node, yukkuri arukimashou.", id:"Lantainya licin, mari berjalan pelan-pelan."}
      ],
      all: []
    },
    jp_staff_senior: {
      report: [
        {level:"basic", jp:"å…ˆè¼©ã€è»¢å€’ã§ã™ã€‚å¿œæ´ãŠé¡˜ã„ã—ã¾ã™ã€‚", roma:"Senpai, tentou desu. Ouen onegaishimasu.", id:"Senior, ada jatuh. Mohon bantuan."},
        {level:"mid",   jp:"é ­éƒ¨æ‰“æ’²ã®å¯èƒ½æ€§ã€‚æ„è­˜ç¢ºèªä¸­ã§ã™ã€‚", roma:"Toubu daboku no kanousei. Ishiki kakunin chuu desu.", id:"Kemungkinan benturan kepala. Sedang cek kesadaran."}
      ],
      all: []
    },
    dementia: {
      fall: [
        {level:"basic", jp:"å¤§ä¸ˆå¤«ã§ã™ã€‚ã‚†ã£ãã‚Šåº§ã‚Šã¾ã—ã‚‡ã†ã€‚", roma:"Daijoubu desu. Yukkuri suwarimashou.", id:"Tidak apa-apa. Mari duduk pelan-pelan."}
      ],
      all: []
    },
    family_complaint: {
      report: [
        {level:"mid", jp:"è»¢å€’ãŒã‚ã‚Šã¾ã—ãŸã€‚çŠ¶æ…‹ã‚’ç¢ºèªã—ã€å¯¾å¿œã‚’èª¬æ˜ã—ã¾ã™ã€‚", roma:"Tentou ga arimashita. Joutai o kakunin shi, taiou o setsumei shimasu.", id:"Terjadi jatuh. Kami akan cek kondisi dan menjelaskan penanganannya."}
      ],
      all: []
    }
  }
};

function $(id){ return document.getElementById(id); }
function fillSelect(id, list, defV){
  const sel = $(id);
  sel.innerHTML = "";
  list.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o.v; opt.textContent = o.t;
    sel.appendChild(opt);
  });
  sel.value = defV ?? (list[0]?.v || "");
}

function getFilteredExamples(){
  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const cat = $("catSel").value;
  const level = $("levelSel").value;

  const sc = EXAMPLES[scene] || {};
  const pe = sc[persona] || {};
  let pool = [];

  // category=all ã®ã¨ãã¯å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é›†ã‚ã‚‹
  if (cat === "all") {
    for (const k of Object.keys(pe)) {
      if (Array.isArray(pe[k])) pool.push(...pe[k]);
    }
  } else {
    if (Array.isArray(pe[cat])) pool.push(...pe[cat]);
  }

  // ãã®scene/personaé…ä¸‹ã§0ä»¶ãªã‚‰ã€æœ€ä½é™ fallbackï¼ˆcalling/anxiety/report ç­‰ï¼‰ã‚’ç·å½“ãŸã‚Š
  if (pool.length === 0) {
    const fallbackCats = ["calling","anxiety","report","emergency","fall","safety"];
    fallbackCats.forEach(k=>{ if (Array.isArray(pe[k])) pool.push(...pe[k]); });
  }

  // ãƒ¬ãƒ™ãƒ«çµã‚Šè¾¼ã¿ï¼ˆallãªã‚‰ãã®ã¾ã¾ï¼‰
  if (level !== "all") {
    const filtered = pool.filter(x => !x.level || x.level === "all" || x.level === level);
    if (filtered.length > 0) pool = filtered;
  }

  return pool;
}

function pickOne(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function insertExample(){
  const pool = getFilteredExamples();
  if (!pool || pool.length === 0) {
    alert("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚\nè‡ªç”±å…¥åŠ›ã§ç¶šã‘ã¾ã—ã‚‡ã†ã€‚");
    return;
  }
  const ex = pickOne(pool);
  $("jpInput").value = ex.jp || "";
  $("romaInput").value = ex.roma || "";
  // ä¾‹æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆStage2æ¬„ã«è¡¨ç¤ºï¼‰
  $("suggestedRoma").textContent = ex.roma || "";
  $("suggestedID").textContent = ex.id || "";
  $("statusMsg").textContent = `ä¾‹æ–‡: ${pool.length}ä»¶ï¼ˆç›´æ›¸ãï¼‰`;
}

function speak(text, lang){
  try{
    if (!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    if (lang) u.lang = lang;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(_){}
}

$("speakRoma").addEventListener("click", ()=> speak($("suggestedRoma").textContent || "", "ja-JP"));
$("speakID").addEventListener("click", ()=> speak($("suggestedID").textContent || "", "id-ID"));

$("btnExample").addEventListener("click", insertExample);

// ä¾‹æ–‡ãƒœã‚¿ãƒ³ï¼ˆã‚µãƒ–ï¼‰
$("btnExampleJA").addEventListener("click", ()=> {
  const pool = getFilteredExamples();
  const ex = pool.length ? pickOne(pool) : null;
  if (!ex) return alert("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
  $("jpInput").value = ex.jp || "";
});
$("btnExampleRoma").addEventListener("click", ()=> {
  const pool = getFilteredExamples();
  const ex = pool.length ? pickOne(pool) : null;
  if (!ex) return alert("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
  $("romaInput").value = ex.roma || "";
});
$("btnExampleID").addEventListener("click", ()=> {
  const pool = getFilteredExamples();
  const ex = pool.length ? pickOne(pool) : null;
  if (!ex) return alert("ã“ã®æ¡ä»¶ã®ä¾‹æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
  $("suggestedID").textContent = ex.id || "";
});

async function callApi(payload){
  const r = await fetch("/api/chat", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  let data = {};
  try{ data = await r.json(); }catch(_){}
  if (!r.ok) {
    const msg = data?.error || data?.message || `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return data;
}

function safeText(x){
  if (x == null) return "";
  if (typeof x === "string") return x;
  try{ return JSON.stringify(x); }catch(_){ return String(x); }
}

async function runStage1(){
  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;
  const jp = $("jpInput").value.trim();
  const roma = $("romaInput").value.trim();

  if (!jp) { alert("æ—¥æœ¬èªå…¥åŠ›ãŒç©ºã§ã™"); return; }

  $("statusMsg").textContent = "é€ä¿¡ä¸­â€¦";
  const payload = { track:"ssw", stage:1, scene, persona, category, level, jp, roma };

  try{
    const data = await callApi(payload);

    $("aiReplyJp").textContent = safeText(data.aiReplyJp ?? data.reply_jp ?? data.reply ?? data.stage1 ?? data.message);
    $("feedbackJp").textContent = safeText(data.feedbackJp ?? data.feedback ?? "");
    $("suggestedJp").value = safeText(data.suggestedJp ?? data.suggested_jp ?? data.suggestion_jp ?? "");

    // Stage2å€™è£œï¼ˆè¿”ã£ã¦ããŸã‚‰åæ˜ ï¼‰
    $("suggestedRoma").textContent = safeText(data.suggestedRoma ?? data.suggested_roma ?? "");
    $("suggestedID").textContent = safeText(data.suggestedID ?? data.suggested_id ?? data.suggested_idn ?? "");

    $("statusMsg").textContent = "é€ä¿¡OK";
    if ($("autoStage2").checked) await runStage2();
  }catch(e){
    $("statusMsg").textContent = "é€ä¿¡å¤±æ•—: " + e.message;
  }
}

async function runStage2(){
  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;

  const baseJp = $("suggestedJp").value.trim() || $("jpInput").value.trim();
  if (!baseJp) { return; }

  $("statusMsg").textContent = "Stage2ä¸­â€¦";
  const payload = { track:"ssw", stage:2, scene, persona, category, level, jp: baseJp };

  try{
    const data = await callApi(payload);
    $("suggestedRoma").textContent = safeText(data.roma ?? data.suggestedRoma ?? data.suggested_roma ?? "");
    $("suggestedID").textContent = safeText(data.id ?? data.idn ?? data.suggestedID ?? data.suggested_id ?? "");
    $("statusMsg").textContent = "Stage2 OK";
  }catch(e){
    // APIãŒStage2æœªå¯¾å¿œã§ã‚‚ã€ä¾‹æ–‡ãƒ¢ãƒ¼ãƒ‰ã¯å£Šã•ãªã„
    $("statusMsg").textContent = "Stage2å¤±æ•—: " + e.message;
  }
}

$("btnSend").addEventListener("click", runStage1);
$("btnStage2Only").addEventListener("click", runStage2);

// åˆæœŸåŒ–
fillSelect("sceneSel", OPTIONS.scene, "night");
fillSelect("personaSel", OPTIONS.persona, "user_calm");
fillSelect("catSel", OPTIONS.category, "calling");
fillSelect("levelSel", OPTIONS.level, "basic");

// ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
["sceneSel","personaSel","catSel","levelSel"].forEach(id=>{
  $(id).addEventListener("change", ()=> {
    const pool = getFilteredExamples();
    $("statusMsg").textContent = `ä¾‹æ–‡: ${pool.length}ä»¶ï¼ˆç›´æ›¸ãï¼‰`;
  });
});
</script>

</body>
</html>
