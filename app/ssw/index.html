<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>介護ロールプレイAI（日本語×ローマ字×インドネシア語）</title>
  <!-- プラン管理ライブラリ -->
  <script src="/plan-manager.js"></script>
  <script src="/medical-dictionary.js"></script>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --bd:#e5e7eb; --txt:#111827; --muted:#6b7280;
      --btn:#111827; --btnTxt:#fff; --btn2:#f3f4f6;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
    header{ padding:14px 16px; border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:5;}
    header h1{ margin:0; font-size:18px; }
    header .sub{ margin-top:4px; color:var(--muted); font-size:12px;}
    main{ max-width:980px; margin:0 auto; padding:14px 12px 70px;}
    .grid{ display:grid; gap:10px; }
    @media(min-width:900px){ .grid{ grid-template-columns: 360px 1fr; align-items:start; } }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:12px; box-shadow: 0 1px 0 rgba(0,0,0,.02);}
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    select, textarea, input[type="text"]{ width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; font-size:14px; background:#fff;}
    textarea{ min-height:92px; resize: vertical;}
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    button{ border:1px solid var(--bd); background:var(--btn2); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; }
    button.primary{ background:var(--btn); color:var(--btnTxt); border-color:var(--btn); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--bd); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); background:#fff;}
    .history{ display:flex; flex-direction:column; gap:10px; }
    .msg{ border:1px solid var(--bd); border-radius:12px; padding:10px; background:#fff; }
    .msg .who{ font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:8px;}
    .msg .tri{ margin-top:8px; display:grid; gap:8px;}
    .tri .line{ padding:8px; border:1px dashed var(--bd); border-radius:10px; }
    .tri .k{ font-size:11px; color:var(--muted); margin-bottom:4px;}
    .tri .v{ white-space:pre-wrap; font-size:14px; }
    .small{ font-size:12px; color:var(--muted); }
    .err{ color:#b91c1c; font-size:12px; white-space:pre-wrap; }
    .ok{ color:#065f46; font-size:12px; }
    .split{ display:grid; gap:10px; }
    @media(min-width:900px){ .split{ grid-template-columns: 1fr 1fr; } }
    .lock{ position:fixed; inset:0; background:rgba(17,24,39,.65); display:none; align-items:center; justify-content:center; padding:14px; z-index:99;}
    .lock .panel{ width:min(560px, 100%); background:#fff; border-radius:14px; padding:14px; border:1px solid var(--bd);}
    .lock h2{ margin:0 0 6px; font-size:18px;}
    .lock p{ margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.5;}
    .lock .codeRow{ display:flex; gap:8px; margin-top:10px;}
    .lock .codeRow input{ flex:1; }
    .footerBar{ position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--bd); background:#fff; padding:10px 12px; z-index:10;}
    .footerBar .wrap{ max-width:980px; margin:0 auto; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  
    /* ===== TTS / highlight / stats ===== */
    .kRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .kBtns{ display:flex; gap:6px; }
    .ttsBtn{ border:1px solid var(--bd); background:#fff; padding:4px 8px; border-radius:999px; font-size:12px; cursor:pointer; }
    .ttsBtn:active{ transform: translateY(1px); }
    mark.hlDanger{ background:#ffe4e6; padding:0 2px; border-radius:6px; }
    mark.hlKeigo{ background:#dbeafe; padding:0 2px; border-radius:6px; }
    .annoList{ margin:0; padding-left:18px; }
    .annoList li{ margin:4px 0; }
    .statRow{ display:grid; grid-template-columns: 72px 1fr 52px; gap:8px; align-items:center; margin:6px 0; }
    .statBar{ height:10px; border:1px solid var(--bd); border-radius:999px; background:#fff; overflow:hidden; }
    .statFill{ height:100%; background:#111827; width:0%; }
    .statVal{ text-align:right; font-variant-numeric: tabular-nums; }

  
/* --- plan choice (Light/PRO) --- */
.planChoice{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px}
.planOpt{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:#fff}
.planOpt input{margin:0}
.planName{font-weight:700}
.planPrice{color:var(--muted); font-size:12px}



/* --- SBAR chips --- */
.chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
.chip{ display:flex; align-items:center; gap:6px; border:1px solid var(--bd); border-radius:999px; padding:6px 10px; background:#fff; font-size:13px; cursor:pointer; user-select:none; }
.chip input{ margin:0; }
.sbarNote{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.5; }
.sbarGrid{ display:grid; gap:8px; grid-template-columns: 1fr; }
@media(min-width:720px){ .sbarGrid{ grid-template-columns: 1fr 1fr 1fr; } }

/* small UX helpers */
.flashFocus{ outline:2px solid #111827; box-shadow: 0 0 0 3px rgba(17,24,39,.12); }

</style>
</head>
<body>
  <header>
    <h1>介護ロールプレイAI <span class="pill" id="variantPill">variant</span> <span class="pill" id="planInfo">プラン取得中...</span></h1>
    <div class="sub">日本語・ローマ字・インドネシア語の3段表示で、介護現場の会話練習。</div>
    <!-- 使用回数表示 -->
    <div id="usageInfo" style="margin-top:8px;padding:8px 12px;background:#f3f4f6;border-radius:8px;text-align:center;font-weight:600;font-size:13px;"></div>
  </header>

  <main class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>シーン</label>
          <select id="sceneSel"></select>
        </div>
        <div>
          <label>相手（ペルソナ）</label>
          <select id="personaSel"></select>
        </div>
      </div>

      <!-- 転倒：5W1H＋たいおう（看護師／師長／リーダーへ報告） -->
<div id="fallPanel" class="card" style="margin-top:10px; display:none;">
  <label>転倒報告（5W1H＋たいおう）</label>
  <div class="sbarNote">チェックして「転倒報告文を作る」を押すと、入力欄に入ります（わかる はんいで OK）。</div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>利用者名（任意）</label>
      <input type="text" id="fallName" placeholder="例：たなか" />
    </div>
    <div>
      <label>いつ（任意）</label>
      <input type="text" id="fallWhen" placeholder="例：10じ すぎ / 5ぷんまえ" />
    </div>
    <div>
      <label>どこ（任意）</label>
      <input type="text" id="fallWhere" placeholder="例：といれ の まえ / ろうか" />
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>じょうきょう（任意）</label>
      <input type="text" id="fallSituation" placeholder="例：あるいて いる とちゅう / いどうちゅう / りしょうちゅう" />
    </div>
  </div>


  <div class="row" style="margin-top:10px;">
    <div>
      <label>しゅつりょく けいしき</label>
      <select id="fallFormat">
        <option value="narrative">こうとう（ぶん）</option>
        <option value="items">きろく（こうもく）</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>げんいん（任意）</label>
      <input type="text" id="fallCause" placeholder="例：すべった／つまづいた／ふらつき" />
    </div>
    <div>
      <label>はっけん（任意）</label>
      <input type="text" id="fallFound" placeholder="例：スタッフ が はっけん／こえかけ で きづいた" />
    </div>
  </div>

  <div style="margin-top:10px;">
    <label>けが／ようす（チェック）</label>
    <div class="chips">
      <label class="chip"><input type="checkbox" id="fallHead"> あたま を うった かのうせい</label>
      <label class="chip"><input type="checkbox" id="fallBleed"> しゅっけつ あり</label>
      <label class="chip"><input type="checkbox" id="fallPain"> いたみ あり</label>
      <label class="chip"><input type="checkbox" id="fallAms"> いしき が いつもと ちがう</label>
      <label class="chip"><input type="checkbox" id="fallVomit"> おうと あり</label>
      <label class="chip"><input type="checkbox" id="fallFract"> こっせつ の うたがい</label>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label>いたみ の ばしょ（任意）</label>
        <input type="text" id="fallPainPart" placeholder="例：みぎ ひざ / こし / かた" />
      </div>
      <div>
        <label>そのた（任意）</label>
        <input type="text" id="fallOther" placeholder="例：すりきず / あざ / ふらつき" />
      </div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <label>すうち（わかる はんいで）</label>
    <div class="sbarGrid">
      <div>
        <label>たいおん（ど）</label>
        <input type="text" id="fallTemp" placeholder="例：36.8" />
      </div>
      <div>
        <label>えすぴーおーつー（%）</label>
        <input type="text" id="fallSpo2" placeholder="例：96" />
      </div>
      <div>
        <label>みゃく（/ふん）</label>
        <input type="text" id="fallPulse" placeholder="例：90" />
      </div>
      <div>
        <label>けつあつ</label>
        <input type="text" id="fallBp" placeholder="例：120/70" />
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>いま した たいおう（任意）</label>
      <input type="text" id="fallAction" placeholder="例：あんせい、かんごし に れんらく、きず を ひやす" />
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>よぼう（任意）</label>
      <input type="text" id="fallPrevent" placeholder="例：みまもり きょうか、くつ の かくにん、へや の せいり" />
    </div>
  </div>

  <div class="btnRow" style="margin-top:10px;">
    <button id="btnFallBuild" type="button">転倒報告文を作る</button>
    <button id="btnFallClear" type="button">クリア</button>
  </div>

  <div class="sbarNote">※「転倒」では、あいて が かんごし／しちょう／りーだー のときが しぜんです（えらんだ あいて に あわせて ほうこく の いいかた が かわります）。</div>
</div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>カテゴリ</label>
          <select id="catSel"></select>
        </div>
        <div>
          <label>レベル</label>
          <select id="levelSel">
            <option value="beginner">初級</option>
            <option value="intermediate">中級</option>
            <option value="advanced">上級</option>
          </select>
        </div>
      </div>

<!-- 急変：SBAR（看護師／医師へ報告） -->
<div id="sbarPanel" class="card" style="margin-top:10px; display:none;">
  <label>急変SBAR（看護師／医師へ報告）</label>
  <div class="sbarNote">チェックして「SBAR文を作る」を押すと、入力欄に入ります（数字はそのままでOK）。</div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>利用者名（任意）</label>
      <input type="text" id="sbarName" placeholder="例：たなか" />
    </div>
    <div>
      <label>いつから（任意）</label>
      <input type="text" id="sbarOnset" placeholder="例：30ぷんまえ から" />
    </div>
  </div>

  <div style="margin-top:10px;">
    <label>きづいたこと（チェック）</label>
    <div class="chips">
      <label class="chip"><input type="checkbox" id="sbarFever"> ねつ が ある</label>
      <label class="chip"><input type="checkbox" id="sbarDyspnea"> いきが くるしい／えすぴーおーつー が ひくい</label>
      <label class="chip"><input type="checkbox" id="sbarAms"> いしき の へんか（ぼんやり）</label>
      <label class="chip"><input type="checkbox" id="sbarVomit"> おうと（はいた）</label>
      <label class="chip"><input type="checkbox" id="sbarChest"> むね の いたみ</label>
      <label class="chip"><input type="checkbox" id="sbarHypo"> ていけっとう の うたがい（けっとう が ひくい）</label>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label>そのた（任意）</label>
        <input type="text" id="sbarOther" placeholder="例：あせが ひどい / ふらつく" />
      </div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <label>すうち（わかる はんいで）</label>
    <div class="sbarGrid">
      <div>
        <label>たいおん（ど）</label>
        <input type="text" id="sbarTemp" placeholder="例：38.2" />
      </div>
      <div>
        <label>えすぴーおーつー（%）</label>
        <input type="text" id="sbarSpo2" placeholder="例：92" />
      </div>
      <div>
        <label>みゃく（/ふん）</label>
        <input type="text" id="sbarPulse" placeholder="例：110" />
      </div>
      <div>
        <label>けつあつ</label>
        <input type="text" id="sbarBp" placeholder="例：90/60" />
      </div>
      <div>
        <label>こきゅう（/ふん）</label>
        <input type="text" id="sbarRr" placeholder="例：28" />
      </div>
      <div>
        <label>けっとう（mg/dL）</label>
        <input type="text" id="sbarGlucose" placeholder="例：60" />
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>はいけい（任意）</label>
      <input type="text" id="sbarBg" placeholder="例：こうけつあつ、とうにょうびょう / いつもは おだやか" />
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <label>いま した たいおう（任意）</label>
      <input type="text" id="sbarAction" placeholder="例：あんせい、たいおんそくてい、さんそ じゅんび" />
    </div>
  </div>

  <div class="btnRow" style="margin-top:10px;">
    <button id="btnSbarBuild" type="button">SBAR文を作る</button>
    <button id="btnSbarClear" type="button">クリア</button>
  </div>

  <div class="ok" id="sbarLocalMsg" style="display:none; margin-top:8px;"></div>

  <div class="sbarNote">※「急変」では、あいて が かんごし／いし のときが いちばん しぜんです（えらんだ あいて に あわせて いらい の いいかた が かわります）。</div>
</div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>入力言語</label>
          <select id="langSel">
            <option value="auto">自動判定</option>
            <option value="ja">日本語</option>
            <option value="id">インドネシア語</option>
          </select>
        </div>
        <div>
          <label>表示</label>
          <select id="displayMode">
            <option value="all">3段（推奨）</option>
            <option value="ja">日本語のみ</option>
            <option value="id">インドネシア語のみ</option>
            <option value="roma">ローマ字のみ</option>
          </select>
        </div>
      </div>


      <div class="row" style="margin-top:10px;">
        <div>
          <label>選択肢の表示（UI）</label>
          <select id="uiLabelMode">
            <option value="jp_id">日本語＋ID（推奨）</option>
            <option value="jp">日本語のみ</option>
            <option value="id">インドネシア語のみ</option>
          </select>
        </div>
        <div>
          <label>母国語（表示）</label>
          <input type="text" value="インドネシア語" disabled />
        </div>
      </div>


      <div class="row" style="margin-top:10px;">
        <div>
          <label>音声読み上げ（TTS）</label>
          <select id="ttsSel">
            <option value="off">OFF</option>
            <option value="hira" selected>ひらがな</option>
            <option value="roma">ローマ字</option>
            <option value="both">両方</option>
          </select>
        </div>
        <div>
          <label>速度</label>
          <select id="ttsRate">
            <option value="0.8">ゆっくり</option>
            <option value="1" selected>ふつう</option>
            <option value="1.2">はやめ</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>自動読み上げ</label>
          <select id="ttsAuto">
            <option value="off" selected>OFF</option>
            <option value="ai">AIの返事だけ</option>
            <option value="both">あなた＋AI</option>
          </select>
        </div>
        <div>
          <label>読み上げ停止</label>
          <button id="btnStopTts" type="button">停止</button>
        </div>
      </div>

      <div class="btnRow">
        <button id="btnExample" type="button">例文を入れる</button>
        <button id="btnClear" type="button">履歴クリア</button>
      </div>

      <div style="margin-top:10px;">
        <label>あなたの発話（日本語 or インドネシア語）</label>
        <textarea id="userInput" placeholder="例：ゆっくりで大丈夫ですよ。 / Pelan-pelan saja ya."></textarea>
        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">送信</button>
          <span class="small" id="trialInfo"></span>
        </div>
        <div class="err" id="errBox" style="display:none;"></div>
        <div class="ok" id="okBox" style="display:none;"></div>
      </div>

      <div style="margin-top:10px;" class="split">
        <div class="card" style="margin:0;">
          <label>AIからのフィードバック（日本語）</label>
          <div id="feedbackBox" class="small" style="white-space:pre-wrap;">—</div>
        </div>
        <div class="card" style="margin:0;">
          <label>次に言うと良い一言（3段）</label>
          <div id="suggestBox" class="small" style="white-space:pre-wrap;">—</div>
          <div class="btnRow" style="margin-top:8px;">
            <button class="ttsBtn" id="btnSpeakSuggestHira" type="button">▶ ひらがな</button>
            <button class="ttsBtn" id="btnSpeakSuggestRoma" type="button">▶ ローマ字</button>
          </div>

        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <label>注釈（危険ワード／敬語ポイント）</label>
        <div id="annoBox" class="small" style="white-space:pre-wrap;">—</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="align-items:center;">
        <div class="pill">会話履歴</div>
        <div class="small" id="statusPill" style="margin-left:auto;">準備中…</div>
      </div>
      
      <div class="card" style="margin:10px 0;">
        <div class="row" style="align-items:center;">
          <div class="pill">学習ログ</div>
          <button id="btnResetLog" type="button" style="margin-left:auto;">リセット</button>
        </div>
        <div id="logBox" class="small">—</div>
      </div>

<div class="history" id="history"></div>
    </section>
  </main>

  <div class="footerBar">
    <div class="wrap">
      <div class="small">Tip: 日本語は「ひらがな」にもして出すので、読み上げ練習に使えます。</div>
      <div class="small mono" id="apiState">api: /api/chat</div>
    </div>
  </div>

  <!-- Paywall -->
  <div class="lock" id="lock">
    <div class="panel">
      <h2>お試し回数を使い切りました</h2>
      <p>続きは有料（Stripe）で解除できます。<br>もしくは管理者用の解除コードでも解除できます。</p>
    <div class="planChoice">
      <label class="planOpt">
        <input type="radio" name="plan" value="ssw_standard" checked>
        <span class="planName">SSW Standard</span>
        <span class="planPrice">¥2,680/月</span>
      </label>
      <label class="planOpt">
        <input type="radio" name="plan" value="ssw_pro">
        <span class="planName">SSW Pro</span>
        <span class="planPrice">¥4,980/月</span>
      </label>
    </div>

<div class="btnRow">
        <button class="primary" id="btnPay">Stripeで購読して解除</button>
        <button id="btnCloseLock">閉じる</button>
      </div>
      <div class="codeRow">
        <input type="text" id="unlockCode" placeholder="解除コードを入力" />
        <button id="btnUnlock">解除</button>
      </div>
      <div class="small" id="lockMsg" style="margin-top:8px;"></div>
    </div>
  </div>


  <div style="text-align:center;padding:14px 10px;color:#666;font-size:12px;">
    <a href="/future-promise/" target="_blank" rel="noopener" style="color:#444;text-decoration:none;border-bottom:1px solid rgba(0,0,0,.2);padding-bottom:2px;">
      未来への約束プロジェクト / AIPURU-HU Promise Initiative
    </a>
  </div>

<script>
/* ========= helpers ========= */
const $ = (id) => document.getElementById(id);
const esc = (s) => (s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const ls = {
  get(k, d=null){ try{ const v=localStorage.getItem(k); return v==null?d:JSON.parse(v);}catch(e){return d;} },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  del(k){ try{ localStorage.removeItem(k); }catch(e){} }
};

function detectVariantFromPath(){
  const p = location.pathname || "/";
  const m = p.match(/\/app\/(trainee|ssw)(\/|$)/);
  return m ? m[1] : "trainee";
}

function detectLangAuto(text){
  // ざっくり：ひらがな・カタカナ・漢字が含まれれば ja
  if (/[ぁ-んァ-ヶ一-龠]/.test(text)) return "ja";
  // a-z の比率が高ければ id とみなす（ざっくり）
  if (/[a-zA-Z]/.test(text)) return "id";
  return "auto";
}

/* ========= TTS / annotation / stats helpers ========= */
const DEFAULT_SETTINGS = { ttsSel:"hira", ttsRate:"1", ttsAuto:"off", uiLabelMode:"jp_id" };
let _voices = [];

// ==============================
// Google TTS（MP3生成→audio再生 + IndexedDBキャッシュ）
// 使い方：既存の「▶」ボタンは speakOnce / speakSequence を呼ぶ設計のまま動きます
// ==============================

let __ttsAudio = null;
let __ttsAbort = null;

function stopTTS() {
  try {
    if (__ttsAbort) __ttsAbort.abort();
  } catch (e) {}
  __ttsAbort = null;

  if (__ttsAudio) {
    try { __ttsAudio.pause(); } catch (e) {}
    try { __ttsAudio.currentTime = 0; } catch (e) {}
  }
  __ttsAudio = null;

  // 念のため（旧ブラウザTTSが残っている場合）
  try {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
  } catch (e) {}
}

// 旧コード互換：初期化で stopTts を参照する箇所があるため
function stopTts(){
  return stopTTS();
}

function speedLabelToRate(label) {
  // UIの値に合わせて調整
  if (label === 'ゆっくり') return 0.85;
  if (label === 'はやめ') return 1.15;
  return 1.0; // ふつう
}

// --- IndexedDB（シンプル実装）
const TTS_DB_NAME = 'kaigo_sensei_tts_db';
const TTS_STORE = 'audio';
const TTS_DB_VER = 1;

function openTtsDb() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(TTS_DB_NAME, TTS_DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(TTS_STORE)) {
        db.createObjectStore(TTS_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbGet(key) {
  const db = await openTtsDb();
  return new Promise((resolve) => {
    const tx = db.transaction(TTS_STORE, 'readonly');
    const st = tx.objectStore(TTS_STORE);
    const req = st.get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => resolve(null);
  });
}

async function idbSet(key, value) {
  const db = await openTtsDb();
  return new Promise((resolve) => {
    const tx = db.transaction(TTS_STORE, 'readwrite');
    const st = tx.objectStore(TTS_STORE);
    const req = st.put(value, key);
    req.onsuccess = () => resolve(true);
    req.onerror = () => resolve(false);
  });
}

// --- ハッシュキー作成（テキストが長いので短くする）
async function sha256Hex(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

async function fetchTtsMp3Blob(text, rate, signal) {
  const resp = await fetch('/api/tts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, rate }),
    signal
  });

  if (!resp.ok) {
    const msg = await resp.text().catch(() => '');
    throw new Error(msg || ('TTS error: ' + resp.status));
  }

  const blob = await resp.blob();
  if (!blob || blob.size === 0) throw new Error('TTS error: empty audio');
  return blob;
}

function playBlob(blob) {
  return new Promise((resolve, reject) => {
    stopTTS();

    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    __ttsAudio = audio;

    audio.onended = () => {
      try { URL.revokeObjectURL(url); } catch (e) {}
      resolve();
    };
    audio.onerror = () => {
      try { URL.revokeObjectURL(url); } catch (e) {}
      reject(new Error('audio play error'));
    };

    // iOS Safari対策：ユーザー操作（クリック）から直で呼ばれる前提
    audio.play().then(() => {
      // OK
    }).catch(err => {
      try { URL.revokeObjectURL(url); } catch (e) {}
      reject(err);
    });
  });
}

// 既存UI互換：単発再生
async function speakOnce(text, speedLabel='ふつう') {
  try {
    if (!text || !text.trim()) return;
    const rate = speedLabelToRate(speedLabel);

    // キャッシュキー（rateも含める）
    const key = await sha256Hex('ja|' + rate + '|' + text.trim());
    let cached = await idbGet(key);

    if (!cached) {
      __ttsAbort = new AbortController();
      const blob = await fetchTtsMp3Blob(text.trim(), rate, __ttsAbort.signal);
      __ttsAbort = null;
      cached = blob;
      // 失敗しても再生は続ける
      idbSet(key, blob).catch(() => {});
    }

    await playBlob(cached);
  } catch (e) {
    console.error('[TTS] speakOnce error', e);
    alert('音声再生エラー：' + (e && e.message ? e.message : e));
  }
}

// 既存UI互換：連続再生
async function speakSequence(texts, speedLabel='ふつう') {
  try {
    if (!Array.isArray(texts) || texts.length === 0) return;
    for (const t of texts) {
      if (!t || !t.trim()) continue;
      await speakOnce(t, speedLabel);
    }
  } catch (e) {
    console.error('[TTS] speakSequence error', e);
  }
}



// 危険ワード（ひらがなベース）: 必要なら追加してOK
const DANGER_DICT = [
  { hira:"ごえん", note:"誤嚥リスク。姿勢・一口量・むせを確認。" },
  { hira:"むせ", note:"むせ（誤嚥のサイン）。食事を止めて落ち着かせる。" },
  { hira:"てんとう", note:"転倒リスク。立ち上がり・移乗は介助と確認。" },
  { hira:"ころぶ", note:"転倒リスク。ゆっくり動く・見守り強化。" },
  { hira:"すべる", note:"すべり（転倒）注意。床や足元を確認。" },
  { hira:"ちっそく", note:"窒息の危険。すぐに看護師/上司へ。" },
  { hira:"いきがくるしい", note:"呼吸苦。すぐに看護師/上司へ。" },
  { hira:"しゅっけつ", note:"出血。状態確認→上席へ。" },
  { hira:"こっせつ", note:"骨折の疑い。動かさず報告。" }
];

const KEIGO_DICT = [
  { hira:"ください", note:"丁寧な依頼（〜してください）。" },
  { hira:"おねがいします", note:"丁寧な依頼（お願いします）。" },
  { hira:"いただけますか", note:"より丁寧な依頼（〜していただけますか）。" },
  { hira:"いたします", note:"丁寧な表現（〜いたします）。" },
  { hira:"でしょうか", note:"丁寧な確認（〜でしょうか）。" },
  { hira:"すみません", note:"配慮のクッション（すみません）。" }
];

function uniqSort(arr){
  return [...new Set((arr||[]).filter(Boolean))].sort((a,b)=>String(b).length-String(a).length);
}

function heuristicAnnotations(tri){
  const hira = String(tri?.hira || tri?.jp || "");
  const danger = [];
  for (const d of DANGER_DICT){
    if (hira.includes(d.hira)) danger.push({ hira: d.hira, level:"high", note_jp: d.note });
  }
  const keigo = [];
  for (const k of KEIGO_DICT){
    if (hira.includes(k.hira)) keigo.push({ phrase_hira: k.hira, note_jp: k.note });
  }
  return { danger_words: danger.slice(0,5), keigo_points: keigo.slice(0,5), vocab: [] };
}


function showErr(msg){
  try{
    const b = $("errBox");
    if (!b) return;
    b.style.display = "block";
    b.textContent = msg;
  }catch(e){}
}
function showOk(msg){
  try{
    const b = $("okBox");
    if (!b) return;
    b.style.display = "block";
    b.textContent = msg;
    setTimeout(()=>{ try{ b.style.display="none"; }catch(e){} }, 2200);
  }catch(e){}
}

// panel-local notice (so user can see it without scrolling)
function showLocalMsg(id, msg, isErr=false){
  try{
    const el = $(id);
    if (!el) return;
    el.className = isErr ? "err" : "ok";
    el.style.display = "block";
    el.textContent = msg;
    setTimeout(()=>{ try{ el.style.display="none"; }catch(e){} }, 2600);
  }catch(e){}
}

function focusUserInput(){
  const ta = $("userInput");
  if (!ta) return;
  try{ ta.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
  try{ ta.focus(); }catch(e){}
  try{ ta.classList.add("flashFocus"); setTimeout(()=>ta.classList.remove("flashFocus"), 900); }catch(e){}
}

// tri object safety: always have something to show
function normalizeTri(tri, fallbackText=""){
  const o = tri || {};
  const hira = String((o.hira || o.jp_hira || o.jp || o.ja || o.text || "")).trim() || String(fallbackText || "").trim();
  const romaji = String((o.romaji || o.ro || "")).trim();
  const indo = String((o.indo || o.indonesian || o.id || "")).trim();
  const id = String((o.id || "")).trim();
  return { hira, romaji, indo, id };
}

function normalizeAnnotations(ann, tri){
  // AIが返さない場合はヒューリスティックで補う
  const base = ann && typeof ann === "object" ? ann : heuristicAnnotations(tri || {});
  base.danger_words = Array.isArray(base.danger_words) ? base.danger_words : [];
  base.keigo_points = Array.isArray(base.keigo_points) ? base.keigo_points : [];
  base.vocab = Array.isArray(base.vocab) ? base.vocab : [];
  return base;
}

function getHighlightsForAnn(ann, tri){
  const a = normalizeAnnotations(ann, tri || {});
  const danger = uniqSort(a.danger_words.map(x=>x.hira || x.word_hira || x.word || ""));
  const keigo = uniqSort(a.keigo_points.map(x=>x.phrase_hira || x.phrase || ""));
  // ローマ字側は、危険/敬語の「ローマ字表記」があれば使う（なければ空）
  const dangerRoma = uniqSort(a.danger_words.map(x=>x.romaji || ""));
  const keigoRoma = uniqSort(a.keigo_points.map(x=>x.phrase_romaji || ""));
  return { danger, keigo, dangerRoma, keigoRoma };
}

function applyHighlights(text, dangerArr, keigoArr){
  let out = esc(String(text || ""));
  const danger = uniqSort(dangerArr || []);
  const keigo = uniqSort(keigoArr || []);
  for (const w of danger){
    const ew = esc(w);
    if (!ew) continue;
    out = out.split(ew).join(`<mark class="hlDanger">${ew}</mark>`);
  }
  for (const w of keigo){
    const ew = esc(w);
    if (!ew) continue;
    out = out.split(ew).join(`<mark class="hlKeigo">${ew}</mark>`);
  }
  return out;
}

function renderAnno(ann){
  const box = $("annoBox");
  if (!box) return;
  if (!ann){
    box.textContent = "—";
    return;
  }
  const danger = ann.danger_words || [];
  const keigo = ann.keigo_points || [];
  const vocab = ann.vocab || [];

  const parts = [];
  parts.push(`<div class="small"><b>危険ワード</b></div>`);
  if (!danger.length){
    parts.push(`<div class="small">なし</div>`);
  } else {
    parts.push(`<ul class="annoList">` + danger.map(d=>`<li><span class="mono">${esc(d.hira || "")}</span>：${esc(d.note_jp || "")}</li>`).join("") + `</ul>`);
  }

  parts.push(`<div class="small" style="margin-top:8px;"><b>敬語ポイント</b></div>`);
  if (!keigo.length){
    parts.push(`<div class="small">なし</div>`);
  } else {
    parts.push(`<ul class="annoList">` + keigo.map(k=>`<li><span class="mono">${esc(k.phrase_hira || "")}</span>：${esc(k.note_jp || "")}</li>`).join("") + `</ul>`);
  }

  if (vocab.length){
    parts.push(`<div class="small" style="margin-top:8px;"><b>覚える単語</b></div>`);
    parts.push(`<ul class="annoList">` + vocab.slice(0,6).map(v=>`<li>${esc(v.hira||"")}（${esc(v.romaji||"")}）：${esc(v.id||"")} <span class="small">${esc(v.note_jp||"")}</span></li>`).join("") + `</ul>`);
  }

  box.innerHTML = parts.join("");
}

// ===== stats (local) =====
function updateStats(scene, category, scoreVal){
  if (!scoreVal || scoreVal < 1 || scoreVal > 5) return;
  STATS.scenes = STATS.scenes || {};
  STATS.categories = STATS.categories || {};

  const s = STATS.scenes[scene] || { count:0, sum:0 };
  s.count += 1;
  s.sum += scoreVal;
  STATS.scenes[scene] = s;

  const c = STATS.categories[category] || { count:0, sum:0 };
  c.count += 1;
  c.sum += scoreVal;
  STATS.categories[category] = c;

  ls.set("aiga_stats_"+VARIANT, STATS);
}

function avgOf(obj){ return obj && obj.count ? (obj.sum / obj.count) : 0; }

function renderStats(){
  const box = $("logBox");
  if (!box) return;
  const sceneKeys = Object.keys(EX?.scenes || {});
  if (!sceneKeys.length){
    box.textContent = "—";
    return;
  }
  const rows = sceneKeys.map(k=>{
    const st = (STATS.scenes || {})[k] || {count:0, sum:0};
    const avg = avgOf(st);
    return { key:k, label:getSceneLabel(k), avg, count:st.count };
  });

  const practiced = rows.filter(r=>r.count>0);
  const weak = practiced.slice().sort((a,b)=>a.avg-b.avg)[0];

  const head = [];
  if (!practiced.length){
    head.push(`<div class="small">まだログがありません。会話すると自動で蓄積します。</div>`);
  } else {
    head.push(`<div class="small">弱いシーン：<b>${esc(weak.label)}</b>（平均 ${weak.avg.toFixed(1)}/5、回数 ${weak.count}）</div>`);
  }

  const body = rows.map(r=>{
    const pct = Math.max(0, Math.min(100, (r.avg/5)*100));
    return `
      <div class="statRow">
        <div class="small">${esc(r.label)}</div>
        <div class="statBar"><div class="statFill" style="width:${pct}%;"></div></div>
        <div class="statVal small">${r.count ? r.avg.toFixed(1) : "—"}</div>
      </div>
    `;
  }).join("");

  box.innerHTML = head.join("") + `<div style="margin-top:6px;">${body}</div>`;
}

function saveSettings(){
  SETTINGS = {
    ttsSel: $("ttsSel")?.value || "off",
    ttsRate: $("ttsRate")?.value || "1",
    ttsAuto: $("ttsAuto")?.value || "off",
    uiLabelMode: $("uiLabelMode")?.value || "jp_id"
  };
  ls.set("aiga_settings_"+VARIANT, SETTINGS);
}

function runAutoTts(userTri, aiTri){
  const mode = $("ttsAuto")?.value || "off";
  const ttsMode = $("ttsSel")?.value || "off";
  if (mode === "off" || ttsMode === "off") return;

  const userText = (ttsMode === "roma") ? (userTri?.romaji || "") : (userTri?.hira || "");
  const aiText = (ttsMode === "roma") ? (aiTri?.romaji || "") : (aiTri?.hira || "");

  if (mode === "both"){
    speakSequence([userText, aiText], "ja-JP");
  } else if (mode === "ai"){
    speakSequence([aiText], "ja-JP");
  }
}

function setStatus(msg){ $("statusPill").textContent = msg; }

/* ========= global state ========= */
let CFG = null;
let EX = null;
let VARIANT = detectVariantFromPath();

let SETTINGS = Object.assign({}, DEFAULT_SETTINGS, ls.get("aiga_settings_"+VARIANT, {}));
let STATS = ls.get("aiga_stats_"+VARIANT, { scenes:{}, categories:{} });

let lastSuggested = null;
let lastAi = null;
let lastAnnotations = null;
let lastExampleKey = null;

let history = ls.get("aiga_history_"+VARIANT, []);
let unlocked = ls.get("aiga_unlocked_"+VARIANT, false);
let trialUsed = ls.get("aiga_trialUsed_"+VARIANT, 0);

/* ========= load config/examples ========= */
async function loadJson(path){
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`${path} load failed: ${r.status}`);
  return await r.json();
}

function setTrialInfo(){
  const limit = CFG?.trial_limit ?? 3;
  const remain = Math.max(0, limit - trialUsed);
  $("trialInfo").textContent = unlocked ? "✅ 解除済み" : `お試し残り: ${remain}/${limit}`;
}

function maybeLock(){
  if (unlocked) return false;
  const limit = CFG?.trial_limit ?? 3;
  if (trialUsed >= limit){
    $("lock").style.display = "flex";
    // デフォルトプラン（trainee=light / ssw=pro）
    const defPlan = (VARIANT === "ssw") ? "pro" : "light";
    const radio = document.querySelector(`input[name="plan"][value="${defPlan}"]`);
    if (radio && !document.querySelector(`input[name="plan"]:checked`)) radio.checked = true;

    return true;
  }
  return false;
}

/* ========= select population ========= */
function fillSelect(selectEl, items, getVal, getLabel){
  selectEl.innerHTML = "";
  for (const it of items){
    const opt = document.createElement("option");
    opt.value = getVal(it);
    opt.textContent = getLabel(it);
    selectEl.appendChild(opt);
  }
}


function uiMode(){
  return $("uiLabelMode")?.value || SETTINGS?.uiLabelMode || "jp_id";
}
function fmtLabel(jp, id){
  const mode = uiMode();
  const a = (jp || "").trim();
  const b = (id || "").trim();
  if (mode === "jp") return a || b || "";
  if (mode === "id") return b || a || "";
  if (a && b && a !== b) return `${a}（${b}）`;
  return a || b || "";
}

const FALLBACK_SCENE_LABELS = {
  bath:{ jp:"入浴", id:"Mandi" },
  meal:{ jp:"食事", id:"Makan" },
  toilet:{ jp:"排泄", id:"Toilet" },
  night:{ jp:"夜間", id:"Malam" },
  complaint:{ jp:"クレーム対応", id:"Keluhan" }
};
const FALLBACK_PERSONA_ID = {
  user_calm:"Pengguna: Tenang",
  user_angry:"Pengguna: Marah",
  dementia:"Pengguna: Bingung",
  family_anxious:"Keluarga: Cemas",
  family_complaint:"Keluarga: Keluhan",

  colleague:"Rekan kerja",
  leader:"Leader",
  nurse:"Perawat",
  head_nurse:"Kepala perawat",
  doctor:"Dokter"
};
const FALLBACK_CAT_ID = {
  bath:{ voice:"Menyapa", temperature:"Cek suhu", privacy:"Menjaga privasi", refusal:"Menangani penolakan", safety:"Keamanan" },
  meal:{ start:"Mulai/persiapan", swallow:"Menelan/tersedak", pace:"Atur tempo", refusal:"Penolakan/selera", safety:"Keamanan/pencegahan aspirasi" },
  toilet:{ urge:"Mengajak/menyapa", transfer:"Pindah/berdiri", privacy:"Menjaga privasi", accident:"Kecelakaan (inkontinensia)", hygiene:"Kebersihan" },
  night:{ sleep:"Tidur", anxiety:"Cemas", pain:"Nyeri", wander:"Berkeliaran", safety:"Keamanan" },
  complaint:{ apology:"Permintaan maaf", fact:"Konfirmasi fakta", plan:"Rencana tindak lanjut", escalate:"Eskalasi ke atasan", followup:"Tindak lanjut" }
};


// ===== persona options by scene (prevent wrong counterparts) =====
const PERSONA_ALLOW = {
  default: ["user_calm","user_angry","dementia","family_anxious","family_complaint"],
  handover: ["colleague","leader"],
  emergency: ["nurse","doctor"],
  fall: ["nurse","leader","head_nurse"],
};

function allowedPersonaKeysForScene(sceneKey){
  return PERSONA_ALLOW[sceneKey] || PERSONA_ALLOW.default;
}

// ===== emergency SBAR helper =====
function isEmergencyScene(){
  return ($("sceneSel")?.value || "") === "emergency";
}
function toggleSbarPanel(){
  const panel = $("sbarPanel");
  if (!panel) return;
  panel.style.display = isEmergencyScene() ? "block" : "none";
}
function sbarVal(id){ return ($(""+id)?.value || "").trim(); }
function sbarChecked(id){ return !!($(""+id)?.checked); }

function clearSbar(){
  const ids = ["sbarName", "sbarOnset", "sbarOther", "sbarTemp", "sbarSpo2", "sbarPulse", "sbarBp", "sbarRr", "sbarGlucose", "sbarBg", "sbarAction"];
  for (const i of ids){ const el = $(i); if (el) el.value = ""; }
  const cbs = ["sbarFever","sbarDyspnea","sbarAms","sbarVomit","sbarChest","sbarHypo"];
  for (const c of cbs){ const el = $(c); if (el) el.checked = false; }
}

function buildSbarText(targetPersonaKey){
  // targetPersonaKey: nurse | doctor
  const name = sbarVal("sbarName");
  const onset = sbarVal("sbarOnset");
  const other = sbarVal("sbarOther");

  const temp = sbarVal("sbarTemp");
  const spo2 = sbarVal("sbarSpo2");
  const pulse = sbarVal("sbarPulse");
  const bp = sbarVal("sbarBp");
  const rr = sbarVal("sbarRr");
  const glucose = sbarVal("sbarGlucose");

  const bg = sbarVal("sbarBg");
  const action = sbarVal("sbarAction");

  const ss = [];
  if (sbarChecked("sbarFever")) ss.push("ねつ が ある");
  if (sbarChecked("sbarDyspnea")) ss.push("いきが くるしい");
  if (sbarChecked("sbarAms")) ss.push("いしき の へんか");
  if (sbarChecked("sbarVomit")) ss.push("おうと");
  if (sbarChecked("sbarChest")) ss.push("むね の いたみ");
  if (sbarChecked("sbarHypo")) ss.push("ていけっとう の うたがい");
  if (other) ss.push(other);

  const subj = name ? (name + "さん") : "りようしゃ";
  const s1 = ss.length ? ss.join("、") : "ぐあいが わるい";

  // ---- S（状況）: 口頭向けは「見出しを出さない」
  let S = `いま、${subj} が、${s1} です。`;
  if (onset) S += ` ${onset} から です。`;
  if (sbarChecked("sbarDyspnea") && spo2) S += ` えすぴーおーつー は ${spo2}ぱーせんと です。`;
  if (sbarChecked("sbarFever") && temp) S += ` たいおん は ${temp}ど です。`;

  // ---- B（背景）: 入力がある時だけ出す
  const parts = [S];
  if (bg) parts.push(`はいけい は、${bg} です。`);

  // ---- A（評価）: 数値がある時だけ出す
  const vit = [];
  if (temp) vit.push(`たいおん ${temp}ど`);
  if (spo2) vit.push(`えすぴーおーつー ${spo2}ぱーせんと`);
  if (pulse) vit.push(`みゃく ${pulse}`);
  if (bp) vit.push(`けつあつ ${bp}`);
  if (rr) vit.push(`こきゅう ${rr}`);
  if (glucose) vit.push(`けっとう ${glucose}`);
  if (vit.length) parts.push(`すうち は、${vit.join("、")} です。`);

  // ---- R（依頼）
  const req = (targetPersonaKey === "doctor")
    ? "しじ を おねがい します。"
    : "かくにん を おねがい します。";
  let R = action ? `いま、${action} を しています。` : "いま、あんせい に しています。";
  if (sbarChecked("sbarHypo") && glucose) R += " てんてき や とうぶん たいおう の ひつようが あるか、";
  R += ` ${req}`;
  parts.push(R);

  const out = parts.join(" ");
  return (window.MED_TERM && typeof MED_TERM.apply === "function") ? MED_TERM.apply(out) : out;
}

// ===== fall report helper =====
function isFallScene(){
  return ($("sceneSel")?.value || "") === "fall";
}
function toggleFallPanel(){
  const panel = $("fallPanel");
  if (!panel) return;
  panel.style.display = isFallScene() ? "block" : "none";
}
function fallVal(id){ return ($(""+id)?.value || "").trim(); }
function fallChecked(id){ return !!($(""+id)?.checked); }
function formatSituation(s){
  s = (s || "").trim();
  if (!s) return "";
  // すでに「に」「のときに」「ときに」などが付いている場合はそのまま
  if (/(に|の\s*ときに|ときに)$/.test(s)) return s;
  // 「〜ちゅう」系は「〜ちゅうに」が自然
  if (/(ちゅう|中)$/.test(s)) return s + "に";
  // それ以外は「〜のときに」
  return s + " の ときに";
}

function clearFall(){
  const ids = ["fallName","fallWhen","fallWhere","fallSituation","fallCause","fallFound","fallPainPart","fallOther","fallTemp","fallSpo2","fallPulse","fallBp","fallAction","fallPrevent"];
  for (const i of ids){ const el = $(i); if (el) el.value = ""; }
  const cbs = ["fallHead","fallBleed","fallPain","fallAms","fallVomit","fallFract"];
  for (const c of cbs){ const el = $(c); if (el) el.checked = false; }
  const ff = $("fallFormat"); if (ff) ff.value = "narrative";
}

function buildFallText(targetPersonaKey){
  // targetPersonaKey: nurse | head_nurse | leader
  const name = fallVal("fallName");
  const when = fallVal("fallWhen");
  const where = fallVal("fallWhere");
  const situation = fallVal("fallSituation");
  const cause = fallVal("fallCause");
  const found = fallVal("fallFound");
  const fmt = ($("fallFormat")?.value || "narrative"); // narrative | items

  const painPart = fallVal("fallPainPart");
  const other = fallVal("fallOther");

  const temp = fallVal("fallTemp");
  const spo2 = fallVal("fallSpo2");
  const pulse = fallVal("fallPulse");
  const bp = fallVal("fallBp");

  const action = fallVal("fallAction");
  const prevent = fallVal("fallPrevent");

  const subj = name ? (name + "さん") : "りようしゃ";

  // --- status snippets (短いセンテンスで)
  const st = [];
  if (fallChecked("fallHead")) st.push("あたま を うった かのうせい が あります");
  if (fallChecked("fallBleed")) st.push("ち が でています");
  if (fallChecked("fallPain")) st.push(painPart ? `${painPart} に いたみ が あります` : "いたみ が あります");
  if (fallChecked("fallAms")) st.push("いしき が いつも と ちがいます");
  if (fallChecked("fallVomit")) st.push("おうと が ありました");
  if (fallChecked("fallFract")) st.push("ほね の けが の うたがい が あります");

  if (other){
    const needsVerb = !/(が|です|でした|ます|ました|あります|ありません|なし)/.test(other);
    const otherPhrase = needsVerb ? (other + " が あります") : other;
    st.push(`そのほか、${otherPhrase}`);
  }

  // --- vitals
  const vit = [];
  if (temp) vit.push(`たいおん は ${temp}ど`);
  if (spo2) vit.push(`えすぴーおーつー は ${spo2}ぱーせんと`);
  if (pulse) vit.push(`みゃく は ${pulse}`);
  if (bp) vit.push(`けつあつ は ${bp}`);

  // request by target
  const req = (targetPersonaKey === "head_nurse")
    ? "しちょう、かくにん を おねがい します。"
    : (targetPersonaKey === "leader")
      ? "りーだー に ほうこく します。"
      : "かんごし さん、かくにん と しょち を おねがい します。";

  // ---------- items mode (1行で見えるように)
  if (fmt === "items"){
    const parts = [];
    parts.push("てんとう の ほうこく です。");
    if (when) parts.push(`いつ：${when}`);
    if (where) parts.push(`どこ：${where}`);
    parts.push(`だれ：${subj}`);
    if (situation) parts.push(`じょうきょう：${situation}`);
    if (cause) parts.push(`げんいん：${cause}`);
    if (found) parts.push(`はっけん：${found}`);
    parts.push(`ようす：${st.length ? st.join("、") : "いまのところ けが は ありません"}`);
    if (vit.length) parts.push(`すうち：${vit.join("、")}`);
    if (action) parts.push(`たいおう：${action}`);
    if (prevent) parts.push(`よぼう：${prevent}`);
    parts.push(`いらい：${req}`);
    return parts.join(" / ");
  }

  // ---------- narrative mode (口頭・自然な文。改行しない)
  const out = [];
  out.push(`${subj} の てんとう を ほうこく します。`);

  const s1 = [];
  if (when) s1.push(`${when} に`);
  if (where) s1.push(`${where} で`);
  if (situation) s1.push(formatSituation(situation));
  s1.push("てんとう しました。");
  out.push(s1.join(" "));

  if (found) out.push(`はっけん は ${found} です。`);
  if (cause) out.push(`げんいん は ${cause} かも しれません。`);

  out.push(st.length ? (st.join("。") + "。") : "けが は いまのところ ありません。" );

  if (vit.length) out.push(vit.join("、") + " です。" );

  if (action){
    const alreadyVerb = /(して|します|しました|しています|しました)/.test(action);
    out.push(alreadyVerb ? (`いま は ${action}。`) : (`いま は ${action} しています。`));
  } else {
    out.push("いま は あんせい に しています。" );
  }

  if (prevent) out.push(`こんご は ${prevent} を します。`);

  out.push(req);

  return out.join(" ");
}
function updatePersonasForScene(){
  const scene = $("sceneSel")?.value || "";
  const allow = allowedPersonaKeysForScene(scene);
  const cur = $("personaSel")?.value || "";

  const list = (EX?.personas || []).filter(p=>allow.includes(p.key));
  // If config/examples are old and list is empty, fall back to all personas.
  const finalList = list.length ? list : (EX?.personas || []);

  fillSelect($("personaSel"), finalList, p=>p.key, p=>getPersonaLabelByKey(p.key));

  if (cur && allow.includes(cur) && finalList.some(p=>p.key===cur)) {
    $("personaSel").value = cur;
  } else {
    // choose first allowed persona that exists in list
    const first = allow.find(k=>finalList.some(p=>p.key===k));
    $("personaSel").value = first || (CFG?.default_persona || "user_calm");
  }
}

function getSceneLabel(sceneKey){
  const o = (EX && EX.scene_labels && EX.scene_labels[sceneKey]) ? EX.scene_labels[sceneKey] : (FALLBACK_SCENE_LABELS[sceneKey] || {jp:sceneKey, id:sceneKey});
  return fmtLabel(o.jp || sceneKey, o.id || sceneKey);
}
function getPersonaLabelByKey(personaKey){
  const p = (EX?.personas || []).find(x=>x.key===personaKey);
  const jp = p?.label || personaKey;
  const id = p?.label_id || FALLBACK_PERSONA_ID[personaKey] || "";
  return fmtLabel(jp, id);
}
function getCategoryLabel(sceneKey, cat){
  const jp = cat?.label || cat?.key || "";
  const id = cat?.label_id || (FALLBACK_CAT_ID[sceneKey]?.[cat?.key] || "");
  return fmtLabel(jp, id);
}

function populate(){
  // scenes
  const sceneKeys = Object.keys(EX.scenes || {});
  fillSelect($("sceneSel"), sceneKeys, k=>k, k=>getSceneLabel(k));

  // defaults
  $("sceneSel").value = (CFG.default_scene || "meal");
  $("levelSel").value = (CFG.default_level || "beginner");

  // personas depend on scene
  updatePersonasForScene();

  updateCategories();
}

function updateCategories(){
  const scene = $("sceneSel").value;
  const cats = EX.scenes?.[scene] || [];
  fillSelect($("catSel"), cats, c=>c.key, c=>getCategoryLabel(scene, c));
}

function rebuildSelectLabels(){
  const sceneVal = $("sceneSel")?.value;
  const personaVal = $("personaSel")?.value;
  const catVal = $("catSel")?.value;

  // scenes
  const sceneKeys = Object.keys(EX.scenes || {});
  fillSelect($("sceneSel"), sceneKeys, k=>k, k=>getSceneLabel(k));
  if (sceneVal) $("sceneSel").value = sceneVal;

  // personas depend on scene (avoid wrong counterparts in handover/report)
  updatePersonasForScene();
  const allow = allowedPersonaKeysForScene($("sceneSel")?.value || "");
  if (personaVal && allow.includes(personaVal)) $("personaSel").value = personaVal;

  updateCategories();
  if (catVal) $("catSel").value = catVal;
  toggleSbarPanel();
  toggleFallPanel();
}

/* ========= examples ========= */
function pickExample(scene, persona, category, level){
  try{
    if (!EX || !EX.examples) return null;
    const sceneObj = EX.examples?.[scene] || {};

    const tryGet = (p, c) => (sceneObj?.[p]?.[c] || []);

    const priorities = [
      [persona, category],
      [persona, "basic"],
      ["user_calm", category],
      ["user_calm", "basic"],
    ];

    let arr = [];
    for (const [p, c] of priorities){
      const a = tryGet(p, c);
      if (a && a.length){ arr = a; break; }
    }

    // same category, any persona
    if (!arr.length && category){
      for (const p of Object.keys(sceneObj)){
        const a = sceneObj?.[p]?.[category];
        if (a && a.length){ arr = a; break; }
      }
    }

    // any category, any persona (scene fallback)
    if (!arr.length){
      outer:
      for (const p of Object.keys(sceneObj)){
        const cats = sceneObj?.[p] || {};
        for (const c of Object.keys(cats)){
          const a = cats[c];
          if (a && a.length){ arr = a; break outer; }
        }
      }
    }

    if (!arr.length) return null;

    const filtered = (level === "beginner") ? arr.filter(x=>x.level==="beginner") :
                     (level === "intermediate") ? arr.filter(x=>x.level==="intermediate") :
                     (level === "advanced") ? arr.filter(x=>x.level==="advanced") : arr;
    const pool = filtered.length ? filtered : arr;
    if (!pool.length) return null;

    const keyBase = `${scene}|${persona}|${category}|${level||""}`;
    let idx = Math.floor(Math.random()*pool.length);
    if (pool.length > 1 && lastExampleKey === keyBase){
      idx = (idx + 1 + Math.floor(Math.random() * (pool.length - 1))) % pool.length;
    }
    lastExampleKey = keyBase;

    return pool[idx];
  }catch(e){ return null; }
}


function insertExample(){
  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;

  const ex = pickExample(scene, persona, category, level);
  if (!ex){
    $("userInput").value = "ゆっくりで大丈夫ですよ。";
    return;
  }
  // 日本語例文を入れる（ローマ字やIDは履歴表示側で出す）
  $("userInput").value = (ex.hira || ex.jp || "");
  $("okBox").style.display="block";
  $("okBox").textContent = "例文を入力しました。送信して会話を続けられます。";
  setTimeout(()=>{$("okBox").style.display="none";}, 1800);
}

/* ========= render ========= */
function triHtml(tri, opts = {}){
  const mode = $("displayMode").value;
  const idx = (typeof opts.idx === "number") ? opts.idx : -1;
  const ann = opts.ann || null;

  const ttsMode = ($("ttsSel")?.value || "off");
  const canHira = (ttsMode === "both" || ttsMode === "hira");
  const canRoma = (ttsMode === "both" || ttsMode === "roma");

  const hl = getHighlightsForAnn(ann, tri);
  const lines = [];

  const hiraText = tri?.hira || tri?.jp || "";
  const romaText = tri?.romaji || "";
  const idText = tri?.id || "";

  if (mode === "all" || mode === "ja"){
    lines.push(`
      <div class="line">
        <div class="kRow">
          <div class="k">日本語</div>
          <div class="kBtns">
            <button class="ttsBtn" type="button" data-idx="${idx}" data-field="hira" ${canHira ? "" : "disabled"} title="読み上げ">▶</button>
          </div>
        </div>
        <div class="v">${applyHighlights(hiraText, hl.danger, hl.keigo)}</div>
      </div>
    `);
  }
  if (mode === "all" || mode === "roma"){
    lines.push(`
      <div class="line">
        <div class="kRow">
          <div class="k">ローマ字</div>
          <div class="kBtns">
            <button class="ttsBtn" type="button" data-idx="${idx}" data-field="romaji" ${canRoma ? "" : "disabled"} title="読み上げ">▶</button>
          </div>
        </div>
        <div class="v">${applyHighlights(romaText, hl.dangerRoma, hl.keigoRoma)}</div>
      </div>
    `);
  }
  if (mode === "all" || mode === "id"){
    lines.push(`
      <div class="line">
        <div class="k">インドネシア語</div>
        <div class="v">${esc(idText)}</div>
      </div>
    `);
  }
  return `<div class="tri">${lines.join("")}</div>`;
}

function renderHistory(){
  const box = $("history");
  box.innerHTML = "";
  const items = history || [];
  if (!items.length){
    box.innerHTML = `<div class="small" style="padding:10px;">まだ会話がありません。左で例文→送信から始めてください。</div>`;
    return;
  }
  items.forEach((it, i)=>{
    const div = document.createElement("div");
    div.className = "msg";
    const meta = it.meta || {};
    const title = it.role === "user" ? "あなた" : "AI（利用者/家族）";
    const tag = `${getSceneLabel(meta.scene)} / ${getPersonaLabelByKey(meta.persona)} / ${getCategoryLabel(meta.scene, {key: meta.category, label: (EX?.scenes?.[meta.scene]||[]).find(x=>x.key===meta.category)?.label || meta.category, label_id: (EX?.scenes?.[meta.scene]||[]).find(x=>x.key===meta.category)?.label_id || ""})} / ${meta.level}`;
    div.innerHTML = `
      <div class="who">
        <span>${esc(title)}</span>
        <span class="mono">${esc(tag)}</span>
      </div>
      ${triHtml(it.tri, { idx:i, ann: it.ann || null })}
    `;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function setSuggestBox(tri){
  if (!tri){ $("suggestBox").textContent="—"; return; }
  const mode = $("displayMode").value;
  const parts=[];
  if (mode==="all" || mode==="ja") parts.push(`日本語:\n${tri.hira || tri.jp || ""}`);
  if (mode==="all" || mode==="roma") parts.push(`\nローマ字:\n${tri.romaji || ""}`);
  if (mode==="all" || mode==="id") parts.push(`\nインドネシア語:\n${tri.id || ""}`);
  $("suggestBox").textContent = parts.join("\n");
}

/* ========= API ========= */
async function postChat({ text, meta }){
  const r = await fetch("/api/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ prompt: text, meta })
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok) throw new Error(j?.error ? `${j.error}\n${JSON.stringify(j, null, 2)}` : `HTTP ${r.status}`);
  return j;
}

async function send(){
  $("errBox").style.display="none";
  $("okBox").style.display="none";

  // ★ プラン管理：使用回数チェック
  if (typeof PlanManager !== 'undefined') {
    if (!PlanManager.canUse()) {
      $("errBox").style.display="block";
      $("errBox").textContent = "本日の利用回数が上限に達しています。プランの購入/変更で解除できます。";
      setStatus("制限");
      return;
    }
  }

  if (maybeLock()) {
  $("errBox").style.display="block";
  $("errBox").textContent = "ロック中です（無料体験の回数終了など）。購入で解除してください。";
  setStatus("ロック");
  return;
}

  let text = $("userInput").value.trim();

 // ★ 医学用語の自動補正（急変・報告文の品質安定）
  if (window.MED_TERM && typeof MED_TERM.apply === "function") {
    const fixed = MED_TERM.apply(text);
    if (fixed) text = fixed;
  }
  if (!text){ alert("入力が空です"); return; }

  const scene = $("sceneSel").value;
  const persona = $("personaSel").value;
  const category = $("catSel").value;
  const level = $("levelSel").value;
  const langSel = $("langSel").value;
  const user_lang = (langSel === "auto") ? detectLangAuto(text) : langSel;

  // ★ プラン管理：現在のプランを取得
  const currentPlan = (typeof PlanManager !== 'undefined') ? PlanManager.getCurrentPlan() : 'ssw_standard';

  // client-side history to help context (last 6 turns)
  const ctx = (history || []).slice(-6).map(x=>({
    role: x.role, hira: x.tri?.hira || "", romaji: x.tri?.romaji || "", id: x.tri?.id || ""
  }));

  $("btnSend").disabled = true;
  setStatus("AI応答中…");

  try{
    const meta = { stage: 3, scene, persona, category, level, user_lang, variant: VARIANT, plan: currentPlan, ctx };
    const out = await postChat({ text, meta });

    // ★ プラン管理：使用回数をカウント
    if (typeof PlanManager !== 'undefined') {
      PlanManager.recordUsage();
    }

    // trial count
    if (!unlocked){
      trialUsed += 1;
      ls.set("aiga_trialUsed_"+VARIANT, trialUsed);
      setTrialInfo();
    }

    // annotations & score
    const ann = normalizeAnnotations(out.annotations || null, out.ai || {});
    const scoreVal = Number(out.score?.scene_skill || 0);

    lastAnnotations = ann;

    // add to history: user + ai
    const userTri = normalizeTri(out.user, text);
    const aiTri = normalizeTri(out.ai, "");
    if (!aiTri.hira) aiTri.hira = "（AIの応答が取得できませんでした）";
    // add to history: user + ai
    history.push({ role:"user", tri: userTri, meta:{ scene, persona, category, level } });
    history.push({ role:"ai", tri: aiTri, ann, score: out.score || null, meta:{ scene, persona, category, level } });

    // keep latest for UI boxes
    lastAi = aiTri;
    lastSuggested = out.suggested || null;

    // persist
    ls.set("aiga_history_"+VARIANT, history);

    // UI
    $("feedbackBox").textContent = out.feedback_jp || out.feedback || "—";
    setSuggestBox(out.suggested || null);
    renderAnno(ann);
    if (scoreVal > 0) updateStats(scene, category, scoreVal);
    renderStats();

    $("userInput").value = "";
    renderHistory();
    setStatus("完了");
    $("okBox").style.display="block";
    $("okBox").textContent = "OK。続けて入力できます。";
    setTimeout(()=>{$("okBox").style.display="none";}, 1200);

    // auto TTS (optional)
    runAutoTts(out.user || null, out.ai || null);

    // lock if just reached limit
    maybeLock();
  }catch(e){
    $("errBox").style.display="block";
    $("errBox").textContent = String(e.message || e);
    setStatus("エラー");
  }finally{
    $("btnSend").disabled = false;
  }
}

/* ========= Stripe unlock ========= */
async function startCheckout() {
  const msg = $("lockMsg");
  const planKey = document.querySelector('input[name="plan"]:checked')?.value || ((VARIANT === "ssw") ? "ssw_standard" : "trainee_standard");

  msg.textContent = "Stripeへ移動します…";
  msg.className = "muted";

  try {
    const r = await fetch("/api/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ plan_key: planKey })
    });

    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || "Checkout作成に失敗しました");
    if (!data?.url) throw new Error("Checkout URL が返ってきません");

    location.href = data.url;
  } catch (e) {
    msg.textContent = "エラー: " + e.message + "\n（plan と PRICE_ID の対応を確認してください）";
    msg.className = "muted warn";
  }
}



function mapLegacyBillingPlan(plan){
  // backward compatibility: "light" | "pro" -> plan_key
  if (plan === "pro") return "ssw_standard";
  if (plan === "light") return "trainee_standard";
  return null;
}

function applyEntitlementFromBilling(planKey){
  // planKey: "trainee_lite" | "trainee_standard" | "ssw_standard" | "ssw_pro" | null
  if (typeof PlanManager === 'undefined' || !PlanManager.setCurrentPlan) return;

  const key = planKey || "trainee_lite";
  PlanManager.setCurrentPlan(key);
}

async function verifyFromUrl(){
  const url = new URL(location.href);
  const sessionId = url.searchParams.get("session_id");
  const success = url.searchParams.get("success");
  if (!sessionId || success !== "1") return;

  setStatus("決済確認中…");
  try{
    const r = await fetch(`/api/verify-session?session_id=${encodeURIComponent(sessionId)}`);
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error || "verify error");
    if (j.active && !j.cancel_at_period_end){
      unlocked = true;
      ls.set("aiga_unlocked_"+VARIANT, true);
      if (j.subscription_id) ls.set("stripe_sub_id_"+VARIANT, j.subscription_id);
      if (sessionId) ls.set("stripe_session_id_"+VARIANT, sessionId);

      $("okBox").style.display="block";
      $("okBox").textContent = "✅ 解除しました（有効な購読を確認）";
      $("lock").style.display="none";
      setTrialInfo();
    
      // ★ 購読プラン(plan_key) → 4プラン権限に反映
      try { applyEntitlementFromBilling(j.plan_key || mapLegacyBillingPlan(j.plan) || null); } catch(_) {}
}else{
      // active でない（または解約予約）ならロック寄せ
      unlocked = false;
      ls.del("aiga_unlocked_"+VARIANT);
      ls.del("stripe_sub_id_"+VARIANT);
      ls.del("stripe_session_id_"+VARIANT);

      $("lockMsg").textContent = "決済はまだ確認できませんでした。少し待って再読み込みしてください。";
      // ★ 非アクティブなら権限をliteへ
      try { applyEntitlementFromBilling(null); } catch(_) {}
    }
  }catch(e){
    $("lockMsg").textContent = "決済確認に失敗: " + String(e.message || e);
  }finally{
    // clean URL (keep path)
    url.searchParams.delete("success");
    url.searchParams.delete("session_id");
    window.history.replaceState({}, "", url.pathname + url.search);
    setStatus("準備OK");
  }
}

async function syncSubscriptionStatus(){
  try{
    const subId = ls.get("stripe_sub_id_"+VARIANT, null);
    const sessId = ls.get("stripe_session_id_"+VARIANT, null);
    if (!subId && !sessId) return;

    const qs = subId ? `subscription_id=${encodeURIComponent(subId)}` : `session_id=${encodeURIComponent(sessId)}`;
    const r = await fetch(`/api/subscription-status?${qs}`);
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error || "status error");

    if (j.active){
      unlocked = true;
      ls.set("aiga_unlocked_"+VARIANT, true);
      if (j.subscription_id) ls.set("stripe_sub_id_"+VARIANT, j.subscription_id);
      if (sessId) ls.set("stripe_session_id_"+VARIANT, sessId);
      $("lock").style.display="none";
    
      // ★ 購読プラン(plan_key) → 4プラン権限に反映
      try { applyEntitlementFromBilling(j.plan_key || mapLegacyBillingPlan(j.plan) || null); } catch(_) {}
}else{
      unlocked = false;
      ls.del("aiga_unlocked_"+VARIANT);
      // 混乱を避けて key も消す
      ls.del("stripe_sub_id_"+VARIANT);
      ls.del("stripe_session_id_"+VARIANT);
      // ★ 非アクティブなら権限をliteへ
      try { applyEntitlementFromBilling(null); } catch(_) {}
    }
    setTrialInfo();
  }catch(e){
    // 取れないときは「解除しない」側に倒す（無料枠は使える）
    unlocked = false;
    ls.del("aiga_unlocked_"+VARIANT);
    try { applyEntitlementFromBilling(null); } catch(_) {}
    setTrialInfo();
  }
}


function unlockByCode(){
  const code = $("unlockCode").value.trim();
  if (!code) return;
  if (code === (CFG.unlock_code || "")){
    unlocked = true;
    ls.set("aiga_unlocked_"+VARIANT, true);
    $("lock").style.display="none";
    $("lockMsg").textContent = "";
    setTrialInfo();
  
    // ★ 解除コードは強い権限（現在は pro 相当）
    try { applyEntitlementFromBilling("pro"); } catch(_) {}
}else{
    $("lockMsg").textContent = "解除コードが違います。";
  }
}

/* ========= init ========= */
async function init(){
  try{
    $("variantPill").textContent = VARIANT;
    setStatus("データ読込中…");

    // load json
    CFG = await loadJson("./config.json");
    EX = await loadJson("./examples.json");

    // allow override by path variant (so /app/ssw でもOK)
    if (VARIANT !== CFG.variant && (VARIANT === "ssw" || VARIANT === "trainee")){
      // config.json の内容は共通で使い、variantだけは表示上切替
    }

    populate();

    
    toggleSbarPanel(); toggleFallPanel();
// apply settings to UI
    if ($("ttsSel")) $("ttsSel").value = SETTINGS.ttsSel || "off";
    if ($("ttsRate")) $("ttsRate").value = SETTINGS.ttsRate || "1";
    if ($("ttsAuto")) $("ttsAuto").value = SETTINGS.ttsAuto || "off";
    if ($("uiLabelMode")) $("uiLabelMode").value = SETTINGS.uiLabelMode || "jp_id";

    setTrialInfo();

    renderHistory();
    renderStats();
    renderAnno(lastAnnotations);
    setStatus("準備OK");

    // events（※Stripe状態確認が失敗してもUI操作を止めないため、先にバインド）
    $("sceneSel").addEventListener("change", ()=>{ updateCategories(); updatePersonasForScene(); toggleSbarPanel(); toggleFallPanel(); });
    $("btnExample").addEventListener("click", insertExample);
    
    $("btnSbarBuild")?.addEventListener("click", ()=>{
      try{
        if (!isEmergencyScene()){
          showLocalMsg("sbarLocalMsg", "シーンを「急変」にしてから押してください。", true);
          return;
        }
        const target = $("personaSel")?.value || "nurse";
        const sbarTxt = buildSbarText(target);
        $("userInput").value = sbarTxt;
        // help user: set category to "call" when available
        try{ const cats = EX.scenes?.["emergency"] || []; if (cats.some(c=>c.key==="call")) $("catSel").value = "call"; }catch(e){}
        showLocalMsg("sbarLocalMsg", "SBAR文を入力欄に入れました。下の「送信」で練習できます。", false);
        focusUserInput();
        showOk("SBAR文を入力しました。必要なら編集して送信してください。");
      }catch(e){
        console.error("sbar build error", e);
        showLocalMsg("sbarLocalMsg", "SBAR文の作成でエラー: " + String(e.message || e), true);
        showErr("SBAR文の作成でエラー: " + String(e.message || e));
      }
    });
    $("btnSbarClear")?.addEventListener("click", clearSbar);
    $("btnFallBuild")?.addEventListener("click", clearSbar);
    $("btnFallBuild")?.addEventListener("click", ()=>{
  try{
    if (!isFallScene()){
      if ($("okBox")){
        $("okBox").style.display="block";
        $("okBox").textContent = "シーンを「転倒」にしてから押してください。";
        setTimeout(()=>{$("okBox").style.display="none";}, 2200);
      }
      return;
    }
    const target = $("personaSel")?.value || "nurse";
    const txt = buildFallText(target);

    const input = $("userInput");
    if (input){
      input.value = txt;
      input.focus();
      // 入力欄が画面外になりやすいので、見える位置に移動
      try{ input.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
    }

    // help user: set category to "report" when available
    try{
      const cats = EX.scenes?.["fall"] || [];
      if (cats.some(c=>c.key==="report")) $("catSel").value = "report";
    }catch(e){}

    if ($("okBox")){
      $("okBox").style.display="block";
      $("okBox").textContent = "転倒報告文を入力しました。必要なら編集して送信してください。";
      setTimeout(()=>{$("okBox").style.display="none";}, 2200);
    }
  }catch(e){
    console.error("fall build error", e);
    if ($("errBox")){
      $("errBox").style.display="block";
      $("errBox").textContent = "転倒報告文の作成でエラー: " + String(e.message || e);
    }
  }
});
$("btnFallClear")?.addEventListener("click", clearFall);

$("btnClear").addEventListener("click", ()=>{
      if (!confirm("履歴を消しますか？")) return;
      history = [];
      ls.set("aiga_history_"+VARIANT, history);
      renderHistory();
    });
    $("btnSend").addEventListener("click", send);
    $("userInput").addEventListener("keydown", (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") send();
    });
    $("btnPay").addEventListener("click", startCheckout);
    $("btnCloseLock").addEventListener("click", ()=>{ $("lock").style.display="none"; });
    $("btnUnlock").addEventListener("click", unlockByCode);
    // TTS controls
    $("btnStopTts")?.addEventListener("click", stopTts);
    $("ttsSel")?.addEventListener("change", ()=>{ saveSettings(); renderHistory(); });
    $("ttsRate")?.addEventListener("change", saveSettings);
    $("ttsAuto")?.addEventListener("change", saveSettings);
    $("uiLabelMode")?.addEventListener("change", ()=>{ saveSettings(); rebuildSelectLabels(); renderHistory(); renderStats(); });

    // Speak suggested
    $("btnSpeakSuggestHira")?.addEventListener("click", ()=>{ if (lastSuggested) speakOnce(lastSuggested.hira || ""); });
    $("btnSpeakSuggestRoma")?.addEventListener("click", ()=>{ if (lastSuggested) speakOnce(lastSuggested.romaji || ""); });    // Click-to-speak in history (event delegation)
    // - data-idx / data-field が取れない時や、triのキー違いでも再生できるようにフォールバック
    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".ttsBtn");
      if (!btn) return;
      // 例: 無効ボタンは反応しない
      if (btn.disabled) return;

      const field = (btn.dataset.field || "").trim();
      const idxRaw = (btn.dataset.idx ?? "").trim();
      let text = "";

      // 1) history配列から拾う
      if (idxRaw !== "") {
        const idx = Number(idxRaw);
        const item = (history || [])[idx];
        if (item && item.tri) {
          if (field === "hira") text = item.tri.hira || item.tri.jp || item.tri.text || "";
          else if (field === "romaji") text = item.tri.romaji || "";
          else if (field) text = item.tri[field] || "";
        }
      }

      // 2) DOMから拾う（data-idxがズレてもOK）
      if (!text) {
        const row = btn.closest(".triRow");
        const t = row ? row.querySelector(".triText") : null;
        text = (t ? t.textContent : "").trim();
      }

      if (!text) {
        console.warn("TTS: no text to speak", { field, idxRaw, btn });
        return;
      }

      // 日本語で読み上げ（ひらがな/ローマ字ともに ja-JP でOK）
      speakOnce(text, "ja-JP");
    });

    // Reset learning log
    $("btnResetLog")?.addEventListener("click", ()=>{
      if (!confirm("学習ログをリセットしますか？")) return;
      STATS = { scenes:{}, categories:{} };
      ls.set("aiga_stats_"+VARIANT, STATS);
      renderStats();
    });

    // URLパラメータ検証 / サブスク状態同期（失敗しても致命傷にしない）
    try{ await verifyFromUrl(); }catch(e){ console.warn("verifyFromUrl failed", e); }
    try{ await syncSubscriptionStatus(); }catch(e){ console.warn("syncSubscriptionStatus failed", e); }

    // ★ プラン管理の初期化
    if (typeof PlanManager !== 'undefined') {
      // プラン情報を表示
      const config = PlanManager.getPlanConfig();
      const planInfoEl = document.getElementById('planInfo');
      if (planInfoEl) {
        planInfoEl.textContent = config.name;
      }
      
      // 使用回数表示を更新
      PlanManager.updateUsageDisplay();
    }

  }catch(e){
    setStatus("起動失敗");
    $("errBox").style.display="block";
    $("errBox").textContent = "初期化エラー: " + String(e.message || e);
  }
}

init();
</script>
</body>
</html>
