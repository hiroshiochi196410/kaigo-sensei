<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kaigo Sensei - App</title>
  <style>
    :root{
      --bg:#f5f7ff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --brand:#4f46e5;
      --brand2:#3b82f6;
      --line:#e2e8f0;
      --pill:#eef2ff;
      --warn:#f97316;
      --ok:#16a34a;
      --shadow: 0 18px 40px rgba(15, 23, 42, .12);
      --shadow2: 0 8px 18px rgba(15, 23, 42, .10);
      --radius: 18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }
    a{color:inherit; text-decoration:none;}
    .top{
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color:#fff;
      padding: 28px 18px 22px;
      position: sticky;
      top:0;
      z-index: 10;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .wrap{max-width: 1080px; margin:0 auto;}
    .title{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap:wrap;
    }
    .brand h1{margin:0; font-size: 34px; letter-spacing:.2px;}
    .brand .sub{margin-top:6px; font-size:14px; opacity:.92}
    .top-right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .badge{
      padding:8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      font-weight: 700;
      font-size: 13px;
      display:flex; gap:8px; align-items:center;
    }
    .pillbtn{
      padding:10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      font-weight: 700;
      font-size: 13px;
      display:flex; gap:8px; align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .pillbtn:hover{background: rgba(255,255,255,.22);}
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .tab{
      padding:12px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      cursor:pointer;
      font-weight: 800;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .tab.active{
      background:#fff;
      color:#111827;
      border-color: rgba(255,255,255,.7);
    }

    main{padding: 22px 14px 64px;}
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 18px;
      margin-top: 14px;
    }
    .hint{
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      color:#111827;
      border-radius: 14px;
      padding: 14px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .hint b{display:block; margin-bottom:4px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .chip{
      background: var(--pill);
      border: 1px solid #c7d2fe;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background: #fff;
      border-color:#fff;
      color:#111827;
    }
    .control{
      width: 100%;
      background:#fff7ed;
      border: 1px solid #fdba74;
      border-radius: 14px;
      padding: 12px;
    }
    textarea{
      width:100%;
      min-height: 92px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      outline:none;
      font-size: 16px;
      resize: vertical;
      background:#fff;
    }
    textarea:focus{border-color:#a5b4fc; box-shadow: 0 0 0 4px rgba(99,102,241,.18);}
    .btn{
      border:none;
      background: var(--brand);
      color:#fff;
      font-weight: 900;
      padding: 12px 16px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btn.secondary{
      background: #e2e8f0;
      color:#0f172a;
      box-shadow:none;
    }
    .btn.warn{
      background: var(--warn);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .out{
      margin-top: 12px;
      border-radius: 14px;
      background:#f8fafc;
      border: 1px solid var(--line);
      padding: 14px;
      line-height: 1.6;
    }
    .kicker{color: var(--muted); font-size: 13px; margin: 0 0 8px;}
    .big{
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 10px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media(min-width: 900px){
      .grid{grid-template-columns: 1.1fr .9fr;}
    }

    /* pay modal */
    .overlay{
      position: fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(620px, 100%);
      background:#fff;
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      border: 1px solid rgba(0,0,0,.06);
    }
    .modal h2{margin: 4px 0 6px; font-size: 22px;}
    .modal p{margin: 8px 0; color:#334155; line-height:1.6;}
    .modal .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    .fine{font-size: 12px; color:#64748b;}

    /* diag */
    #diag{
      display:none;
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 80;
      padding: 12px 14px;
      border-radius: 14px;
      background: #0b0f19;
      color: #b7ffb7;
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
      font-weight: 800;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="diag"></div>

  <header class="top">
    <div class="wrap">
      <div class="title">
        <div class="brand">
          <h1>Kaigo Senseiï¼ˆå£²ã‚Œã‚‹å½¢ï¼šRoleplayï¼‰</h1>
          <div class="sub">ğŸ›¡ï¸ æ€’ã‚‰ã‚Œãªã„ç ”ä¿®ãƒ»ç¾å ´ã®ä¼šè©±ã‚’å®‰å…¨ã«ç·´ç¿’</div>
        </div>
        <div class="top-right">
          <div class="badge" id="trialBadge">FREE æ®‹ã‚Š 0/3</div>
          <label class="pillbtn" style="gap:10px;">
            <input type="checkbox" id="toggleKatakana" />
            ã‚«ã‚¿ã‚«ãƒŠè¡¨ç¤º
          </label>
          <a class="pillbtn" href="/" title="LPã«æˆ»ã‚‹">ğŸ  LP</a>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="mode tabs">
        <div class="tab active" id="tabTerjemah" role="tab" tabindex="0">ğŸ“˜ Terjemah</div>
        <div class="tab" id="tabRoleplay" role="tab" tabindex="0">ğŸ­ Roleplay AI</div>
      </div>

      <div class="tabs" id="personaBar" style="display:none;">
        <div class="chip active" data-persona="åˆ©ç”¨è€…ï¼ˆç©ã‚„ã‹ï¼‰">åˆ©ç”¨è€…ï¼ˆç©ã‚„ã‹ï¼‰</div>
        <div class="chip" data-persona="åˆ©ç”¨è€…ï¼ˆæ€’ã‚Šï¼‰">åˆ©ç”¨è€…ï¼ˆæ€’ã‚Šï¼‰</div>
        <div class="chip" data-persona="èªçŸ¥ç—‡">èªçŸ¥ç—‡</div>
        <div class="chip" data-persona="å®¶æ—ï¼ˆä¸å®‰ï¼‰">å®¶æ—ï¼ˆä¸å®‰ï¼‰</div>
        <div class="chip" data-persona="å®¶æ—ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ï¼‰">å®¶æ—ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ï¼‰</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card hint" id="hintBox">
      <div style="font-size:20px;">ğŸ’¡</div>
      <div>
        <b id="hintTitle">Terjemah</b>
        <div id="hintText">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã‚’å…¥ã‚Œã‚‹ã¨ã€ä»‹è­·ç¾å ´å‘ã‘ã®ä¸å¯§ãªæ—¥æœ¬èªï¼‹ãƒ­ãƒ¼ãƒå­—ï¼ˆï¼‹ã‚«ã‚¿ã‚«ãƒŠï¼‰ã§è¿”ã—ã¾ã™ã€‚</div>
      </div>
    </section>

    <section class="grid">
      <!-- left -->
      <section class="card" id="panelLeft">
        <p class="kicker" id="panelKicker">Terjemahï¼šã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <div class="control">
          <div style="font-weight:900; margin-bottom:6px;" id="inputTitle">Terjemahï¼šã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          <div style="color:#9a3412; font-size:13px;">ä¾‹ï¼‰Tolong duduk di sini.</div>
        </div>

        <div style="height:10px;"></div>
        <textarea id="inputText" placeholder="ã“ã“ã«å…¥åŠ›â€¦"></textarea>

        <div class="row" style="margin-top: 12px;">
          <button class="btn" id="btnSend">é€ä¿¡</button>
          <button class="btn secondary" id="btnClear">ã‚¯ãƒªã‚¢</button>
          <button class="btn warn" id="btnPay" style="display:none;">èª²é‡‘ã—ã¦ç¶šã‘ã‚‹</button>
        </div>

        <div class="out" id="outputBox" style="display:none;"></div>
      </section>

      <!-- right -->
      <section class="card" id="panelRight">
        <p class="kicker">çŠ¶æ…‹</p>
        <div class="out" id="statusBox">
          <div class="big" id="statusTitle">ç„¡æ–™ä½“é¨“ä¸­ï¼ˆæ®‹ã‚Š 0 / 3 å›ï¼‰</div>
          <div style="color:#475569; line-height:1.7;">
            ã“ã®AIã¯ã€ä»‹è­·ç¾å ´ã®æ—¥æœ¬èªã‚’ã€Œæ€’ã‚‰ãšã«ã€ç·´ç¿’ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br/>
            å›æ•°åˆ¶é™ã«é”ã—ãŸã‚‰ã€èª²é‡‘ãƒªãƒ³ã‚¯ã¸ã”æ¡ˆå†…ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="out" style="margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">âœ… èª²é‡‘æ¸ˆã¿ã®æ–¹</div>
          <div class="fine">ä»Šã¯ã€ŒStripeæ±ºæ¸ˆå®Œäº†ã‚’è‡ªå‹•åˆ¤å®šã€ã™ã‚‹å‰æ®µéšã§ã™ã€‚ãƒ†ã‚¹ãƒˆç”¨ã«ã€æ±ºæ¸ˆå¾Œã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã“ã®ç«¯æœ«ã§Proæ‰±ã„ã«ãªã‚Šã¾ã™ã€‚</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" id="btnMarkPaid">èª²é‡‘æ¸ˆã¿ã«ã™ã‚‹ï¼ˆã“ã®ç«¯æœ«ï¼‰</button>
            <button class="btn secondary" id="btnResetPaid">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div class="overlay" id="payOverlay" aria-hidden="true">
    <div class="modal">
      <h2>ç„¡æ–™æ ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ</h2>
      <p>ç¶šã‘ã¦ä½¿ã†ã«ã¯ã€èª²é‡‘ãƒªãƒ³ã‚¯ã‹ã‚‰ãŠæ‰‹ç¶šããã ã•ã„ã€‚</p>
      <p class="fine">â€» æ±ºæ¸ˆå®Œäº†ã®è‡ªå‹•åˆ¤å®šï¼ˆWebhookï¼‰ã‚’å…¥ã‚Œã‚‹ã¾ã§ã¯ã€æ±ºæ¸ˆå¾Œã«ã€Œèª²é‡‘æ¸ˆã¿ã«ã™ã‚‹ï¼ˆã“ã®ç«¯æœ«ï¼‰ã€ã‚’æŠ¼ã—ã¦æ¤œè¨¼ã§ãã¾ã™ã€‚</p>
      <div class="actions">
        <a class="btn" id="btnOpenStripe" href="#" target="_blank" rel="noopener">Stripeã§æ”¯æ‰•ã†</a>
        <button class="btn secondary" id="btnClosePay">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // Settingsï¼ˆã“ã“ã ã‘å·®ã—æ›¿ãˆã‚Œã°OKï¼‰
    // ==============================
    const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/xxxxxx"; // â† å¾Œã§å·®ã—æ›¿ãˆ
    const CONTACT_BOOKING_URL = "https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ1DZzbc2Em4gn-ABTKavXY1dpFHRpO0ynpn8iSeOx_9vRUdr2MDLcRSv_tZHY4aMVy6cegQGO2L?gv=true";
    const COMPANY_URL = "https://aipuru-hu.com";

    // æ–½è¨­å‘ã‘å•ã„åˆã‚ã›ï¼ˆåŒã˜äºˆç´„ãƒšãƒ¼ã‚¸ã¸èª˜å°ã—ãŸã„å ´åˆãªã©ï¼‰
    const FACILITY_CONTACT_URL = CONTACT_BOOKING_URL;

    const TRIAL_LIMIT_PER_DAY = 3;

    // ==============================
    // Helpers
    // ==============================
    function showDiag(title, err){
      const box = document.getElementById("diag");
      if(!box) return;
      box.style.display = "block";
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      box.textContent = title + "\n" + msg;
      console.error(title, err);
    }
    window.addEventListener("error", (e)=> showDiag("JS Error:", e.error || e.message || e));
    window.addEventListener("unhandledrejection", (e)=> showDiag("Promise Error:", e.reason || e));

    const $ = (id)=> document.getElementById(id);

    function todayKey(){
      const d = new Date();
      return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
    }

    function getTrialState(){
      const paid = localStorage.getItem("paidUser")==="true";
      const key = todayKey();
      const storedKey = localStorage.getItem("trialStartDate");
      if(storedKey !== key){
        localStorage.setItem("trialStartDate", key);
        localStorage.setItem("trialCount", "0");
      }
      const count = Number(localStorage.getItem("trialCount") || "0");
      const left = Math.max(0, TRIAL_LIMIT_PER_DAY - count);
      return { paid, count, left };
    }

    function canUseOnce(){
      const s = getTrialState();
      return s.paid || s.left > 0;
    }

    function consumeOnce(){
      const s = getTrialState();
      if(s.paid) return true;
      if(s.left <= 0) return false;
      localStorage.setItem("trialCount", String(s.count + 1));
      return true;
    }

    async function callClaudeAPI(prompt){
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok){
        const msg = data.error || data.details || res.statusText;
        throw new Error("APIã‚¨ãƒ©ãƒ¼: " + msg);
      }
      // è¿”ã‚Šå€¤ã¯ { content: [{text:"..."}] } or { text:"..." } ã‚’æƒ³å®š
      const contentText = (data && data.content && data.content[0] && data.content[0].text) ? data.content[0].text
                        : (data && data.text) ? data.text
                        : "";
      return contentText;
    }

    // Claudeã«ã€ŒJSONã ã‘è¿”ã™ã€ã‚¬ãƒ¼ãƒ‰
    const jsonGuard = [
      "ANDA HARUS mengikuti aturan ini:",
      "- Keluarkan HANYA JSON valid.",
      "- Jangan pakai markdown.",
      "- Jangan pakai teks lain.",
      "- Semua nilai string harus diapit tanda kutip ganda."
    ].join("\n");

    function buildPromptTerjemah(text){
      return `${jsonGuard}
Terjemahkan Bahasa Indonesia -> Bahasa Jepang yang sopan dan natural untuk konteks kerja perawatan lansia.
Buat juga romaji (mudah dibaca orang Indonesia) dan katakana.
Tambahkan 1 tips singkat.
Input: "${text}"
Keluarkan JSON persis:
{"japanese":"...","romaji":"...","katakana":"...","indonesian":"${text}","tips":"..."}
`;
    }

    function buildPromptRoleplayStart(persona){
      return `${jsonGuard}
Anda adalah pelatih percakapan Bahasa Jepang untuk pekerja perawatan lansia (kaigo).
Buat roleplay singkat.
Persona: "${persona}"
Buat situasi nyata di panti jompo / rumah sakit / perawatan.
Keluarkan HANYA JSON.
Format JSON persis:
{"situation":"...","you":"...","ai":"...","goal":"...","first_japanese":"...","first_romaji":"...","first_katakana":"...","first_indonesian":"..."}
`;
    }

    function buildPromptRoleplayReply(persona, situation, lastUserJapanese){
      return `${jsonGuard}
Anda adalah lawan bicara dalam roleplay Bahasa Jepang untuk kaigo.
Persona: "${persona}"
Situasi: "${situation}"
Pengguna berkata (Bahasa Jepang): "${lastUserJapanese}"
Balas dengan 1 kalimat Bahasa Jepang yang sopan dan natural + romaji + katakana + terjemahan Indonesia + 1 tips singkat.
Keluarkan JSON persis:
{"japanese":"...","romaji":"...","katakana":"...","indonesian":"...","tips":"..."}
`;
    }

    function parseJsonFromText(text){
      // ä½™è¨ˆãªå‰ç½®ããŒæ··ã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€æœ€åˆã¨æœ€å¾Œã® { } ã‚’æ‹¾ã†
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      if(start === -1 || end === -1 || end <= start) throw new Error("AIã®è¿”ç­”ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      const jsonText = text.slice(start, end+1);
      return JSON.parse(jsonText);
    }

    // ==============================
    // UI State
    // ==============================
    let mode = "terjemah"; // "roleplay"
    let persona = "åˆ©ç”¨è€…ï¼ˆç©ã‚„ã‹ï¼‰";
    let currentSituation = "";
    let katakanaOn = false;

    function renderTrial(){
      const s = getTrialState();
      const badge = $("trialBadge");
      const statusTitle = $("statusTitle");
      if(s.paid){
        badge.textContent = "Proï¼ˆç„¡åˆ¶é™ï¼‰";
        statusTitle.textContent = "Proï¼ˆç„¡åˆ¶é™ï¼‰";
        $("btnPay").style.display = "none";
      }else{
        badge.textContent = `FREE æ®‹ã‚Š ${s.left}/${TRIAL_LIMIT_PER_DAY}`;
        statusTitle.textContent = `ç„¡æ–™ä½“é¨“ä¸­ï¼ˆæ®‹ã‚Š ${s.left} / ${TRIAL_LIMIT_PER_DAY} å›ï¼‰`;
        $("btnPay").style.display = (s.left<=0) ? "inline-block" : "none";
      }
    }

    function setMode(next){
      mode = next;
      $("tabTerjemah").classList.toggle("active", mode==="terjemah");
      $("tabRoleplay").classList.toggle("active", mode==="roleplay");
      $("personaBar").style.display = (mode==="roleplay") ? "flex" : "none";

      if(mode==="terjemah"){
        $("hintTitle").textContent = "Terjemah";
        $("hintText").textContent = "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã‚’å…¥ã‚Œã‚‹ã¨ã€ä»‹è­·ç¾å ´å‘ã‘ã®ä¸å¯§ãªæ—¥æœ¬èªï¼‹ãƒ­ãƒ¼ãƒå­—ï¼ˆï¼‹ã‚«ã‚¿ã‚«ãƒŠï¼‰ã§è¿”ã—ã¾ã™ã€‚";
        $("panelKicker").textContent = "Terjemahï¼šã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã§å…¥åŠ›ã—ã¦ãã ã•ã„";
        $("inputTitle").textContent = "Terjemahï¼šã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªã§å…¥åŠ›ã—ã¦ãã ã•ã„";
        $("inputText").placeholder = "ä¾‹ï¼‰Tolong duduk di sini.";
      }else{
        $("hintTitle").textContent = "Roleplay AI";
        $("hintText").textContent = "ç¾å ´ã§èµ·ã“ã‚ŠãŒã¡ãªå ´é¢ã‚’ã€AIç›¸æ‰‹ã«å®‰å…¨ã«ç·´ç¿’ã§ãã¾ã™ï¼ˆåˆ©ç”¨è€…ãƒ»å®¶æ—ãƒ»èªçŸ¥ç—‡ãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œãªã©ï¼‰ã€‚";
        $("panelKicker").textContent = "Roleplayï¼šã¾ãšã¯ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ˆçŠ¶æ³ãŒå‡ºã¾ã™ï¼‰";
        $("inputTitle").textContent = "Roleplayï¼šã‚ãªãŸã®ç™ºè©±ï¼ˆæ—¥æœ¬èªï¼‰ã‚’å…¥åŠ›";
        $("inputText").placeholder = "ä¾‹ï¼‰ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™ã­ã€‚å¤–ã‚’æ•£æ­©ã—ãŸã„ã§ã™ã€‚";
      }
      $("outputBox").style.display = "none";
      $("outputBox").innerHTML = "";
      $("inputText").value = "";
      renderTrial();
    }

    function setPersona(next){
      persona = next;
      [...document.querySelectorAll("#personaBar .chip")].forEach(el=>{
        el.classList.toggle("active", el.dataset.persona === persona);
      });
      // roleplayä¸­ãªã‚‰çŠ¶æ³ã‚’ä½œã‚Šç›´ã™ã¨ã‚ã‹ã‚Šã‚„ã™ã„
      currentSituation = "";
      if(mode==="roleplay"){
        $("outputBox").style.display = "none";
        $("outputBox").innerHTML = "";
      }
    }

    function openPay(){
      $("payOverlay").classList.add("show");
      $("payOverlay").setAttribute("aria-hidden","false");
      $("btnOpenStripe").href = STRIPE_PAYMENT_LINK;
    }
    function closePay(){
      $("payOverlay").classList.remove("show");
      $("payOverlay").setAttribute("aria-hidden","true");
    }

    function formatAnswerBlock(obj){
      const showK = katakanaOn && obj.katakana;
      const kLine = showK ? `<div class="mono" style="margin-top:8px; color:#334155;">${escapeHtml(obj.katakana)}</div>` : "";
      const tip = obj.tips ? `<div style="margin-top:10px; padding-top:10px; border-top:1px solid #e2e8f0; color:#334155;"><b>Tips</b>ï¼š${escapeHtml(obj.tips)}</div>` : "";
      return `
        <div style="font-weight:900; font-size:20px;">${escapeHtml(obj.japanese || "")}</div>
        <div class="mono" style="margin-top:8px; color:#334155;">${escapeHtml(obj.romaji || "")}</div>
        ${kLine}
        <div style="margin-top:10px; color:#475569;">ID ${escapeHtml(obj.indonesian || "")}</div>
        ${tip}
      `;
    }

    function formatRoleplayStart(obj){
      const showK = katakanaOn && obj.first_katakana;
      const kLine = showK ? `<div class="mono" style="margin-top:6px; color:#334155;">ğŸ”Š ${escapeHtml(obj.first_katakana)}</div>` : "";
      return `
        <div style="font-weight:900; margin-bottom:8px;">ğŸ­ Roleplayé–‹å§‹</div>
        <div><b>çŠ¶æ³</b>ï¼š${escapeHtml(obj.situation || "")}</div>
        <div class="fine" style="margin-top:6px;"><b>ã‚ãªãŸ</b>ï¼š${escapeHtml(obj.you || "")}ã€€ï¼ã€€<b>AI</b>ï¼š${escapeHtml(obj.ai || "")}</div>
        <div class="fine" style="margin-top:4px;"><b>ç›®æ¨™</b>ï¼š${escapeHtml(obj.goal || "")}</div>
        <hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0;">
        <div style="font-weight:900; font-size:20px;">${escapeHtml(obj.first_japanese || "")}</div>
        <div class="mono" style="margin-top:6px; color:#334155;">ğŸ”Š ${escapeHtml(obj.first_romaji || "")}</div>
        ${kLine}
        <div style="margin-top:10px; color:#475569;">ID ${escapeHtml(obj.first_indonesian || "")}</div>
      `;
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function onSend(){
      $("btnSend").disabled = true;
      try{
        if(!consumeOnce()){
          renderTrial();
          openPay();
          return;
        }
        renderTrial();

        const text = $("inputText").value.trim();
        if(!text){
          $("btnSend").disabled = false;
          return;
        }

        if(mode === "terjemah"){
          const prompt = buildPromptTerjemah(text);
          const raw = await callClaudeAPI(prompt);
          const obj = parseJsonFromText(raw);
          $("outputBox").style.display = "block";
          $("outputBox").innerHTML = formatAnswerBlock(obj);
        }else{
          // roleplay
          if(!currentSituation){
            // if situation not started, create start block using persona
            const prompt = buildPromptRoleplayStart(persona);
            const raw = await callClaudeAPI(prompt);
            const obj = parseJsonFromText(raw);
            currentSituation = obj.situation || "";
            $("outputBox").style.display = "block";
            $("outputBox").innerHTML = formatRoleplayStart(obj);
          }else{
            const prompt = buildPromptRoleplayReply(persona, currentSituation, text);
            const raw = await callClaudeAPI(prompt);
            const obj = parseJsonFromText(raw);
            $("outputBox").style.display = "block";
            $("outputBox").innerHTML = `
              <div class="fine" style="margin-bottom:6px;"><b>ã‚ãªãŸ</b>ï¼š${escapeHtml(text)}</div>
              ${formatAnswerBlock(obj)}
            `;
          }
        }
      }catch(err){
        showDiag("App Error:", err);
        // å¤±æ•—ã—ãŸã‚‰å›æ•°ã¯æˆ»ã•ãªã„ï¼ˆæ‚ªç”¨é˜²æ­¢ï¼‰ã€‚å¿…è¦ãªã‚‰ã“ã“ã§æˆ»ã™ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´å¯
      }finally{
        $("btnSend").disabled = false;
      }
    }

    function bind(){
      $("tabTerjemah").addEventListener("click", ()=> setMode("terjemah"));
      $("tabRoleplay").addEventListener("click", ()=> setMode("roleplay"));

      $("toggleKatakana").addEventListener("change", (e)=>{
        katakanaOn = !!e.target.checked;
        // outputå†æç”»ã¯ç°¡æ˜“ï¼šæ¬¡ã®å¿œç­”ã‹ã‚‰åæ˜ 
      });

      [...document.querySelectorAll("#personaBar .chip")].forEach(el=>{
        el.addEventListener("click", ()=> setPersona(el.dataset.persona));
      });

      $("btnSend").addEventListener("click", onSend);
      $("btnClear").addEventListener("click", ()=>{
        $("inputText").value="";
        $("outputBox").style.display="none";
        $("outputBox").innerHTML="";
      });

      $("btnPay").addEventListener("click", openPay);
      $("btnClosePay").addEventListener("click", closePay);
      $("payOverlay").addEventListener("click", (e)=>{
        if(e.target === $("payOverlay")) closePay();
      });

      $("btnMarkPaid").addEventListener("click", ()=>{
        localStorage.setItem("paidUser","true");
        renderTrial();
        closePay();
      });
      $("btnResetPaid").addEventListener("click", ()=>{
        localStorage.removeItem("paidUser");
        localStorage.removeItem("trialStartDate");
        localStorage.removeItem("trialCount");
        renderTrial();
      });

      // Query param ?paid=1 ã§ProåŒ–ï¼ˆæ¤œè¨¼ç”¨ï¼‰
      const qs = new URLSearchParams(location.search);
      if(qs.get("paid")==="1"){
        localStorage.setItem("paidUser","true");
      }
    }

    // init
    try{
      $("btnOpenStripe").href = STRIPE_PAYMENT_LINK;
      bind();
      renderTrial();
      setMode("terjemah");
    }catch(err){
      showDiag("Init Error:", err);
    }
  </script>
</body>
</html>
