<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>介護ロールプレイAI（Trainee）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 16px; }
    textarea { width: 100%; min-height: 90px; }
    button { margin: 6px 4px; padding: 6px 12px; cursor: pointer; }
    .box { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 10px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 320px; }
    .muted { color:#666; font-size: 12px; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select { padding: 6px 8px; }
  </style>
</head>
<body>

<h2>介護ロールプレイAI</h2>

<div class="toolbar">
  Scene:
  <select id="scene"></select>

  Persona:
  <select id="persona"></select>

  カテゴリ:
  <select id="category"></select>

  レベル:
  <select id="level"></select>

  <button type="button" id="btnExample">例文を入れる</button>

  <label>
    <input type="checkbox" id="autoStage2" checked>
    Stage2を自動実行
  </label>

  <span class="muted" id="exStatus">examples.json: 読み込み中…</span>
</div>

<h3>介護士（あなた）の発話（日本語）</h3>
<textarea id="jpInput" placeholder="例文ボタンで自動入力、または自由入力"></textarea>

<h3>介護士発話（ローマ字）</h3>
<textarea id="romaInput" placeholder="（必要なら）ローマ字を入力"></textarea>

<button type="button" id="btnSend">送信</button>
<button type="button" id="btnStage2Only">Stage2だけ実行</button>

<div class="row">
  <div class="col box">
    <h4>Stage1（日本語）</h4>
    <div id="aiReply"></div>
    <div id="feedback" style="margin-top:6px;"></div>
    <div style="margin-top:8px;">
      <div class="muted">推奨返答（日本語）</div>
      <textarea id="jpSuggest">Stage1実行後に入ります</textarea>
    </div>
  </div>

  <div class="col box">
    <h4>Stage2（翻訳・推奨返答）</h4>
    <div class="muted">ローマ字（推奨返答）</div>
    <div id="romaSuggest" style="margin:6px 0 10px;"></div>

    <div class="muted">インドネシア語（推奨返答）</div>
    <div id="idSuggest" style="margin-top:6px;"></div>
  </div>
</div>

<script>
let EX = null;

function $(id){ return document.getElementById(id); }
function setStatus(msg){ $("exStatus").textContent = msg; }

function unique(arr){ return Array.from(new Set(arr)).filter(Boolean); }

function fillSelect(selectEl, values, preferred){
  const cur = selectEl.value;
  selectEl.innerHTML = "";
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  });
  if (preferred && values.includes(preferred)) selectEl.value = preferred;
  else if (values.includes(cur)) selectEl.value = cur;
}

function normalizeExamples(raw){
  const out = [];

  // array形式
  if (Array.isArray(raw)) {
    for (const e of raw) {
      if (!e) continue;
      const scene = e.scene ?? e.Scene ?? e.scenario;
      const persona = e.persona ?? e.Persona;
      const category = e.category ?? e.カテゴリ ?? e.cat;
      const level = e.level ?? e.レベル ?? e.lv;
      const jp = e.jp ?? e.ja ?? e.text ?? e.example;
      if (!scene || !persona || !category || !level || !jp) continue;

      if (Array.isArray(jp)) jp.forEach(j => out.push({scene, persona, category, level, jp: String(j)}));
      else out.push({scene, persona, category, level, jp: String(jp)});
    }
    return out;
  }

  // ネスト形式
  if (raw && typeof raw === "object") {
    for (const scene of Object.keys(raw)) {
      const pObj = raw[scene];
      if (!pObj || typeof pObj !== "object") continue;
      for (const persona of Object.keys(pObj)) {
        const cObj = pObj[persona];
        if (!cObj || typeof cObj !== "object") continue;
        for (const category of Object.keys(cObj)) {
          const lObj = cObj[category];
          if (!lObj || typeof lObj !== "object") continue;
          for (const level of Object.keys(lObj)) {
            const val = lObj[level];
            if (val == null) continue;

            if (typeof val === "string") out.push({scene, persona, category, level, jp: val});
            else if (Array.isArray(val)) val.forEach(v => out.push({scene, persona, category, level, jp: String(v)}));
            else if (typeof val === "object") {
              const jp = val.jp ?? val.ja ?? val.text;
              if (Array.isArray(jp)) jp.forEach(j => out.push({scene, persona, category, level, jp: String(j)}));
              else if (jp) out.push({scene, persona, category, level, jp: String(jp)});
            }
          }
        }
      }
    }
  }

  return out;
}

function rebuildDropdowns(){
  if (!EX || EX.length === 0) return;

  const scenes = unique(EX.map(e => e.scene));
  fillSelect($("scene"), scenes, scenes[0]);
  rebuildPersona();
}

function rebuildPersona(){
  const scene = $("scene").value;
  const personas = unique(EX.filter(e => e.scene === scene).map(e => e.persona));
  fillSelect($("persona"), personas, personas[0]);
  rebuildCategory();
}

function rebuildCategory(){
  const scene = $("scene").value;
  const persona = $("persona").value;
  const cats = unique(EX.filter(e => e.scene === scene && e.persona === persona).map(e => e.category));
  fillSelect($("category"), cats, cats[0]);
  rebuildLevel();
}

function rebuildLevel(){
  const scene = $("scene").value;
  const persona = $("persona").value;
  const category = $("category").value;
  const levels = unique(EX.filter(e => e.scene === scene && e.persona === persona && e.category === category).map(e => e.level));
  fillSelect($("level"), levels, levels[0]);
}

function pickExample(){
  const scene = $("scene").value;
  const persona = $("persona").value;
  const category = $("category").value;
  const level = $("level").value;

  const matches = EX.filter(e => e.scene===scene && e.persona===persona && e.category===category && e.level===level);
  if (matches.length === 0) return null;
  return matches[Math.floor(Math.random()*matches.length)];
}

function insertExample(){
  const e = pickExample();
  if (!e) { alert("この条件の例文がありません（examples.jsonを確認してください）"); return; }
  $("jpInput").value = e.jp;
}

async function loadExamples(){
  // /app/trainee/ なら同階層の examples.json を読む
  const url = "examples.json?v=" + Date.now();
  try {
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error("HTTP " + r.status);
    const raw = await r.json();
    EX = normalizeExamples(raw);
    if (!EX || EX.length === 0) setStatus("examples.json: 読み込みOK（例文0件）");
    else { setStatus("examples.json: OK（例文 " + EX.length + " 件）"); rebuildDropdowns(); }
  } catch (e) {
    console.error(e);
    EX = [{scene:"入浴", persona:"利用者：穏やか", category:"声かけ", level:"初級", jp:"ゆっくりで大丈夫ですよ。気持ちよく入りましょう。"}];
    setStatus("examples.json: 読み込み失敗 → フォールバック1件");
    rebuildDropdowns();
  }
}

// 仮のStage1/2（UIが壊れないため）
function runStage1(){
  const jp = $("jpInput").value.trim();
  if (!jp) { alert("日本語入力が空です"); return; }
  $("aiReply").innerText = "（AI）安心しました。ありがとうございます。";
  $("feedback").innerText = "声のトーンがとても良いです。";
  $("jpSuggest").value = "寒くないか、ゆっくり確認しながら進めましょう。";
  if ($("autoStage2").checked) runStage2();
}
function runStage2(){
  $("romaSuggest").innerText = "Yukkuri de daijoubu desu yo.";
  $("idSuggest").innerText = "Tidak apa-apa, silakan pelan-pelan.";
}

document.addEventListener("DOMContentLoaded", () => {
  $("btnExample")?.addEventListener("click", insertExample);
  $("btnSend")?.addEventListener("click", runStage1);
  $("btnStage2Only")?.addEventListener("click", runStage2);

  $("scene").addEventListener("change", rebuildPersona);
  $("persona").addEventListener("change", rebuildCategory);
  $("category").addEventListener("change", rebuildLevel);

  loadExamples();
});
</script>

</body>
</html>
