<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kaigo Senseiï½œRoleplayï¼ˆä½“é¨“ï¼‰</title>
  <style>
    :root{--indigo:#4f46e5;--bg:#f5f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);}
    header{background:#111827;color:#fff;padding:14px 16px;position:sticky;top:0;z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#1f2937;color:#e5e7eb;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .badgeFree{background:#eef2ff;color:#1e1b4b;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:900;font-size:14px;border:1px solid rgba(0,0,0,.10);background:#fff;color:#111827;cursor:pointer}
    .btn.primary{background:var(--indigo);color:#fff;border-color:transparent}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.05)}
    label{font-weight:800;font-size:12px}
    select,textarea,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;box-sizing:border-box;background:#fff}
    textarea{min-height:120px;resize:vertical}
    .muted{color:var(--muted);font-size:12px}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .kbox{background:#f9fafb;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kbox h3{margin:0 0 8px;font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;white-space:pre-wrap}
    .hidden{display:none}
  
  .examples{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .exchip{border:1px solid rgba(0,0,0,.12);background:#fff;padding:8px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:13px}
  .exchip:hover{box-shadow:0 6px 16px rgba(0,0,0,.10)}
  .art{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:16px;padding:12px;margin-top:12px}
  .art .cap{font-weight:900;margin-bottom:6px}
  .art .sub{opacity:.85;font-size:12px}
  .art svg{width:100%;height:84px;display:block}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:10px">
      <div style="font-weight:1000;letter-spacing:.2px">Kaigo Sensei</div>
      <div class="pill">ã‚ãªãŸï¼šä»‹è­·è· / AIï¼šåˆ©ç”¨è€…ãƒ»å®¶æ—</div>
    </div>
    <div class="row" style="gap:10px">
      <div class="badgeFree" id="trialBadge">ğŸ†“ ç„¡æ–™ä½“é¨“ æ®‹ã‚Š <span id="trialLeft">3</span> å›</div>
      <button class="btn" id="resetBtn" title="ä½“é¨“ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰">ãƒªã‚»ãƒƒãƒˆ</button>
      <a class="btn" href="/">LPã¸</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">ã‚·ãƒŠãƒªã‚ªè¨­å®š</h2>

      <div class="split">
        <div style="flex:1;min-width:240px">
          <label>ç›¸æ‰‹ï¼ˆAIå´ï¼‰</label>
          <select id="persona">
            <option value="user_calm">åˆ©ç”¨è€…ï¼šç©ã‚„ã‹ï¼ˆåŸºæœ¬ï¼‰</option>
            <option value="user_confused">åˆ©ç”¨è€…ï¼šå°‘ã—æ··ä¹±ï¼ˆèªçŸ¥ç—‡ã®å…¥å£ï¼‰</option>
            <option value="family_anxious">å®¶æ—ï¼šä¸å®‰ãƒ»è³ªå•ãŒå¤šã„</option>
            <option value="family_angry">å®¶æ—ï¼šæ€’ã‚Šãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ </option>
          </select>
          <div class="muted" style="margin-top:6px;">â€»ã‚ãªãŸãŒæ—¥æœ¬èªã§å¯¾å¿œï¼ˆä»‹è­·è·ã¨ã—ã¦è¿”ç­”ï¼‰ã—ã¾ã™ã€‚</div>
        </div>
        <div style="flex:1;min-width:240px">
          <label>çŠ¶æ³</label>
          <select id="scene">
            <option value="bath">å…¥æµ´ä»‹åŠ©</option>
            <option value="toilet">æ’æ³„ä»‹åŠ©</option>
            <option value="meal">é£Ÿäº‹ä»‹åŠ©</option>
            <option value="callbell">ãƒŠãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«ï¼ˆå‘¼ã³å‡ºã—ï¼‰</option>
            <option value="med">æœè–¬</option>
            <option value="complaint">ã‚¯ãƒ¬ãƒ¼ãƒ åˆå‹•</option>
          </select>
          <div class="muted" style="margin-top:6px;">ä¼šè©±ã®ç›®çš„ï¼šèª¤è§£ã‚’æ¸›ã‚‰ã—ã€çŸ­ãä¸å¯§ã«ã€‚</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>ã‚ãªãŸï¼ˆä»‹è­·è·ï¼‰ã®ç™ºè¨€ï¼ˆæ—¥æœ¬èªï¼‰</label>
        <textarea id="userText" placeholder="ä¾‹ï¼šã™ã¿ã¾ã›ã‚“ã€‚ä»Šã‹ã‚‰ãŠé¢¨å‘‚ã«å…¥ã‚Šã¾ã—ã‚‡ã†ã€‚å¯’ããªã„ã‚ˆã†ã«æ¸©ã‹ãã—ã¾ã™ã­ã€‚"></textarea>
        <div class="split" style="margin-top:10px">
          <button class="btn primary" id="sendBtn">é€ä¿¡ï¼ˆRoleplayï¼‰</button>
          <button class="btn" id="exampleBtn">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
        </div>

        <div id="examplesPanel" class="card" style="display:none; margin-top:12px">
          <div class="h2" style="margin:0 0 10px 0">ä¾‹æ–‡ï¼ˆæ—¥æœ¬èª / ãƒ­ãƒ¼ãƒå­— / ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰</div>
          <div id="examplesList" class="stack"></div>
          <div class="muted" style="margin-top:8px">â€»ä¾‹æ–‡ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…¥åŠ›æ¬„ã«è‡ªå‹•ã§å…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="muted" style="margin-top:8px;">â€»ç„¡æ–™ä½“é¨“ã¯3å›ã¾ã§ã€‚å›æ•°ã‚’è¶…ãˆã‚‹ã¨æœ¬ç¨¼åƒæ¡ˆå†…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="card" style="margin-top:14px;background:#0b1220;color:#e5e7eb;border:none">
        <h3 style="margin:0 0 10px;font-size:14px;">æœ¬ç¨¼åƒï¼ˆProï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹</h3>
        <div class="muted" style="color:#cbd5e1">æ–½è¨­å°å…¥ãƒ»æœ¬ç¨¼åƒã®ç›¸è«‡ã¯ã“ã¡ã‚‰ã€‚æ±ºæ¸ˆãƒªãƒ³ã‚¯ã¯å¾Œã§å·®ã—æ›¿ãˆå¯ã€‚</div>
        <div class="split" style="margin-top:10px">
          <a class="btn primary" style="background:#22c55e" href="#" id="payLink">ğŸ’³ æœ¬ç¨¼åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆæ±ºæ¸ˆï¼‰</a>
          <a class="btn" style="border-color:rgba(255,255,255,.18);background:transparent;color:#e5e7eb" href="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ1DZzbc2Em4gn-ABTKavXY1dpFHRpO0ynpn8iSeOx_9vRUdr2MDLcRSv_tZHY4aMVy6ceqQGO2L?gv=true" target="_blank" rel="noreferrer">ğŸ“… ç„¡æ–™ç›¸è«‡</a>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">çµæœ</h2>

      <div id="paywall" class="kbox hidden">
        <h3>ç„¡æ–™ä½“é¨“ã¯çµ‚äº†ã—ã¾ã—ãŸ</h3>
        <div class="muted">ç¶šãã¯æœ¬ç¨¼åƒï¼ˆProï¼‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚</div>
        <div class="split" style="margin-top:10px">
          <a class="btn primary" href="#" id="payLink2">æœ¬ç¨¼åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹</a>
          <a class="btn" href="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ1DZzbc2Em4gn-ABTKavXY1dpFHRpO0ynpn8iSeOx_9vRUdr2MDLcRSv_tZHY4aMVy6ceqQGO2L?gv=true" target="_blank" rel="noreferrer">ç„¡æ–™ç›¸è«‡</a>
        </div>
      </div>

      <div class="kbox" id="aiBox">
        <h3>AIï¼ˆç›¸æ‰‹ï¼‰ã®è¿”ç­”ï¼šæ—¥æœ¬èª</h3>
        <div class="mono" id="aiJp">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>èª­ã¿ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</h3>
        <div class="mono" id="aiRomaji">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</h3>
        <div class="mono" id="aiId">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚ãªãŸï¼ä»‹è­·è·ã®è¡¨ç¾ï¼‰</h3>
        <div class="mono" id="fbJp">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ãŠã™ã™ã‚ã®è¨€ã„æ›ãˆï¼ˆä»‹è­·è·ã¨ã—ã¦ï¼‰</h3>
        <div class="mono" id="suggestJp">â€”</div>
        <div class="muted" style="margin-top:8px;">èª­ã¿ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ï¼š</div>
        <div class="mono" id="suggestRomaji">â€”</div>
        <div class="muted" style="margin-top:8px;">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼š</div>
        <div class="mono" id="suggestId">â€”</div>
      </div>

      <div class="muted" style="margin-top:12px" id="status">æº–å‚™OK</div>
    </section>
  </div>
</main>

<script>
/** ===========================
 *  TRIAL / PRO STATE (B + C)
 * =========================== */
const TRIAL_LIMIT = 3;
const KEY_STATE = "ks_state_v3"; // æ—§ç‰ˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ã
const STRIPE_PAYMENT_LINK = "#"; // â†å¾Œã§å·®ã—æ›¿ãˆï¼ˆStripe Payment Linkï¼‰

function loadState(){
  try{
    const raw = localStorage.getItem(KEY_STATE);
    if(!raw) return { used:0, pro:false };
    const s = JSON.parse(raw);
    return { used: Number(s.used||0), pro: !!s.pro };
  }catch(e){ return { used:0, pro:false }; }
}
function saveState(s){ localStorage.setItem(KEY_STATE, JSON.stringify(s)); }
function remaining(s){ return Math.max(0, TRIAL_LIMIT - (s.used||0)); }

function renderTrial(){
  const s = loadState();
  document.getElementById("trialLeft").textContent = remaining(s);
  const badge = document.getElementById("trialBadge");
  const paywall = document.getElementById("paywall");
  if(s.pro){
    badge.textContent = "ğŸ’¼ æœ¬ç¨¼åƒï¼ˆProï¼‰";
    paywall.classList.add("hidden");
  }else{
    badge.innerHTML = 'ğŸ†“ ç„¡æ–™ä½“é¨“ æ®‹ã‚Š <span id="trialLeft">'+remaining(s)+'</span> å›';
    if(remaining(s) <= 0){
      paywall.classList.remove("hidden");
    }else{
      paywall.classList.add("hidden");
    }
  }
  // payment link
  document.getElementById("payLink").href = STRIPE_PAYMENT_LINK;
  document.getElementById("payLink2").href = STRIPE_PAYMENT_LINK;
}
renderTrial();

document.getElementById("resetBtn").addEventListener("click", () => {
  localStorage.removeItem(KEY_STATE);
  // clear UI inputs/outputs as well
  document.getElementById("userText").value = "";
  document.getElementById("aiJp").textContent = "";
  document.getElementById("aiRomaji").textContent = "";
  document.getElementById("aiId").textContent = "";
  document.getElementById("idJp").textContent = "";
  document.getElementById("fbJp").textContent = "";
  document.getElementById("suggestJp").textContent = "";
  document.getElementById("suggestRomaji").textContent = "";
  document.getElementById("suggestId").textContent = "";
  renderTrial();
  setStatus("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆä½“é¨“å›æ•°ãŒæˆ»ã‚Šã¾ã—ãŸï¼‰");
});

document.getElementById("exampleBtn").addEventListener("click", () => {
  const persona = document.getElementById("persona").value;
  const scene = document.getElementById("scene").value;
  const ex = getExamples(scene, persona);
  if(ex && ex.length){ document.getElementById("userText").value = (ex[0]?.ja || ex[0] || ""); }
}
    // ä¾‹æ–‡ï¼šç›¸æ‰‹/çŠ¶æ³ã®å¤‰æ›´ã«è¿½å¾“ã—ã¦æ›´æ–°
    const personaEl = document.getElementById('persona');
    const sceneEl = document.getElementById('scene');
    const onScenarioChange = () => {
      // å…¥åŠ›ã¯å‰ã®ã‚·ãƒŠãƒªã‚ªã®ã¾ã¾æ®‹ã™ã¨æ··ä¹±ã™ã‚‹ã®ã§ä¸€æ—¦ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ãªã‚‰ã“ã®1è¡Œã‚’å‰Šé™¤ï¼‰
      const userText = document.getElementById('userText');
      if (userText) userText.value = '';
      renderExamples();
    };
    if (personaEl) personaEl.addEventListener('change', onScenarioChange);
    if (sceneEl) sceneEl.addEventListener('change', onScenarioChange);
);

function setStatus(msg){ document.getElementById("status").textContent = msg; }

/** ===========================
 *  ROLEPLAY (correct roles)
 * =========================== */
function personaPrompt(v){
  switch(v){
    case "user_confused": return "You are an elderly care facility resident. You are a bit confused and anxious. Reply in Japanese like a real person.";
    case "family_anxious": return "You are a family member of a resident. You are anxious and ask many questions. Reply in Japanese.";
    case "family_angry": return "You are a family member making a complaint. You are angry but realistic. Reply in Japanese.";
    default: return "You are an elderly care facility resident. You are calm and polite. Reply in Japanese.";
  }
}
function scenePrompt(v){
  switch(v){
    case "toilet": return "Context: toileting assistance. Keep it realistic for a Japanese care facility.";
    case "meal": return "Context: meal assistance / diet / choking concern. Keep it realistic.";
    case "callbell": return "Context: call bell / urgent request. Keep it realistic.";
    case "med": return "Context: medication assistance. Keep it realistic.";
    case "complaint": return "Context: complaint handling at the scene. Keep it realistic and tense.";
    default: return "Context: bathing assistance. Keep it realistic.";
  }
}


function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// ---- ä¾‹æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚·ãƒŠãƒªã‚ªã”ã¨ï¼‰ ----
const EXAMPLE_DATA = {
  "å…¥æµ´ä»‹åŠ©": [
    { ja:"ä»Šã‹ã‚‰ãŠé¢¨å‘‚ã«å…¥ã‚Šã¾ã—ã‚‡ã†ã€‚å¯’ããªã„ã‚ˆã†ã«æ¸©ã‹ãã—ã¾ã™ã­ã€‚", romaji:"Ima kara ofuro ni hairimashou. Samukunai you ni atatakaku shimasu ne.", id:"Sekarang kita mandi ya. Saya akan buat airnya hangat supaya tidak kedinginan." },
    { ja:"ä½“èª¿ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿè‹¦ã—ã„ã¨ã“ã‚ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã€‚", romaji:"Taichou wa ikaga desu ka? Kurushii tokoro wa arimasen ka.", id:"Bagaimana kondisi Anda? Ada bagian yang terasa sakit atau sesak?" },
    { ja:"æ»‘ã‚Šã‚„ã™ã„ã®ã§ã€ã‚†ã£ãã‚Šç«‹ã¡ã¾ã—ã‚‡ã†ã€‚æ”¯ãˆã¾ã™ã­ã€‚", romaji:"Suberiyasui node, yukkuri tachimashou. Sasaemasu ne.", id:"Lantainya licin, jadi berdiri pelan-pelan ya. Saya bantu pegang." }
  ],
  "é£Ÿäº‹ä»‹åŠ©": [
    { ja:"ä¸€å£ãšã¤ã‚†ã£ãã‚Šé£Ÿã¹ã¾ã—ã‚‡ã†ã€‚é£²ã¿è¾¼ã¿ã¯å¤§ä¸ˆå¤«ã§ã™ã‹ã€‚", romaji:"Hitokuchi zutsu yukkuri tabemashou. Nomikomi wa daijoubu desu ka.", id:"Mari makan pelan-pelan, satu suap ya. Menelannya aman?" },
    { ja:"ç†±ããªã„ã§ã™ã‹ï¼Ÿå°‘ã—å†·ã¾ã—ã¦ã‹ã‚‰ã«ã—ã¾ã—ã‚‡ã†ã€‚", romaji:"Atsukunai desu ka? Sukoshi samashite kara ni shimashou.", id:"Tidak terlalu panas? Kita tunggu agak dingin dulu ya." },
    { ja:"ãŠæ°´ã‚’å°‘ã—é£²ã¿ã¾ã™ã‹ï¼Ÿã‚€ã›ãã†ãªã‚‰æ•™ãˆã¦ãã ã•ã„ã€‚", romaji:"Omizu o sukoshi nomimasu ka? Muse-sou nara oshiete kudasai.", id:"Mau minum sedikit air? Kalau mau tersedak, bilang ya." }
  ],
  "ç§»ä¹—ä»‹åŠ©": [
    { ja:"ä»Šã‹ã‚‰ãƒ™ãƒƒãƒ‰ã‹ã‚‰è»Šã„ã™ã¸ç§»ã‚Šã¾ã™ã€‚ã‚†ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã€‚", romaji:"Ima kara beddo kara kuruma-isu e utsurimasu. Yukkuri de daijoubu desu.", id:"Sekarang kita pindah dari tempat tidur ke kursi roda. Pelan-pelan saja." },
    { ja:"ç«‹ã¤å‰ã«ã€è¶³ã¯åºŠã«ã¤ã‘ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ", romaji:"Tatsu mae ni, ashi wa yuka ni tsukeraremasu ka?", id:"Sebelum berdiri, apakah kaki bisa menapak lantai?" },
    { ja:"ç§ã®è‚©ã«ã¤ã‹ã¾ã£ã¦ãã ã•ã„ã€‚ã›ãƒ¼ã®ã§ç«‹ã¡ã¾ã—ã‚‡ã†ã€‚", romaji:"Watashi no kata ni tsukamatte kudasai. Se-no de tachimashou.", id:"Pegang bahu saya ya. Kita berdiri bersama, satu dua tiga." }
  ],
  "æ’æ³„ä»‹åŠ©": [
    { ja:"ãƒˆã‚¤ãƒ¬ã«è¡Œãã¾ã™ã‹ï¼Ÿä»Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¤§ä¸ˆå¤«ã§ã™ã€‚", romaji:"Toire ni ikimasu ka? Ima no taimingu de daijoubu desu.", id:"Mau ke toilet? Sekarang waktunya pas kok." },
    { ja:"æ¥ãšã‹ã—ã„ã¨ã“ã‚ã¯éš ã—ã¾ã™ã­ã€‚å®‰å¿ƒã—ã¦ãã ã•ã„ã€‚", romaji:"Hazukashii tokoro wa kakushimasu ne. Anshin shite kudasai.", id:"Bagian yang memalukan akan saya tutupi. Tenang ya." },
    { ja:"ç—›ã¿ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿç„¡ç†ã—ãªã„ã§æ•™ãˆã¦ãã ã•ã„ã€‚", romaji:"Itami wa arimasen ka? Muri shinaide oshiete kudasai.", id:"Ada rasa sakit? Jangan dipaksakan, beri tahu saya ya." }
  ],
  "æœè–¬ä»‹åŠ©": [
    { ja:"ãŠè–¬ã®æ™‚é–“ã§ã™ã€‚ãŠæ°´ã¨ä¸€ç·’ã«é£²ã¿ã¾ã—ã‚‡ã†ã€‚", romaji:"Okusuri no jikan desu. Omizu to issho ni nomimashou.", id:"Waktunya minum obat. Mari minum dengan air ya." },
    { ja:"é£²ã¿ã«ãã‘ã‚Œã°ã€å§¿å‹¢ã‚’æ•´ãˆã¾ã™ã­ã€‚", romaji:"Nominikukereba, shisei o totonoemasu ne.", id:"Kalau susah menelan, saya bantu atur posisi duduk ya." },
    { ja:"é£²ã‚ã¾ã—ãŸã‹ï¼Ÿå£ã®ä¸­ã«æ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèªã—ã¾ã™ã€‚", romaji:"Nomemashita ka? Kuchi no naka ni nokotte inai ka kakunin shimasu.", id:"Sudah tertelan? Saya cek apakah ada yang masih tersisa di mulut." }
  ],
  "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ": [
    { ja:"ã”ä¸å¿«ãªæ€ã„ã‚’ã•ã›ã¦ã—ã¾ã„ã€ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚", romaji:"Gofukai na omoi o sasete shimai, moushiwake arimasen. Joukyou o kakunin shimasu.", id:"Maaf sudah membuat Anda tidak nyaman. Saya akan cek situasinya." },
    { ja:"å…·ä½“çš„ã«ã€ã„ã¤ãƒ»ã©ã“ã§ãƒ»ä½•ãŒã‚ã£ãŸã‹æ•™ãˆã¦ãã ã•ã„ã€‚", romaji:"Gutaiteki ni, itsu/doko de/nani ga atta ka oshiete kudasai.", id:"Bisa ceritakan kapan, di mana, dan apa yang terjadi?" },
    { ja:"ã™ãã«ä¸Šå¸ã¸å…±æœ‰ã—ã€å¯¾å¿œæ¡ˆã‚’ã”é€£çµ¡ã—ã¾ã™ã€‚", romaji:"Sugu ni joushi e kyouyuu shi, taiou-an o gorennraku shimasu.", id:"Saya akan segera lapor atasan dan menghubungi Anda dengan rencana tindak lanjut." }
  ]
};

function getExamples(scene, persona){
  // personaã¯ä»Šå¾Œã®æ‹¡å¼µç”¨ï¼ˆç¾çŠ¶ã¯sceneã§å‡ºã—åˆ†ã‘ï¼‰
  return EXAMPLE_DATA[scene] || [
    { ja:"ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚", romaji:"Yoroshiku onegaishimasu.", id:"Mohon bantuannya ya." }
  ];
}

function renderExamples() {
      const persona = document.getElementById('persona')?.value || 'user_calm';
      const scene = document.getElementById('scene')?.value || 'bath';
      const list = document.getElementById('examplesList');
      const panel = document.getElementById('examplesPanel');
      if (!list || !panel) return;

      const exs = getExamples(scene, persona) || [];
      if (exs.length === 0) {
        list.innerHTML = '<div style="color:#667; font-size:14px;">ã“ã®çµ„ã¿åˆã‚ã›ã®ä¾‹æ–‡ã¯æº–å‚™ä¸­ã§ã™ã€‚</div>';
        panel.style.display = 'block';
        return;
      }

      // ä¾‹æ–‡ã‚’3è¨€èªã§è¡¨ç¤ºï¼ˆæ—¥æœ¬èª / ãƒ­ãƒ¼ãƒå­— / ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼‰
      list.innerHTML = exs.map((ex, idx) => {
        const ja = (ex.ja || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const ro = (ex.romaji || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const id = (ex.id || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <div class="exampleCard" data-idx="${idx}">
            <div class="exTitle">ä¾‹æ–‡ ${idx+1}</div>
            <div class="exLine"><b>æ—¥æœ¬èª</b><br>${ja}</div>
            <div class="exLine"><b>ãƒ­ãƒ¼ãƒå­—</b><br>${ro}</div>
            <div class="exLine"><b>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</b><br>${id}</div>
            <div class="exActions">
              <button class="btnSmall" type="button" onclick="applyExample(${idx})">ã“ã®ä¾‹æ–‡ã‚’å…¥åŠ›</button>
            </div>
          </div>
        `;
      }).join('');

      panel.style.display = 'block';
    }

    function applyExample(idx){
      const persona = document.getElementById('persona')?.value || 'user_calm';
      const scene = document.getElementById('scene')?.value || 'bath';
      const exs = getExamples(scene, persona) || [];
      const ex = exs[idx] || exs[0];
      const userText = document.getElementById('userText');
      if (userText && ex && ex.ja) userText.value = ex.ja;
    }


function sceneArt(scene){
  const common = (inner) => `<svg viewBox="0 0 640 180" xmlns="http://www.w3.org/2000/svg">${inner}</svg>`;
  switch(scene){
    case "bath":
      return common(`
        <rect x="30" y="70" rx="26" ry="26" width="580" height="80" fill="rgba(255,255,255,.10)"/>
        <path d="M140 100c20-30 60-30 80 0" fill="none" stroke="rgba(255,255,255,.65)" stroke-width="10" stroke-linecap="round"/>
        <circle cx="140" cy="70" r="22" fill="rgba(255,255,255,.65)"/>
        <circle cx="460" cy="78" r="16" fill="rgba(255,255,255,.45)"/>
        <circle cx="500" cy="92" r="12" fill="rgba(255,255,255,.35)"/>
        <circle cx="535" cy="78" r="10" fill="rgba(255,255,255,.30)"/>
      `);
    case "meal":
      return common(`
        <rect x="70" y="60" rx="22" ry="22" width="500" height="100" fill="rgba(255,255,255,.10)"/>
        <circle cx="200" cy="110" r="38" fill="rgba(255,255,255,.18)"/>
        <rect x="330" y="82" rx="10" ry="10" width="180" height="18" fill="rgba(255,255,255,.45)"/>
        <rect x="330" y="112" rx="10" ry="10" width="220" height="18" fill="rgba(255,255,255,.30)"/>
      `);
    case "toilet":
      return common(`
        <rect x="90" y="55" rx="20" ry="20" width="260" height="110" fill="rgba(255,255,255,.10)"/>
        <rect x="360" y="55" rx="20" ry="20" width="190" height="60" fill="rgba(255,255,255,.10)"/>
        <rect x="390" y="80" rx="14" ry="14" width="130" height="70" fill="rgba(255,255,255,.12)"/>
      `);
    case "med":
      return common(`
        <rect x="120" y="65" rx="26" ry="26" width="400" height="90" fill="rgba(255,255,255,.10)"/>
        <rect x="210" y="90" rx="16" ry="16" width="110" height="32" fill="rgba(255,255,255,.45)"/>
        <rect x="330" y="90" rx="16" ry="16" width="110" height="32" fill="rgba(255,255,255,.25)"/>
      `);
    default:
      return common(`<rect x="50" y="60" rx="24" ry="24" width="540" height="100" fill="rgba(255,255,255,.10)"/>`);
  }
}

function updateUI(){
  const persona = document.getElementById("persona").value;
  const scene = document.getElementById("scene").value;

  const svgBox = document.getElementById("sceneArtSvg");
  const sub = document.getElementById("sceneArtSub");
  if(svgBox) svgBox.innerHTML = sceneArt(scene);
  if(sub){
    const pLabel = document.getElementById("persona").selectedOptions[0].textContent;
    const sLabel = document.getElementById("scene").selectedOptions[0].textContent;
    sub.textContent = `ç›¸æ‰‹ï¼š${pLabel} ï¼ çŠ¶æ³ï¼š${sLabel}`;
  }

  const list = document.getElementById("exampleList");
  if(list){
    // æ—§UIï¼ˆãƒœã‚¿ãƒ³å‹ã®ä¾‹æ–‡ï¼‰ã‚’ä½¿ã†å ´åˆã¯ã“ã“ã‚’æ‹¡å¼µã§ãã¾ã™ãŒã€
    // ç¾åœ¨ã¯ã€Œä¾‹æ–‡ï¼ˆ3è¨€èªï¼‰ã€ãƒ‘ãƒãƒ«ã«çµ±ä¸€ã—ã¾ã™ã€‚
    list.innerHTML = "";
  }
  try { renderExamples(); } catch(e) {}


  document.getElementById("userText").placeholder =
    `ï¼ˆä»‹è­·è·ã¨ã—ã¦ï¼‰${document.getElementById("scene").selectedOptions[0].textContent}ã®å ´é¢ã§ã€æ—¥æœ¬èªã§å£°ã‹ã‘ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚`;
}

// Very simple kana->romaji (Hepburn-ish). Not perfect but works for rubi.
// If you want perfect romaji, have the model output romaji too (we do that).
function safeText(x){ return (x==null) ? "" : String(x); }

async function callApi(payload){
  const res = await fetch("/api/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    throw new Error(data?.error || ("HTTP " + res.status));
  }
  return data;
}

function fillResult(obj){
  document.getElementById("aiJp").textContent = safeText(obj.ai_reply_jp || obj.text || obj.content || "â€”");
  document.getElementById("aiRomaji").textContent = safeText(obj.ai_reply_romaji || "â€”");
  document.getElementById("aiId").textContent = safeText(obj.ai_reply_id || "â€”");
  document.getElementById("fbJp").textContent = safeText(obj.feedback_jp || "â€”");
  document.getElementById("suggestJp").textContent = safeText(obj.suggested_reply_jp || "â€”");
  document.getElementById("suggestRomaji").textContent = safeText(obj.suggested_reply_romaji || "â€”");
  document.getElementById("suggestId").textContent = safeText(obj.suggested_reply_id || "â€”");
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const s = loadState();
  if(!s.pro && remaining(s) <= 0){
    renderTrial();
    setStatus("ç„¡æ–™ä½“é¨“ãŒçµ‚äº†ã—ã¦ã„ã¾ã™ã€‚æœ¬ç¨¼åƒã¸åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚");
    return;
  }

  const userText = document.getElementById("userText").value.trim();
  if(!userText){ setStatus("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  setStatus("é€ä¿¡ä¸­â€¦");
  try{
    const persona = document.getElementById("persona").value;
    const scene = document.getElementById("scene").value;

    const payload = {
      prompt: userText,
      meta: {
        persona,
        scene
      }
    };

    const data = await callApi(payload);

    // Server returns {text} and maybe {json}
    let obj = null;
    if(typeof data.json === "object" && data.json) obj = data.json;
    else if(typeof data.text === "string"){
      try{ obj = JSON.parse(data.text); }catch(e){ obj = { text: data.text }; }
    }else if(typeof data.content === "string"){
      obj = { text: data.content };
    }else{
      obj = data;
    }

    fillResult(obj);

    // consume trial on success only
    const ns = loadState();
    if(!ns.pro){
      ns.used = (ns.used||0) + 1;
      saveState(ns);
    }
    renderTrial();
    setStatus("å®Œäº†");
  }catch(e){
    console.error(e);
    setStatus("ã‚¨ãƒ©ãƒ¼: " + (e.message || e));
  }
});
</script>
</body>
</html>
