<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kaigo Senseiï½œRoleplayï¼ˆä½“é¨“ï¼‰</title>
  <style>
    :root{--indigo:#4f46e5;--bg:#f5f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);}
    header{background:#111827;color:#fff;padding:14px 16px;position:sticky;top:0;z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#1f2937;color:#e5e7eb;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .badgeFree{background:#eef2ff;color:#1e1b4b;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:900;font-size:14px;border:1px solid rgba(0,0,0,.10);background:#fff;color:#111827;cursor:pointer}
    .btn.primary{background:var(--indigo);color:#fff;border-color:transparent}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.05)}
    label{font-weight:800;font-size:12px}
    select,textarea,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;box-sizing:border-box;background:#fff}
    textarea{min-height:120px;resize:vertical}
    .muted{color:var(--muted);font-size:12px}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .kbox{background:#f9fafb;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kbox h3{margin:0 0 8px;font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;white-space:pre-wrap}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:10px">
      <div style="font-weight:1000;letter-spacing:.2px">Kaigo Sensei</div>
      <div class="pill">ã‚ãªãŸï¼šä»‹è­·è· / AIï¼šåˆ©ç”¨è€…ãƒ»å®¶æ—</div>
    </div>
    <div class="row" style="gap:10px">
      <div class="badgeFree" id="trialBadge">ğŸ†“ ç„¡æ–™ä½“é¨“ æ®‹ã‚Š <span id="trialLeft">3</span> å›</div>
      <button class="btn" id="resetBtn" title="ä½“é¨“ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰">ãƒªã‚»ãƒƒãƒˆ</button>
      <a class="btn" href="/">LPã¸</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">ã‚·ãƒŠãƒªã‚ªè¨­å®š</h2>

      <div class="split">
        <div style="flex:1;min-width:240px">
          <label>ç›¸æ‰‹ï¼ˆAIå´ï¼‰</label>
          <select id="persona">
            <option value="user_calm">åˆ©ç”¨è€…ï¼šç©ã‚„ã‹ï¼ˆåŸºæœ¬ï¼‰</option>
            <option value="user_confused">åˆ©ç”¨è€…ï¼šå°‘ã—æ··ä¹±ï¼ˆèªçŸ¥ç—‡ã®å…¥å£ï¼‰</option>
            <option value="family_anxious">å®¶æ—ï¼šä¸å®‰ãƒ»è³ªå•ãŒå¤šã„</option>
            <option value="family_angry">å®¶æ—ï¼šæ€’ã‚Šãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ </option>
          </select>
          <div class="muted" style="margin-top:6px;">â€»ã‚ãªãŸãŒæ—¥æœ¬èªã§å¯¾å¿œï¼ˆä»‹è­·è·ã¨ã—ã¦è¿”ç­”ï¼‰ã—ã¾ã™ã€‚</div>
        </div>
        <div style="flex:1;min-width:240px">
          <label>çŠ¶æ³</label>
          <select id="scene">
            <option value="bath">å…¥æµ´ä»‹åŠ©</option>
            <option value="toilet">æ’æ³„ä»‹åŠ©</option>
            <option value="meal">é£Ÿäº‹ä»‹åŠ©</option>
            <option value="callbell">ãƒŠãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«ï¼ˆå‘¼ã³å‡ºã—ï¼‰</option>
            <option value="med">æœè–¬</option>
            <option value="complaint">ã‚¯ãƒ¬ãƒ¼ãƒ åˆå‹•</option>
          </select>
          <div class="muted" style="margin-top:6px;">ä¼šè©±ã®ç›®çš„ï¼šèª¤è§£ã‚’æ¸›ã‚‰ã—ã€çŸ­ãä¸å¯§ã«ã€‚</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>ã‚ãªãŸï¼ˆä»‹è­·è·ï¼‰ã®ç™ºè¨€ï¼ˆæ—¥æœ¬èªï¼‰</label>
        <textarea id="userText" placeholder="ä¾‹ï¼šã™ã¿ã¾ã›ã‚“ã€‚ä»Šã‹ã‚‰ãŠé¢¨å‘‚ã«å…¥ã‚Šã¾ã—ã‚‡ã†ã€‚å¯’ããªã„ã‚ˆã†ã«æ¸©ã‹ãã—ã¾ã™ã­ã€‚"></textarea>
        <div class="split" style="margin-top:10px">
          <button class="btn primary" id="sendBtn">é€ä¿¡ï¼ˆRoleplayï¼‰</button>
          <button class="btn" id="exampleBtn">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
        </div>
        <div class="muted" style="margin-top:8px;">â€»ç„¡æ–™ä½“é¨“ã¯3å›ã¾ã§ã€‚å›æ•°ã‚’è¶…ãˆã‚‹ã¨æœ¬ç¨¼åƒæ¡ˆå†…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="card" style="margin-top:14px;background:#0b1220;color:#e5e7eb;border:none">
        <h3 style="margin:0 0 10px;font-size:14px;">æœ¬ç¨¼åƒï¼ˆProï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹</h3>
        <div class="muted" style="color:#cbd5e1">æ–½è¨­å°å…¥ãƒ»æœ¬ç¨¼åƒã®ç›¸è«‡ã¯ã“ã¡ã‚‰ã€‚æ±ºæ¸ˆãƒªãƒ³ã‚¯ã¯å¾Œã§å·®ã—æ›¿ãˆå¯ã€‚</div>
        <div class="split" style="margin-top:10px">
          <a class="btn primary" style="background:#22c55e" href="#" id="payLink">ğŸ’³ æœ¬ç¨¼åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆæ±ºæ¸ˆï¼‰</a>
          <a class="btn" style="border-color:rgba(255,255,255,.18);background:transparent;color:#e5e7eb" href="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ1DZzbc2Em4gn-ABTKavXY1dpFHRpO0ynpn8iSeOx_9vRUdr2MDLcRSv_tZHY4aMVy6ceqQGO2L?gv=true" target="_blank" rel="noreferrer">ğŸ“… ç„¡æ–™ç›¸è«‡</a>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">çµæœ</h2>

      <div id="paywall" class="kbox hidden">
        <h3>ç„¡æ–™ä½“é¨“ã¯çµ‚äº†ã—ã¾ã—ãŸ</h3>
        <div class="muted">ç¶šãã¯æœ¬ç¨¼åƒï¼ˆProï¼‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚</div>
        <div class="split" style="margin-top:10px">
          <a class="btn primary" href="#" id="payLink2">æœ¬ç¨¼åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹</a>
          <a class="btn" href="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ1DZzbc2Em4gn-ABTKavXY1dpFHRpO0ynpn8iSeOx_9vRUdr2MDLcRSv_tZHY4aMVy6ceqQGO2L?gv=true" target="_blank" rel="noreferrer">ç„¡æ–™ç›¸è«‡</a>
        </div>
      </div>

      <div class="kbox" id="aiBox">
        <h3>AIï¼ˆç›¸æ‰‹ï¼‰ã®è¿”ç­”ï¼šæ—¥æœ¬èª</h3>
        <div class="mono" id="aiJp">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>èª­ã¿ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</h3>
        <div class="mono" id="aiRomaji">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª</h3>
        <div class="mono" id="aiId">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚ãªãŸï¼ä»‹è­·è·ã®è¡¨ç¾ï¼‰</h3>
        <div class="mono" id="fbJp">â€”</div>
      </div>

      <div class="kbox" style="margin-top:10px">
        <h3>ãŠã™ã™ã‚ã®è¨€ã„æ›ãˆï¼ˆä»‹è­·è·ã¨ã—ã¦ï¼‰</h3>
        <div class="mono" id="suggestJp">â€”</div>
        <div class="muted" style="margin-top:8px;">èª­ã¿ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ï¼š</div>
        <div class="mono" id="suggestRomaji">â€”</div>
        <div class="muted" style="margin-top:8px;">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èªï¼š</div>
        <div class="mono" id="suggestId">â€”</div>
      </div>

      <div class="muted" style="margin-top:12px" id="status">æº–å‚™OK</div>
    </section>
  </div>
</main>

<script>
/** ===========================
 *  TRIAL / PRO STATE (B + C)
 * =========================== */
const TRIAL_LIMIT = 3;
const KEY_STATE = "ks_state_v3"; // æ—§ç‰ˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ã
const STRIPE_PAYMENT_LINK = "#"; // â†å¾Œã§å·®ã—æ›¿ãˆï¼ˆStripe Payment Linkï¼‰

function loadState(){
  try{
    const raw = localStorage.getItem(KEY_STATE);
    if(!raw) return { used:0, pro:false };
    const s = JSON.parse(raw);
    return { used: Number(s.used||0), pro: !!s.pro };
  }catch(e){ return { used:0, pro:false }; }
}
function saveState(s){ localStorage.setItem(KEY_STATE, JSON.stringify(s)); }
function remaining(s){ return Math.max(0, TRIAL_LIMIT - (s.used||0)); }

function renderTrial(){
  const s = loadState();
  document.getElementById("trialLeft").textContent = remaining(s);
  const badge = document.getElementById("trialBadge");
  const paywall = document.getElementById("paywall");
  if(s.pro){
    badge.textContent = "ğŸ’¼ æœ¬ç¨¼åƒï¼ˆProï¼‰";
    paywall.classList.add("hidden");
  }else{
    badge.innerHTML = 'ğŸ†“ ç„¡æ–™ä½“é¨“ æ®‹ã‚Š <span id="trialLeft">'+remaining(s)+'</span> å›';
    if(remaining(s) <= 0){
      paywall.classList.remove("hidden");
    }else{
      paywall.classList.add("hidden");
    }
  }
  // payment link
  document.getElementById("payLink").href = STRIPE_PAYMENT_LINK;
  document.getElementById("payLink2").href = STRIPE_PAYMENT_LINK;
}
renderTrial();

document.getElementById("resetBtn").addEventListener("click", () => {
  localStorage.removeItem(KEY_STATE);
  renderTrial();
  setStatus("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆä½“é¨“å›æ•°ãŒæˆ»ã‚Šã¾ã—ãŸï¼‰");
});

document.getElementById("exampleBtn").addEventListener("click", () => {
  document.getElementById("userText").value =
    "ã™ã¿ã¾ã›ã‚“ã€‚ä»Šã‹ã‚‰ãŠé¢¨å‘‚ã«å…¥ã‚Šã¾ã—ã‚‡ã†ã€‚å¯’ããªã„ã‚ˆã†ã«æ¸©ã‹ãã—ã¾ã™ã­ã€‚";
});

function setStatus(msg){ document.getElementById("status").textContent = msg; }

/** ===========================
 *  ROLEPLAY (correct roles)
 * =========================== */
function personaPrompt(v){
  switch(v){
    case "user_confused": return "You are an elderly care facility resident. You are a bit confused and anxious. Reply in Japanese like a real person.";
    case "family_anxious": return "You are a family member of a resident. You are anxious and ask many questions. Reply in Japanese.";
    case "family_angry": return "You are a family member making a complaint. You are angry but realistic. Reply in Japanese.";
    default: return "You are an elderly care facility resident. You are calm and polite. Reply in Japanese.";
  }
}
function scenePrompt(v){
  switch(v){
    case "toilet": return "Context: toileting assistance. Keep it realistic for a Japanese care facility.";
    case "meal": return "Context: meal assistance / diet / choking concern. Keep it realistic.";
    case "callbell": return "Context: call bell / urgent request. Keep it realistic.";
    case "med": return "Context: medication assistance. Keep it realistic.";
    case "complaint": return "Context: complaint handling at the scene. Keep it realistic and tense.";
    default: return "Context: bathing assistance. Keep it realistic.";
  }
}

// Very simple kana->romaji (Hepburn-ish). Not perfect but works for rubi.
// If you want perfect romaji, have the model output romaji too (we do that).
function safeText(x){ return (x==null) ? "" : String(x); }

async function callApi(payload){
  const res = await fetch("/api/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    throw new Error(data?.error || ("HTTP " + res.status));
  }
  return data;
}

function fillResult(obj){
  document.getElementById("aiJp").textContent = safeText(obj.ai_reply_jp || obj.text || obj.content || "â€”");
  document.getElementById("aiRomaji").textContent = safeText(obj.ai_reply_romaji || "â€”");
  document.getElementById("aiId").textContent = safeText(obj.ai_reply_id || "â€”");
  document.getElementById("fbJp").textContent = safeText(obj.feedback_jp || "â€”");
  document.getElementById("suggestJp").textContent = safeText(obj.suggested_reply_jp || "â€”");
  document.getElementById("suggestRomaji").textContent = safeText(obj.suggested_reply_romaji || "â€”");
  document.getElementById("suggestId").textContent = safeText(obj.suggested_reply_id || "â€”");
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const s = loadState();
  if(!s.pro && remaining(s) <= 0){
    renderTrial();
    setStatus("ç„¡æ–™ä½“é¨“ãŒçµ‚äº†ã—ã¦ã„ã¾ã™ã€‚æœ¬ç¨¼åƒã¸åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚");
    return;
  }

  const userText = document.getElementById("userText").value.trim();
  if(!userText){ setStatus("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  setStatus("é€ä¿¡ä¸­â€¦");
  try{
    const persona = document.getElementById("persona").value;
    const scene = document.getElementById("scene").value;

    const payload = {
      prompt: userText,
      meta: {
        persona,
        scene
      }
    };

    const data = await callApi(payload);

    // Server returns {text} and maybe {json}
    let obj = null;
    if(typeof data.json === "object" && data.json) obj = data.json;
    else if(typeof data.text === "string"){
      try{ obj = JSON.parse(data.text); }catch(e){ obj = { text: data.text }; }
    }else if(typeof data.content === "string"){
      obj = { text: data.content };
    }else{
      obj = data;
    }

    fillResult(obj);

    // consume trial on success only
    const ns = loadState();
    if(!ns.pro){
      ns.used = (ns.used||0) + 1;
      saveState(ns);
    }
    renderTrial();
    setStatus("å®Œäº†");
  }catch(e){
    console.error(e);
    setStatus("ã‚¨ãƒ©ãƒ¼: " + (e.message || e));
  }
});
</script>
</body>
</html>
